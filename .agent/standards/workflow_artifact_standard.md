# ワークフロー Artifact 標準規則

> **目的**: 全ワークフローの実行結果をファイルに自動保存し、チャットコンテキストを節約する
> **設計思想**: 「思考の痕跡」を永続化し、セッション間で参照可能にする

---

## Output Integrity Protocol (v1.1)

> **Origin**: 2026-01-29 — 「出力省略しすぎ」問題の対策
> **目的**: ワークフロー実行時の出力形式遵守を保証

### 原則

```
「+ 演算子 = 省略禁止」
「- 演算子 = 省略許可」
「標準（演算子なし）= 中程度」
```

### 演算子別の出力量

| 演算子 | 出力量 | 省略 |
|:-------|:-------|:-----|
| `+` (Deepening) | **最大** | ❌ 禁止 |
| (なし) | 中程度 | ⚠️ 要所のみ可 |
| `-` (Reduction) | 最小限 | ✅ 許可 |

### 遵守事項

1. **PHASE 出力形式**: 各 PHASE で定義された出力形式を必ず表示
2. **CCL 複合コマンド**: 各演算子の結果を中間出力として表示
3. **Anti-Skip Protocol**: SKILL.md の出力形式セクションを遵守

### 違反例

```
❌ /zet+ で PHASE 1-4 を省略
❌ @dig で振動の各ステップを省略
❌ /noe+ で結論のみ出力
```

### 正しい例

```
✅ /zet+ で全 PHASE を詳細展開
✅ @dig = /s+~(/p*/a)_/dia*/o+ の各演算子を表示
✅ /noe- で TL;DR 形式のみ (- 演算子なので省略OK)
```

---

## チャット出力規則

**ワークフロー完了時のチャット出力は最小限とする**:

```text
✅ {Workflow} 完了
📄 {file_path}
要約: {1行要約}
→ {次ステップ推奨}
```

**詳細は全てファイルに記録する。チャットには出力しない。**

> ⚠️ **注意**: この規則は **ワークフロー完了後** の話。
> **ワークフロー実行中** は Output Integrity Protocol に従い、出力形式を遵守する。

---

## CCL Header (v1.1 — NEW)

> **関連規則**: [ccl-manifest.md](file:///home/makaron8426/oikos/.agent/rules/ccl-manifest.md)

### 必須: アーティファクト冒頭

すべてのワークフローアーティファクトは、冒頭に CCL 式を記載:

```markdown
# [タイトル]

> **CCL**: `{ccl_expression}`
> **目的**: {purpose}
```

### 必須: ワークフロー実行時

CCL式を使用した場合、以下を表示:

```text
┌─[CCL]─────────────────────────────────────────────┐
│ 式: {ccl_expression}                              │
│ 展開: {expanded_form} (複雑な場合のみ)            │
│ 目的: {purpose}                                   │
└───────────────────────────────────────────────────┘
```

---

## SE原則 構造的強制 (v1.1)

> **Origin**: 2026-01-31 — セルフチェックは信用できない。構造で担保する。
> **設計思想**: 必須フィールドがなければ「不完全」としてブロック
> **v1.1**: WM セクションを全 Artifact WF の必須フィールドに追加 (2026-02-11)

### 強制レベル（スケール別・自動判定）

| Scale | Level | 動作 |
|:------|:------|:-----|
| 🔬 Micro | L2-min | 必須項目の存在チェックのみ |
| 🔭 Meso | L2-std | 必須項目 + 内容の妥当性警告 |
| 🌍 Macro | L3 | 全項目必須 + 違反でブロック |

**オーバーライドフラグ**:

- `--strict`: 強制的に L3
- `--relax`: 強制的に L2-min

### 全 Artifact WF 共通必須フィールド

| フィールド | SE原則 | 必須条件 |
|:-----------|:-------|:---------|
| **`## 🧠 WM`** | **外在化** | **全 Scale — 例外なし** |

> **第零原則**: 「チェックリストは守れない。構造で強制する。」
> WM なき出力は Output Integrity Protocol 違反。SE原則ブロック発動。

### /mek 必須フィールド

| フィールド | SE原則 | 必須条件 |
|:-----------|:-------|:---------|
| `## 失敗シナリオ` | 早期失敗 | Meso 以上 |
| `→ 初版` マーカー | 反復 | 全 Scale |
| `⏱️ 所要時間: Xm` | タイムボックス | Meso 以上 |

**出力テンプレート (必須部分)**:

```text
## 失敗シナリオ
- Q1: 失敗するとしたら？ → {answer}
- Q2: 最悪のケース？ → {answer}
- Q3: 回避策？ → {answer}

---

→ 初版です。`/dia-` でレビュー推奨。
⏱️ 所要時間: {N}m
```

### /s 必須フィールド

| フィールド | SE原則 | 必須条件 |
|:-----------|:-------|:---------|
| STAGE 0-5 出力 | 可視化 | 全 Scale |
| `Keep:` | 継続改善 | 全 Scale |
| `Problem:` | 継続改善 | 全 Scale |
| `Try:` | 継続改善 | 全 Scale |
| `⏱️ 合計: Xm/45m` | タイムボックス | Meso 以上 |

**出力テンプレート (STAGE 5 必須部分)**:

```text
## STAGE 5: 振り返り
Keep: {1つ以上}
Problem: {1つ以上}
Try: {1つ以上}
⏱️ 合計: {N}m/45m
```

### ブロック機構

**違反検出時の動作**:

```text
┌─[SE原則違反: ブロック]──────────────────────────────────────────┐
│ ❌ 必須フィールド未検出                                         │
│   欠落: {field_name}                                            │
│   原則: {se_principle}                                          │
│                                                                  │
│ このまま続行しますか？                                           │
│   --relax を指定 → 続行可能（違反は記録）                        │
│   指定なし → ブロック（フィールド追記後に再実行）                 │
└──────────────────────────────────────────────────────────────────┘
```

---

## 除外ワークフロー

以下は Artifact を生成しない (ルーティング/参照専用):

| Workflow | 理由 |
|:---------|:-----|
| `/o`, `/h`, `/s`, `/p`, `/k`, `/a`, `/x` | Hub ワークフロー、ルーティングのみ |
| `/boot` | セッション開始 (Handoff 読込のみ) |
| `/bye` | セッション終了 (Handoff 生成で対応) |
| `/u` | 対話専用 |
| `/dev` | 参照専用 |

---

## 対象ワークフロー一覧 (30件)

### O-series (4件)

`/noe`, `/bou`, `/zet`, `/ene`

### S-series (5件)

`/s`, `/met`, `/mek`, `/sta`, `/pra`

### H-series (4件)

`/pro`, `/pis`, `/ore`, `/dox`

### P-series (4件)

`/kho`, `/hod`, `/tro`, `/tek`

### K-series (4件)

`/euk`, `/chr`, `/tel`, `/sop`

### A-series (5件)

`/dia`, `/pat`, `/gno`, `/epi`, `/a`

### X-series (2件)

`/ax`, `/x` (分析モード時のみ)

### その他 (2件)

`/eat`, `/k` (マトリクス出力時)

---

## 各ワークフローへの追加セクション

```markdown
## Artifact 自動保存

> **標準参照**: [workflow_artifact_standard.md](file:///home/makaron8426/oikos/.agent/standards/workflow_artifact_standard.md)

**保存先**: `/home/makaron8426/oikos/mneme/.hegemonikon/workflows/{workflow}_{topic}_{date}.md`

**チャット出力**: 最小限（ファイルパスと要約のみ）
```

---

## 🧠 WM セクション（必須）v1.1 — 環境強制

> **Origin**: 2026-02-05 — 「思考を書き出す」ことで LLM の認知を外在化
> **v1.1**: 2026-02-11 — SE原則ブロック機構と統合。ルールから構造へ昇格。
> **関連**: GEMINI.md「WM 出力必須ルール」, SE原則 構造的強制

### なぜ環境強制か

> **2026-02-11 発見**: WM は GEMINI.md のルールとして「必須」と記述されていたが、
> 各 WF/Skill の出力テンプレートに**一切含まれておらず**、結果として機能していなかった。
> ルール（意志依存）→ テンプレート + SE原則ブロック（環境依存）に移行。

### WM セクションテンプレート

**全 WF の出力に以下を含めること（SE原則により省略不可）**:

```markdown
## 🧠 WM (Working Memory)

$goal = {この WF 実行の目的}
$constraints = {制約・前提条件}
$decision = {主要な判断とその根拠}
$next = {次のアクション}
```

### 適用範囲

| 対象 | 動作 | 強制メカニズム |
|:-----|:-----|:---------------|
| **Artifact 生成 WF** (30件) | テンプレートに WM 含める | SE原則ブロック |
| **Non-Artifact WF** (Hub, /u) | チャット出力の冒頭に WM | GEMINI.md ルール |
| **タスク開始時** | `$goal`, `$constraints` 宣言 | GEMINI.md ルール |
| **判断時** | `$decision = ...` 宣言 | GEMINI.md ルール |

> **SE原則ブロック**: Artifact 生成時に `## 🧠 WM` セクションが存在しなければ、
> SE原則ブロック機構が発動し、出力を不完全として警告する。

---

## リストナンバリング規則 (Disambiguated Numbering)

> **Origin**: 2026-01-29 セッション — 同一画面内の複数リストで「2」が重複し混乱
> **目的**: 複数のリストが同時に表示される場合の識別子衝突を防止

### ナンバリング体系

| 用途 | 記号 | 例 |
|:-----|:-----|:---|
| **選択肢・リスト** | 数字 | 1, 2, 3 |
| **問いかけ・質問** | 英字 | a, b, c |
| **サブカテゴリ** | ローマ数字 | i, ii, iii |

### 適用例

```text
私の望み:
  1. Dispatch Log 50件達成
  2. CCL 日常運用定着
  3. Creator の望み引き出し

Creator への問い:
  a. 共鳴するものはありますか？
  b. 全く別の方向に行きたいですか？
  c. 次に何をしたいですか？
```

**これにより**:

- Creator が「2」と答えれば → CCL 日常運用定着
- Creator が「b」と答えれば → 全く別の方向

---

## 実装ステータス

| Series | Workflows | Status |
|:-------|:----------|:-------|
| O-series | `/noe`, `/bou`, `/zet`, `/ene` | ⏳ |
| S-series | `/s`, `/met`, `/mek`, `/sta`, `/pra` | ⏳ |
| H-series | `/pro`, `/pis`, `/ore`, `/dox` | ⏳ |
| P-series | `/kho`, `/hod`, `/tro`, `/tek` | ⏳ |
| K-series | `/euk`, `/chr`, `/tel`, `/sop` | ⏳ |
| A-series | `/dia`, `/pat`, `/gno`, `/epi`, `/a` | ⏳ |
| X-series | `/ax` | ⏳ |
| Other | `/eat`, `/k` | ⏳ |

---

*v1.0 — 2026-01-29*
