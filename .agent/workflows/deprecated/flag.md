---
description: O4 Energeia 派生。Feature Flags で段階的リリースとリスク制御。
hegemonikon: Ousia
modules: [O4]
parent: "/ene"
skill_ref: ".agent/skills/ousia/o4-energeia/SKILL.md"
triggers:
  - "Feature Flag"
  - "段階的リリース"
  - "トグル"
  - "ロールアウト"
  - "フラグ"
  - "flag"
version: "1.0"
lineage: "O4 Energeia 派生 + SE Feature Flags 手法統合 → v1.0 (2026-01-29)"
anti_skip: enabled
---

# /flag: Feature Flags ワークフロー

> **親定理**: [O4 Energeia /ene](file:///home/makaron8426/oikos/.agent/workflows/ene.md)
> **目的**: 段階的リリースでリスクを制御しながら実行する
> **SE手法**: Feature Flags / Feature Toggles

---

## 本質

**Feature Flags** = デプロイとリリースを分離する

```text
コード完成 → デプロイ (Flag OFF) → 段階的有効化 → 全面リリース
                  ↓
            リスクなしでデプロイ
            問題あれば即時 OFF
```

> **重要**: フラグは技術的負債。計画的に削除すること。

---

## 発動条件

| トリガー | 説明 |
|:---------|:-----|
| `/flag` | 新機能のフラグ設計を開始 |
| `/flag [機能名]` | 特定の機能にフラグを設計 |
| `/flag cleanup` | 既存フラグの棚卸しと削除計画 |

---

## PHASE 0: フラグ設計（スキップ禁止）

> **このステップは省略禁止。フラグ設計なしの実装は負債を生む。**

### 0.1 フラグ対象の明確化

```text
⚠️ 以下を明確にしてから PHASE 1 に進むこと:

> **何をフラグ化しますか？**
> → [機能/振る舞いを1文で]
>
> **なぜフラグ化しますか？**
> → [リスク低減 / A/Bテスト / 段階リリース / 緊急スイッチ]
>
> **フラグがOFFの時、何が起きますか？**
> → [フォールバック動作を具体的に]
```

### 0.2 フラグの種類

| 種類 | 用途 | 寿命 |
|:-----|:-----|:-----|
| **Release** | 未完成機能を隠す | 短期 (数日〜数週間) |
| **Experiment** | A/Bテスト、仮説検証 | 短期 (テスト期間のみ) |
| **Ops** | 運用切り替え (キャッシュ ON/OFF) | 長期 |
| **Permission** | ユーザー権限制御 | 永続 |

### 0.3 フラグ設計テーブル

```text
┌─[PHASE 0: フラグ設計]─────────────────────────────┐
│                                                   │
│ フラグ名: FLAG_[FEATURE_NAME]                     │
│                                                   │
│ 対象機能: [何をフラグ化するか]                     │
│ 種類: [Release / Experiment / Ops / Permission]   │
│ 寿命: [短期 / 長期 / 永続]                        │
│ 削除予定日: [YYYY-MM-DD]                          │
│                                                   │
│ ON 時の動作: [新機能が有効]                       │
│ OFF 時の動作: [既存動作を維持]                    │
│ デフォルト: [ON / OFF]                            │
│                                                   │
└───────────────────────────────────────────────────┘
```

---

## PHASE 1: 実装パターン

### 1.1 条件分岐の挿入

```text
┌─[PHASE 1: 実装パターン]───────────────────────────┐
│                                                   │
│ 挿入点: [コードのどこにフラグチェックを入れるか]   │
│                                                   │
│ パターン:                                         │
│   □ シンプル分岐 (if/else)                       │
│   □ ストラテジーパターン (OCP準拠)               │
│   □ ファクトリーパターン (依存性注入)            │
│                                                   │
│ コード例:                                         │
│   if (featureFlags.isEnabled("FLAG_NAME")) {     │
│     // 新機能                                    │
│   } else {                                        │
│     // 既存動作                                  │
│   }                                               │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 1.2 ベストプラクティス

| 原則 | 説明 |
|:-----|:-----|
| **Single Point** | フラグチェックは1箇所に集約 |
| **Default Safe** | デフォルトはOFF（安全側） |
| **Testable** | フラグのON/OFF両方をテスト可能に |
| **Observable** | フラグ状態をログ/メトリクスに出力 |

---

## PHASE 2: ロールアウト計画

### 2.1 段階的有効化

```text
┌─[PHASE 2: ロールアウト計画]───────────────────────┐
│                                                   │
│ Stage 1: 0% → 1% (カナリア)                      │
│   対象: 内部テスター                             │
│   期間: 1日                                      │
│   監視: エラー率、レイテンシ                     │
│   Next条件: エラー率 < 0.1%                      │
│                                                   │
│ Stage 2: 1% → 10%                                │
│   対象: 早期アダプター                           │
│   期間: 3日                                      │
│   監視: エラー率、ユーザーフィードバック         │
│   Next条件: 重大バグなし                         │
│                                                   │
│ Stage 3: 10% → 50%                               │
│   対象: 一般ユーザー半数                         │
│   期間: 1週間                                    │
│   監視: 全メトリクス                             │
│   Next条件: KPI改善 or 維持                      │
│                                                   │
│ Stage 4: 50% → 100%                              │
│   対象: 全ユーザー                               │
│   期間: 永続                                     │
│   → PHASE 3 へ (クリーンアップ)                  │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 2.2 ロールバック条件

| 条件 | アクション |
|:-----|:-----------|
| エラー率 > 1% | 即座に OFF |
| レイテンシ 2倍以上 | 即座に OFF |
| ユーザー苦情急増 | 即座に OFF |
| セキュリティ問題 | 即座に OFF + 調査 |

---

## PHASE 3: クリーンアップ計画

### 3.1 フラグ削除の原則

> **フラグは技術的負債。100% ロールアウト後は削除する。**

```text
┌─[PHASE 3: クリーンアップ計画]─────────────────────┐
│                                                   │
│ フラグ名: FLAG_[FEATURE_NAME]                     │
│                                                   │
│ 100% ロールアウト日: [YYYY-MM-DD]                 │
│ 観察期間: 2週間                                   │
│ 削除予定日: [YYYY-MM-DD]                          │
│                                                   │
│ 削除手順:                                         │
│   1. フラグチェックを削除                         │
│   2. OFF パスのコードを削除                       │
│   3. フラグ定義を削除                             │
│   4. テストを更新                                 │
│   5. ドキュメントを更新                           │
│                                                   │
│ 担当: [誰が]                                      │
│ チケット: [JIRA/GitHub Issue]                     │
│                                                   │
└───────────────────────────────────────────────────┘
```

### 3.2 フラグ棚卸し

| フラグ名 | 種類 | 作成日 | 削除予定日 | 状態 |
|:---------|:-----|:-------|:-----------|:-----|
| FLAG_A | Release | 2026-01-01 | 2026-02-01 | 🟡 100% |
| FLAG_B | Experiment | 2026-01-15 | 2026-01-30 | 🟢 50% |
| FLAG_C | Ops | 2025-06-01 | N/A | ⚪ 永続 |

---

## Artifact 出力保存規則

> **/flag の結果はフラグ設計書。必ずファイルに保存する。**

### 保存先

```text
<artifact_directory>/flag_<feature>_<date>.md
```

### 保存形式

```markdown
# Feature Flag: [機能名]

## フラグ設計
- フラグ名: FLAG_[NAME]
- 種類: [Release/Experiment/Ops/Permission]
- 寿命: [短期/長期/永続]
- デフォルト: [ON/OFF]

## 実装パターン
- 挿入点: [コード位置]
- パターン: [分岐方式]

## ロールアウト計画
| Stage | 割合 | 期間 | 監視指標 |
|:------|:-----|:-----|:---------|
| 1 | 1% | 1日 | エラー率 |
| 2 | 10% | 3日 | フィードバック |
| 3 | 50% | 1週間 | KPI |
| 4 | 100% | - | - |

## クリーンアップ
- 削除予定日: [YYYY-MM-DD]
- 担当: [誰]
```

---

## X-series 推奨次ステップ

```text
/flag 完了後:

→ /ene (X-OO): 実行 — フラグ付きでデプロイ
→ /sta (X-OS): 基準 — 監視メトリクスを定義
→ /pre (X-OO): Premortem — ロールアウトリスクを事前検証
```

---

## よくある落とし穴

| 落とし穴 | 対策 |
|:---------|:-----|
| **フラグ削除忘れ** | 削除予定日をチケット化 |
| **フラグ爆発** | 定期的な棚卸し |
| **テスト不足** | ON/OFF 両方のテスト必須 |
| **複雑な条件分岐** | ストラテジーパターンに移行 |

---

## Hegemonikon Status

| Module | Workflow | Parent | Status |
|:-------|:---------|:-------|:-------|
| O4 Energeia | /flag | /ene | v1.0 Ready |

---

*v1.0 — O4 Energeia 派生 + SE Feature Flags 手法統合 (2026-01-29)*
