# FEP Agent æ‹¡å¼µè¨ˆç”»: Aè¡Œåˆ—å‹•çš„å­¦ç¿’ + 2-stepæ”¿ç­–Horizon

> **Origin**: arXiv:2412.10425 è«–æ–‡ç²¾èª­ã‹ã‚‰ã®å¸åãƒ‘ã‚¿ãƒ¼ãƒ³
> **Plan**: B (Robust)

## ç›®çš„

pymdp Agent ã‚’æ‹¡å¼µã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§å­¦ç¿’ã—ãŸè¦³å¯Ÿãƒ¢ãƒ‡ãƒ« (Aè¡Œåˆ—) ã‚’æ°¸ç¶šåŒ–ã—ã€2-step ã®æ”¿ç­–è©•ä¾¡ horizon ã‚’å°å…¥ã™ã‚‹ã€‚

---

## STAGE 0: Blindspot + Scale

| ã‚«ãƒ†ã‚´ãƒª | ãƒªã‚¹ã‚¯ | è§£æ±ºç­– |
|:---------|:-------|:-------|
| ğŸ”— Dependencies | ä¸­ | pymdp APIç¢ºèª: `policy_len`, `inference_horizon` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¯¾å¿œå¯èƒ½ |
| â±ï¸ Temporal | ä½ | æ—¢å­˜ãƒ†ã‚¹ãƒˆ10ä»¶ã€å¤‰æ›´å¾Œã‚‚äº’æ›æ€§ç¶­æŒ |
| ğŸ“ Scope | ç¢ºèªæ¸ˆ | Meso (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«å¤‰æ›´) |

**ğŸ“ Scale**: Meso

---

## STAGE 1: Strategy Selection

**âš–ï¸ Explore/Exploit**: Exploit

- å¤±æ•—ã‚³ã‚¹ãƒˆ: ä½ (PoCæ®µéš)
- ç’°å¢ƒç¢ºå®Ÿæ€§: é«˜ (è«–æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³æ´»ç”¨)
- æ™‚é–“åˆ¶ç´„: é€šå¸¸

**é¸æŠ**: Plan B (Robust)

---

## STAGE 2: Success Criteria

| è»¸ | Must | Should | Could |
|:---|:-----|:-------|:------|
| æ©Ÿèƒ½æ€§ | Aè¡Œåˆ—ä¿å­˜ãƒ»èª­è¾¼ | Dirichletæ›´æ–° | è‡ªå‹•åŠ£åŒ–æ¤œå‡º |
| æ©Ÿèƒ½æ€§ | `policy_len=2` è¨­å®š | inference_horizonè¨­å®š | å‹•çš„horizon |
| å“è³ª | æ—¢å­˜10ãƒ†ã‚¹ãƒˆç¶­æŒ | æ–°è¦5ãƒ†ã‚¹ãƒˆè¿½åŠ  | Coverage 80%+ |
| æ€§èƒ½ | æ—¢å­˜ã¨åŒç­‰ | 50msä»¥å†… | 10msä»¥å†… |

**âœ… å®Œäº†æ¡ä»¶**: Must ãŒå…¨ã¦æº€ãŸã•ã‚ŒãŸæ™‚ç‚¹

---

## STAGE 3: Goal Decomposition

```
æœ€çµ‚ç›®æ¨™: è«–æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¸åã—ãŸæ‹¡å¼µFEP Agent
  â†‘
ã‚µãƒ–ã‚´ãƒ¼ãƒ« 2: 2-stepæ”¿ç­–horizonå°å…¥
  â†‘ å‰æ: pymdp Agent ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç†è§£
ã‚µãƒ–ã‚´ãƒ¼ãƒ« 1: Aè¡Œåˆ—æ°¸ç¶šåŒ–
  â†‘ å‰æ: ä¿å­˜ãƒ‘ã‚¹ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ±ºå®š
ç¾åœ¨åœ°: fep_agent.py 423è¡Œã€ãƒ†ã‚¹ãƒˆ10ä»¶
```

---

## Proposed Changes

### Component: mekhane/fep

---

#### [MODIFY] [fep_agent.py](file:///home/makaron8426/oikos/hegemonikon/mekhane/fep/fep_agent.py)

1. **2-stepæ”¿ç­–horizonå°å…¥**
   - `Agent()` åˆæœŸåŒ–æ™‚ã« `policy_len=2` ã‚’è¿½åŠ 
   - `inference_horizon=1` ã‚’æ˜ç¤ºçš„ã«è¨­å®š (è«–æ–‡ã¨åŒä¸€)

2. **Aè¡Œåˆ—æ°¸ç¶šåŒ–ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ **

   ```python
   def save_learned_A(self, path: str) -> None:
       """Save learned A matrix to file."""
       np.save(path, self.agent.A)
   
   def load_learned_A(self, path: str) -> None:
       """Load A matrix from file and update agent."""
       self.agent.A = np.load(path)
   ```

3. **Dirichletæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ **

   ```python
   def update_A_dirichlet(self, observation: int, learning_rate: float = 50.0) -> None:
       """Update A matrix using Dirichlet concentration update."""
       # pA += Î· * outer(o, beliefs)
   ```

---

#### [NEW] [persistence.py](file:///home/makaron8426/oikos/hegemonikon/mekhane/fep/persistence.py)

Aè¡Œåˆ—æ°¸ç¶šåŒ–ã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«:

```python
LEARNED_A_PATH = "/home/makaron8426/oikos/mneme/.hegemonikon/learned_A.npy"

def save_A(agent: HegemonikÃ³nFEPAgent) -> Path
def load_A(path: Path) -> np.ndarray
def A_exists() -> bool
```

---

### Component: tests

---

#### [MODIFY] [test_fep_agent.py](file:///home/makaron8426/oikos/hegemonikon/tests/test_fep_agent.py)

5ä»¶ã®ãƒ†ã‚¹ãƒˆè¿½åŠ :

- `test_policy_len_is_2`: policy_len ãŒ 2 ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- `test_save_learned_A`: Aè¡Œåˆ—ä¿å­˜ãƒ†ã‚¹ãƒˆ
- `test_load_learned_A`: Aè¡Œåˆ—èª­è¾¼ãƒ†ã‚¹ãƒˆ
- `test_dirichlet_update`: Dirichletæ›´æ–°ãƒ†ã‚¹ãƒˆ
- `test_persistence_roundtrip`: ä¿å­˜â†’èª­è¾¼ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—

---

## Verification Plan

### Automated Tests

```bash
# æ—¢å­˜ãƒ†ã‚¹ãƒˆç¶­æŒç¢ºèª
pytest tests/test_fep_agent.py -v

# æ–°è¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/test_fep_agent.py -v -k "policy_len or save or load or dirichlet"
```

### Manual Verification

1. `scripts/fep_demo.py` ã§å‹•ä½œç¢ºèª
2. `/bye` å®Ÿè¡Œæ™‚ã« Aè¡Œåˆ—ãŒä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. `/boot` å®Ÿè¡Œæ™‚ã« Aè¡Œåˆ—ãŒèª­è¾¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ä¾å­˜é–¢ä¿‚

- **pymdp**: `policy_len`, `inference_horizon` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (ç¢ºèªæ¸ˆã¿)
- **numpy**: Aè¡Œåˆ—ä¿å­˜ (æ—¢å­˜)

---

## STAGE 4: Devil's Advocate

| è¦–ç‚¹ | åˆ¤å®š | ç†ç”± |
|:-----|:-----|:-----|
| ğŸ”´ Feasibility | âœ… PASS | pymdp APIã§å¯¾å¿œå¯èƒ½ |
| ğŸ”´ Necessity | âœ… PASS | è«–æ–‡ã§åŠ¹æœå®Ÿè¨¼æ¸ˆã¿ |
| ğŸ”´ Alternatives | âœ… PASS | pymdpå¤‰æ›´ãŒæœ€å°é™ |
| ğŸ”´ Risks | âœ… PASS | æ—¢å­˜ãƒ†ã‚¹ãƒˆç¶­æŒã§æ¤œå‡ºå¯èƒ½ |
| ğŸ”´ Dependencies | âœ… PASS | pymdpäº’æ›æ€§ç¢ºèªæ¸ˆã¿ |

### Pre-mortem

| å¤±æ•—ã‚·ãƒŠãƒªã‚ª | å¯¾ç­– |
|:-------------|:-----|
| pymdp APIå¤‰æ›´ã§policy_lenéå¯¾å¿œ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®š (0.8.1) |
| Aè¡Œåˆ—ã‚µã‚¤ã‚ºä¸ä¸€è‡´ã§èª­è¾¼å¤±æ•— | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ä»˜ããƒ•ã‚¡ã‚¤ãƒ«å |
| Dirichletæ›´æ–°ã§æ•°å€¤ä¸å®‰å®š | ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚° (1e-10) |

---

## å®Ÿè£…é †åº

1. **Phase 1**: `fep_agent.py` ã« `policy_len=2` è¿½åŠ  + ãƒ†ã‚¹ãƒˆ
2. **Phase 2**: `persistence.py` ä½œæˆ + ä¿å­˜/èª­è¾¼ãƒ†ã‚¹ãƒˆ
3. **Phase 3**: Dirichletæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ + ãƒ†ã‚¹ãƒˆ
4. **Phase 4**: `/bye`, `/boot` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆ

---

*Generated by HegemonikÃ³n /plan v3.0*
