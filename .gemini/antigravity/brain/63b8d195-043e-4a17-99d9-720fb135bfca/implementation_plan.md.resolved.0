# CCL 正式文法 (Formal Grammar) 実装計画

> **CCL**: `/noe A` — 問い「CCL の正式文法を定義せよ」への深掘り
> **Date**: 2026-01-31

---

## 1. 目標

CCL を「記法」から「言語」に昇格させるため、**形式文法**を定義する。

### 1.1 現状の課題

| 問題 | 現状 | 解決策 |
|:-----|:-----|:-------|
| 構文検証が正規表現ベース | [syntax_validator.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/ccl/syntax_validator.py) | PEG パーサー |
| 演算子優先順位が暗黙 | 文書のみ | 文法で明示 |
| エラー報告が曖昧 | ブール値のみ | 位置情報付きエラー |

---

## 2. 文法仕様 (EBNF/PEG)

```ebnf
(* CCL Grammar v1.0 *)

program        := statement+ ;

statement      := control_block | expression ;

control_block  := for_loop | if_block | while_block | limit_block ;

for_loop       := "F:" iterator "{" program "}" ;
if_block       := "I:" condition "{" program "}" ;
while_block    := "~:" condition "{" program "}" ;
limit_block    := "lim[" condition "]" "{" program "}" ;

iterator       := "[" id_list "]" | range | expression ;
condition      := comparison | expression ;

expression     := convergence ;
convergence    := sequence (CONVERGE sequence)* ;
sequence       := fusion (SEQ fusion)* ;
fusion         := oscillation (FUSION oscillation)* ;
oscillation    := term (OSC term)* ;
term           := unary* primary selector? ;

primary        := workflow | macro | group | function_call | literal ;
workflow       := TARGET? "/" WORKFLOW_ID ;
macro          := "@" MACRO_ID ;
group          := "(" expression ")" ;
function_call  := FUNC_OP "[" expression "]" ;
literal        := STRING | NUMBER ;

unary          := "+" | "-" | "^" | "/" | "?" | "\\" | "'" | "√" ;
selector       := "[" selector_spec "]" ;
selector_spec  := NUMBER | NUMBER "-" NUMBER | id_list | "*" ;

comparison     := expression COMP_OP expression ;

(* Terminals *)
CONVERGE       := "→" | ">>" ;
SEQ            := "_" ;
FUSION         := "*" ;
OSC            := "~" ;
FUNC_OP        := "E" | "V" | "P" | "C" ;
COMP_OP        := ">" | "<" | ">=" | "<=" | "=" ;
TARGET         := "[" ("CCL" | "WF" | "KI" | "SKILL") "]" ;
WORKFLOW_ID    := [a-z]+ ;
MACRO_ID       := [a-z0-9_]+ ;
STRING         := '"' [^"]* '"' ;
NUMBER         := [0-9]+ ("." [0-9]+)? ;
```

### 2.1 演算子優先順位 (低→高)

| 優先度 | 演算子 | 結合性 |
|:-------|:-------|:-------|
| 1 (低) | `→`, `>>` (収束) | 左 |
| 2 | `_` (シーケンス) | 左 |
| 3 | `*` (融合) | 左 |
| 4 | `~` (振動) | 左 |
| 5 (高) | 単項演算子 | 右 |

---

## 3. 実装ファイル

### 3.1 新規ファイル

| ファイル | 目的 |
|:---------|:-----|
| `mekhane/ccl/grammar.lark` | Lark 文法定義 |
| `mekhane/ccl/parser.py` | パーサー実装 |
| `mekhane/ccl/ast.py` | AST ノード定義 |
| `mekhane/ccl/tests/test_parser.py` | パーサーテスト |

### 3.2 変更ファイル

| ファイル | 変更内容 |
|:---------|:---------|
| [mekhane/ccl/__init__.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/ccl/__init__.py) | パーサー公開 |
| [mekhane/ccl/syntax_validator.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/ccl/syntax_validator.py) | パーサーへ移行 (deprecated) |
| [mekhane/ccl/executor.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/ccl/executor.py) | AST ベース実行に対応 |

---

## 4. 検証計画

### 4.1 自動テスト

```bash
# pytest で実行
cd /home/laihuip001/oikos/hegemonikon
.venv/bin/pytest mekhane/ccl/tests/test_parser.py -v
```

**テストケース**:

| ケース | 入力 | 期待結果 |
|:-------|:-----|:---------|
| 基本 WF | `/noe` | Workflow(id="noe") |
| 単項 | `/noe+` | Unary(op="+", Workflow) |
| 二項 | `/noe*dia` | Fusion(Workflow, Workflow) |
| 複合 | `/bou+_/s+_/ene` | Seq(Seq(...)) |
| 制御 | `F:[O,S]{/noe}` | ForLoop(iter, block) |
| エラー | `/noe++` | ParseError(pos=5) |

### 4.2 手動検証

1. 既存の CCL 式 ([ccl_usage_examples.md](file:///home/laihuip001/oikos/hegemonikon/docs/ccl_usage_examples.md)) を全てパースできることを確認
2. [syntax_validator.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/ccl/syntax_validator.py) の結果と比較

---

## 5. リスクと対策

| リスク | 確率 | 対策 |
|:-------|:-----|:-----|
| 文法の曖昧性 | 中 | PEG (非曖昧) 採用 |
| 後方互換性破壊 | 低 | deprecated 期間設定 |
| パフォーマンス | 低 | Lark の LALR モード使用 |

---

## User Review Required

> [!IMPORTANT]
> **文法設計の確認が必要です**
> 
> 1. 演算子優先順位は直感と合っていますか？
> 2. 制御構文 ([F:](file:///home/laihuip001/oikos/.agent/tools.yaml), [I:](file:///home/laihuip001/oikos/.agent/tools.yaml), [~:](file:///home/laihuip001/oikos/.agent/tools.yaml), `lim[]`) の構文は妥当ですか？
> 3. Lark vs PEG.js — Python 実装で進めてよいですか？

---

*Generated by O1 Noēsis /noe A (2026-01-31)*
