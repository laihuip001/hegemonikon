# Walkthrough: /plan Read-Resolve-Proceed Protocol

## 完了サマリ

`/plan` ワークフローに **Step 0.2: Read-Resolve-Proceed Protocol** を追加しました。

## 変更内容

### 追加: Step 0.2

| フェーズ | 内容 |
|:--|:--|
| **Phase 1: Read** | 対象ファイル、KI、ワークフローを読込 |
| **Phase 2: Identify** | 5カテゴリで懸念点を抽出 |
| **Phase 3: Resolve** | 全懸念点を解決するまでブロック |

### 廃止: Step 0.5

旧「不足情報検出」（U スコア方式）は新 Step 0.2 に発展的統合。

## 変更ファイル

```diff:plan.md
---
description: 新機能実装/大規模変更前の設計プロトコル。計画なくしてコードなし。
hegemonikon: Phronēsis-H
modules: [M4, M3]
---

# /plan: アーキテクチャ設計プロトコル

> **Hegemonikón Module**: M4 Phronēsis (実践知) + M3 Theōria (理論)

> **目的**: コード生成前に設計計画を策定し、ユーザー承認を得る
> **発動条件**: 5行以上のコード変更、新機能実装、アーキテクチャ変更

---

## Step 0: Recollection（自動実行）

> **🧬 [Kernel: Active]** — この表示がない場合、`view_file GEMINI.md` を実行

1. GEMINI.md の「計画駆動開発」セクションを想起
2. 以下を確認:
   - **計画8割・実装2割**: 実装着手前に計画完成
   - **禁止**: ユーザー承認なしの `write_to_file`

---

## Step 0.1: モデル適性チェック（必須）

> **🎯 [T2 Krisis: Active]** — model-selection-guide.md を参照

1. タスクの特性キーワードを検出
2. 推奨アルゴリズム（優先度P1→P5）を適用
3. 結果を以下の形式で出力:

```
[Hegemonikon] T2 Krisis（モデル選択）
  検出特性: {キーワード}
  優先度: {P1-P5}
  推奨: {Claude / Gemini / Gemini Flash}
  理由: {1行}
  → このまま継続 / Geminiに切り替え？
```

**チェックポイント**:

- [ ] model-selection-guide.md の推奨アルゴリズムを適用したか？
- [ ] 推奨を出力したか？

---

## Step 0.5: 不足情報検出（M5 Peira + Gnōsis）

> **不確実性が高い場合、戦略立案前に情報収集が必須**

1. 不確実性スコア U を算出（曖昧な表現、未定義の要件、不明な技術を検出）
2. U > 0.6 の場合:
   - 不足情報をリストアップ
   - **Gnōsis検索**: `python gnosis/cli.py search "query"` で関連論文を取得
   - Gnōsisで不足 → `/zet` で追加リサーチ、またはユーザーに質問
3. U ≤ 0.6 の場合: Step 1 へ進む

**チェックポイント**:

- [ ] 不確実性スコアを算出したか？
- [ ] U > 0.6 の場合、**Gnōsis検索**を実行したか？
- [ ] Gnōsisで不足の場合、追加リサーチを実行したか？

---

## Step 1: コンテキスト分析

1. プロジェクトのファイル構造を読み込む
2. 既存のアーキテクチャパターンを特定する
3. ユーザー要求の不明点をリストアップし、質問する

**チェックポイント**:

- [ ] アーキテクチャパターンを特定・宣言したか？
- [ ] 不明点がある場合、質問したか？

---

## Step 2: 戦略策定

以下の3つのアプローチを提示する:

| Plan | 名称 | 特徴 | リスク |
|------|------|------|--------|
| A | **Conservative** | 最小限の変更で実現 | 柔軟性低 |
| B | **Robust** | 拡張性を重視 (推奨) | 工数増 |
| C | **Aggressive** | 抜本的リファクタリング | リスク高 |

各プランのメリット・デメリット・リスクを明示する。

---

## Step 3: 青写真作成

ユーザーがプランを選択後:

1. `implementation_plan.md` を作成
2. 変更対象ファイルを一覧化
3. 各ファイルの変更概要を記述

### 必須セクション

```markdown
# Implementation Plan

## 目的
[何を達成するか]

## 変更対象ファイル
- [ ] path/to/file1.py - [変更概要]
- [ ] path/to/file2.ts - [変更概要]

## 依存関係
[新規パッケージ、API、サービス]

## リスクと対策
[潜在的な問題と回避策]

## 検証計画
[テスト方法]
```

---

## 重要な制約

> [!CAUTION]
> この段階では**絶対にコードを書かない**。
> 計画の承認を待つこと。

---

## Step 4: Memory Logging (Auto)

計画策定完了を自己記録する:

```bash
python forge/gnosis/logger.py log "system" "/plan Completed" --session "AutoLog"
```

---

## 出力形式

```
┌─[Hegemonikón]──────────────────────┐
│ M4 Phronēsis: 戦略策定完了         │
│ 入力: [ユーザー要求]                │
│ 分析: M3 Theōria (因果モデル構築)    │
│ 出力: プランA/B/C                    │
│ 推奨: [選択されたプラン]              │
└────────────────────────────────────┘

📋 /plan 完了

## 選択されたプラン: [A/B/C]

## Implementation Plan
[上記フォーマットに従った計画]

⏸️ 承認待ち: 計画を承認しますか？ (`y`)
   承認後、`/do` で実装開始
```
===
---
description: 新機能実装/大規模変更前の設計プロトコル。計画なくしてコードなし。
hegemonikon: Phronēsis-H
modules: [M4, M3]
---

# /plan: アーキテクチャ設計プロトコル

> **Hegemonikón Module**: M4 Phronēsis (実践知) + M3 Theōria (理論)

> **目的**: コード生成前に設計計画を策定し、ユーザー承認を得る
> **発動条件**: 5行以上のコード変更、新機能実装、アーキテクチャ変更

---

## Step 0: Recollection（自動実行）

> **🧬 [Kernel: Active]** — この表示がない場合、`view_file GEMINI.md` を実行

1. GEMINI.md の「計画駆動開発」セクションを想起
2. 以下を確認:
   - **計画8割・実装2割**: 実装着手前に計画完成
   - **禁止**: ユーザー承認なしの `write_to_file`

---

## Step 0.1: モデル適性チェック（必須）

> **🎯 [T2 Krisis: Active]** — model-selection-guide.md を参照

1. タスクの特性キーワードを検出
2. 推奨アルゴリズム（優先度P1→P5）を適用
3. 結果を以下の形式で出力:

```
[Hegemonikon] T2 Krisis（モデル選択）
  検出特性: {キーワード}
  優先度: {P1-P5}
  推奨: {Claude / Gemini / Gemini Flash}
  理由: {1行}
  → このまま継続 / Geminiに切り替え？
```

**チェックポイント**:

- [ ] model-selection-guide.md の推奨アルゴリズムを適用したか？
- [ ] 推奨を出力したか？

---

## Step 0.2: Read-Resolve-Proceed Protocol

> **🛡️ [Gate: Blocking]** — 懸念点が全て解決するまで次に進めない
> 
> 設計原則: 「懸念が多すぎて進めない」は正しい状態。進むべきでない時に進まない。

### Phase 1: Read（読込）

1. **対象モジュールのファイル構造**を `list_dir` で探索
2. **関連ファイル**（.md, .py, .yaml 等）を `view_file` で読込
3. **既存 KI** から関連アーティファクトを参照
4. **既存ワークフロー/スキル**の関連部分を確認

### Phase 2: Identify（懸念点抽出）

読込結果から、以下の5カテゴリで懸念点をリストアップ:

| カテゴリ | 例 |
|:--|:--|
| (a) 不明な仕様 | 「この要件の詳細が不明」 |
| (b) 不明な技術 | 「このライブラリの使い方がわからない」 |
| (c) 既存コードとの矛盾 | 「既存の実装と異なる方針」 |
| (d) KI/ドキュメントとの不整合 | 「ドキュメントと異なる動作」 |
| (e) 暗黙の前提 | 「この前提が成り立つか確認が必要」 |

### Phase 3: Resolve（解決）

各懸念点を以下の優先順位で解決:

1. ファイル追加読込
2. KI参照
3. Gnōsis検索
4. `/zet` で調査依頼
5. ユーザーに質問

> [!CAUTION]
> **全ての懸念点が [x] になるまで Step 1 に進んではならない**

### 出力形式

```
[Hegemonikon] Read-Resolve-Proceed
  📂 Files Read: [N] files
  📚 KI Referenced: [リスト]

  🔍 Concerns Identified: [N]
    - [ ] (a) {懸念1} → 解決方法: {方法}
    - [x] (b) {懸念2} → 解決済み: {結果}
    ...

  ⚠️ Unresolved: [M] items
  → 全解決まで待機 / ユーザーに質問
```

**チェックポイント**:

- [ ] 対象ファイルを読み込んだか？
- [ ] 関連KIを参照したか？
- [ ] 5カテゴリで懸念点を列挙したか？
- [ ] 各懸念点に解決方法を割り当てたか？
- [ ] **全ての懸念点が [x] か？**（ゲート条件）

---

## Step 1: コンテキスト分析

1. プロジェクトのファイル構造を読み込む
2. 既存のアーキテクチャパターンを特定する
3. ユーザー要求の不明点をリストアップし、質問する

**チェックポイント**:

- [ ] アーキテクチャパターンを特定・宣言したか？
- [ ] 不明点がある場合、質問したか？

---

## Step 2: 戦略策定

以下の3つのアプローチを提示する:

| Plan | 名称 | 特徴 | リスク |
|------|------|------|--------|
| A | **Conservative** | 最小限の変更で実現 | 柔軟性低 |
| B | **Robust** | 拡張性を重視 (推奨) | 工数増 |
| C | **Aggressive** | 抜本的リファクタリング | リスク高 |

各プランのメリット・デメリット・リスクを明示する。

---

## Step 3: 青写真作成

ユーザーがプランを選択後:

1. `implementation_plan.md` を作成
2. 変更対象ファイルを一覧化
3. 各ファイルの変更概要を記述

### 必須セクション

```markdown
# Implementation Plan

## 目的
[何を達成するか]

## 変更対象ファイル
- [ ] path/to/file1.py - [変更概要]
- [ ] path/to/file2.ts - [変更概要]

## 依存関係
[新規パッケージ、API、サービス]

## リスクと対策
[潜在的な問題と回避策]

## 検証計画
[テスト方法]
```

---

## 重要な制約

> [!CAUTION]
> この段階では**絶対にコードを書かない**。
> 計画の承認を待つこと。

---

## Step 4: Memory Logging (Auto)

計画策定完了を自己記録する:

```bash
python forge/gnosis/logger.py log "system" "/plan Completed" --session "AutoLog"
```

---

## 出力形式

```
┌─[Hegemonikón]──────────────────────┐
│ M4 Phronēsis: 戦略策定完了         │
│ 入力: [ユーザー要求]                │
│ 分析: M3 Theōria (因果モデル構築)    │
│ 出力: プランA/B/C                    │
│ 推奨: [選択されたプラン]              │
└────────────────────────────────────┘

📋 /plan 完了

## 選択されたプラン: [A/B/C]

## Implementation Plan
[上記フォーマットに従った計画]

⏸️ 承認待ち: 計画を承認しますか？ (`y`)
   承認後、`/do` で実装開始
```
```

## 設計原則

> 「懸念が多すぎて進めない」は正しい状態。進むべきでない時に進まない。

## 検証結果

- ✅ Step 0.2 が正しく挿入されている
- ✅ Step 0.5 が削除されている
- ✅ Step 番号の整合性を確認
