# Claude-Jules マルチエージェントシステム 詳細設計

## 設計決定

**Pattern A 採用**: Ultra 単体で 60並列

| 項目 | 値 |
|-----|-----|
| 契約 | Google AI Ultra ($249.99/月) |
| 並列数 | 最大60（実運用は30-40推奨） |
| 日次制限 | 300タスク |
| API キー | 1個（ローテーション不要） |

> **理由**: 18キー運用は検知リスク80-95%。Pattern Aで十分な並列性を確保。

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│ Claude (Antigravity IDE)                                │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ Strategic Layer                                     │ │
│ │ - タスク分割・優先順位判定                           │ │
│ │ - 結果検証・マージ判断                               │ │
│ └──────────────────────┬──────────────────────────────┘ │
└────────────────────────┼────────────────────────────────┘
                         ↓ MCP Protocol
┌────────────────────────────────────────────────────────┐
│ jules_mcp_server.py (新規)                             │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Tools                                              │ │
│ │ - jules_create_task: セッション作成                 │ │
│ │ - jules_batch_execute: 並列実行（max 60）          │ │
│ │ - jules_get_status: ステータス確認                 │ │
│ └────────────────────────────────────────────────────┘ │
│ ┌────────────────────────────────────────────────────┐ │
│ │ Polling Manager                                    │ │
│ │ - asyncio.gather で並列ポーリング                   │ │
│ │ - 指数バックオフ（429対策）                         │ │
│ │ - タイムアウト: 5分/タスク                          │ │
│ └────────────────────────────────────────────────────┘ │
└─────────────────────────┬──────────────────────────────┘
                          ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│ Jules API (Google Cloud)                                │
│ - POST /v1alpha/sessions                                │
│ - GET  /v1alpha/sessions/{id}                           │
│ - 同時60セッション実行                                   │
└─────────────────────────────────────────────────────────┘
```

---

## Proposed Changes

### Phase 1: Jules Client 実装

#### [NEW] [jules_client.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/symploke/jules_client.py)

```python
# 核心部分のみ
class JulesClient:
    BASE_URL = "https://jules.googleapis.com/v1alpha"
    
    async def create_session(self, prompt: str, repo: str) -> dict:
        """セッション作成"""
        
    async def poll_session(self, session_id: str, timeout: int = 300) -> dict:
        """ポーリング（5秒間隔、最大5分）"""
        
    async def batch_execute(self, tasks: list[dict], max_concurrent: int = 30) -> list[dict]:
        """並列実行（Semaphore で制限）"""
```

#### [NEW] [jules_mcp_server.py](file:///home/laihuip001/oikos/hegemonikon/mcp/jules_mcp_server.py)

MCP Tools:
- `jules_create_task`: 単一タスク作成
- `jules_batch_execute`: 並列実行（max 60）
- `jules_get_status`: ステータス確認
- `jules_list_repos`: 利用可能リポジトリ一覧

---

### Phase 2: Claude 統合

#### [MODIFY] [tools.yaml](file:///home/laihuip001/oikos/.agent/tools.yaml)

```yaml
mcp:
  jules:
    path: mcp/jules_mcp_server.py
    description: "Jules API 並列実行"
    tools:
      - name: jules_batch_execute
        description: "最大60並列でコード生成タスクを実行"
```

---

## Verification Plan

### 自動テスト

```bash
# Phase 1 完了後
python -m pytest tests/test_jules_client.py -v

# MCP Server 動作確認
python mcp/jules_mcp_server.py --test
```

### 手動検証

1. 単一タスク実行（1セッション）
2. 5並列テスト
3. 30並列負荷テスト
4. タイムアウト・エラーハンドリング確認

---

## User Review Required

> [!IMPORTANT]
> **Pattern A 確定**: 18キー運用は断念し、Ultra 60並列で実装

> [!NOTE]
> **日次制限**: 300タスク/日。大規模運用には Pattern D（複数契約）を検討

---

## 実装ロードマップ

| Phase | 期間 | 成果物 |
|------|------|--------|
| 1 | 1週間 | `jules_client.py` + `jules_mcp_server.py` |
| 2 | 3日 | tools.yaml 統合 + 動作確認 |
| 3 | 3日 | テスト + ドキュメント |

**合計**: 約2週間

---

*Generated by Hegemonikón O4 Energeia 2026-01-27*
