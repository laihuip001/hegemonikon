# S2 Mekhanē+ 設計出力: P2-1 & P2-2

> **CCL**: `/mek+ --mode=inve`
> **入力**: let 構文 + ccl_signature

---

## P2-1: let 構文実装設計 (CCL v2.4)

### 設計概要

**構文**:

```ccl
let @morning = /boot+_@dig_@plan_@go
let @review = /dia+*^/gno+_/dox
```

**特徴**:

- ユーザー定義マクロ
- セッション間で永続化
- 既存 `macro_registry.py` を拡張

---

### 実装対象

#### [MODIFY] `macro_expander.py`

```python
# let 構文のパース
LET_PATTERN = re.compile(r'^let\s+@(\w+)\s*=\s*(.+)$')

def parse_let(expr: str) -> Optional[Tuple[str, str]]:
    """let @name = ccl を解析"""
    match = LET_PATTERN.match(expr.strip())
    if match:
        return match.group(1), match.group(2)
    return None
```

#### [MODIFY] `macro_registry.py`

```python
def define_user_macro(self, name: str, ccl: str) -> Macro:
    """ユーザー定義マクロを追加"""
    macro = Macro(name=name, ccl=ccl, description=f"User-defined: {ccl}", is_builtin=False)
    self.user_macros[name] = macro
    self._save()
    return macro
```

---

## P2-2: ccl_signature 追加設計

### 設計概要

ワークフロー YAML frontmatter に `ccl_signature` フィールドを追加。

**例** (`boot.md`):

```yaml
---
description: セッション開始時の統合ブートシーケンス
ccl_signature: "/boot+"
---
```

**例** (`bou.md`):

```yaml
---
ccl_signature: "/bou*"
  pure: true
---
```

---

### 対象ワークフロー (優先度順)

| ワークフロー | ccl_signature | pure |
|:-------------|:--------------|:-----|
| `/boot` | `/boot+` | false |
| `/bou` | `/bou*` | true |
| `/s` | `/s+_/dia` | false |
| `/noe` | `/noe+^` | true |
| `/ene` | `/ene+` | false |
| `/dia` | `/dia*^` | true |
| `/zet` | `/zet+` | true |

---

### 実装ステップ

1. **Phase A**: Core ワークフロー 7件に `ccl_signature` 追加
2. **Phase B**: `workflow_signature.py` を更新して動的読み込み
3. **Phase C**: `/mek` で自動検証

---

## 実行 CCL

```ccl
# P2-1: let 構文実装
/s+_/ene --target=macro_expander.py,macro_registry.py

# P2-2: ccl_signature 追加
/s+_/ene --target=workflows/*.md
```

---

*Generated by S2 Mekhanē+ (inve)*
