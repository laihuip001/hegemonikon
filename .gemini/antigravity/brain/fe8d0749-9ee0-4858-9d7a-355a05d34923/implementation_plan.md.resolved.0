# FEP ワークフロー統合計画

> **Goal**: `/noe`, `/bou` ワークフロー内で FEP Agent を使った認知的意思決定支援を実装

## 現状分析

### 既存実装 ✅
- [fep_agent.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/fep_agent.py): HegemonikónFEPAgent (570行, 19テスト PASSED)
- [encoding.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/encoding.py): テキスト → 観察インデックス変換
- [persistence.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/persistence.py): A行列永続化
- O1 Noēsis SKILL.md: FEP セクション既存（使用例記載）

### 未実装 ⏳
- **ワークフロー内での FEP 呼び出し**: `/noe`, `/bou` で実際に FEP を使用していない
- **FEP 判定の出力**: エントロピー、推奨アクションの可視化

---

## 設計方針

### 統合パターン: "Cognitive Feedback Loop"

```
┌─ /noe or /bou ワークフロー ──────────────────────┐
│                                                    │
│  [PHASE 5] 完了後                                  │
│      ↓                                             │
│  [FEP PHASE] 認知的フィードバック                  │
│    1. PHASE 5 の結果から観察値を生成               │
│       - confidence_score → confidence              │
│       - uncertainty_zones → context_clarity        │
│       - (衝動スコア or 緊急度) → urgency          │
│    2. FEP Agent.step() で信念更新 + 政策推論       │
│    3. 推奨アクション (observe/act) を出力          │
│      ↓                                             │
│  最終出力に FEP 判定を追加                         │
└────────────────────────────────────────────────────┘
```

### 出力形式

```text
━━━ FEP Cognitive Feedback ━━━
┌─[Active Inference Layer]──────────────────┐
│ 観察値: context=clear, urgency=low, conf=high │
│ 信念状態:                                  │
│   phantasia: clear (72%)                   │
│   assent: granted (65%)                    │
│   horme: passive (58%)                     │
│ エントロピー: 1.42 (中程度の不確実性)      │
│ 推奨: act (確率 77%)                       │
│   → 結論に確信あり、行動に移行可能         │
└────────────────────────────────────────────┘
```

---

## Proposed Changes

### Component: Workflow Layer

---

#### [MODIFY] [noe.md](file:///home/laihuip001/oikos/.agent/workflows/noe.md)

**追加ステップ**: PHASE 5 の後に FEP PHASE を追加

```text
[PHASE 5] メタ認知出力
  ↓
[FEP PHASE] 認知的フィードバック ← NEW
  ↓
ファイル保存
```

---

#### [MODIFY] [bou.md](file:///home/laihuip001/oikos/.agent/workflows/bou.md)

**追加ステップ**: PHASE 5 の後に FEP PHASE を追加

```text
[PHASE 5] 優先順位と行動
  ↓
[FEP PHASE] 認知的フィードバック ← NEW
  ↓
Artifact 保存 → /ene へ
```

---

### Component: Skill Layer

---

#### [MODIFY] [o1-noesis/SKILL.md](file:///home/laihuip001/oikos/.agent/skills/ousia/o1-noesis/SKILL.md)

**更新内容**:
1. "FEP Implementation" セクションを "Integration" セクションに昇格
2. FEP PHASE の詳細手順を追加
3. 出力形式を追加

---

#### [MODIFY] [o2-boulesis/SKILL.md](file:///home/laihuip001/oikos/.agent/skills/ousia/o2-boulesis/SKILL.md)

**追加内容**: FEP Implementation セクション（O1 と同様のパターン）

---

### Component: FEP Layer

---

#### [NEW] [workflow_integration.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/workflow_integration.py)

ワークフロー統合用のヘルパー関数を提供:

```python
def generate_fep_feedback(
    confidence_score: float,
    uncertainty_zones: List[Dict],
    impulse_score: Optional[float] = None,
) -> str:
    """
    ワークフロー結果から FEP フィードバックを生成。
    
    Args:
        confidence_score: PHASE 5 の信頼度 (0.0-1.0)
        uncertainty_zones: 不確実領域リスト
        impulse_score: /bou の衝動スコア (0-100)
    
    Returns:
        Markdown 形式の FEP 判定出力
    """
```

---

## Verification Plan

### Automated Tests

```bash
# 既存 FEP テスト維持
PYTHONPATH=. pytest tests/test_fep_agent.py -v

# 新規統合テスト
PYTHONPATH=. pytest tests/test_workflow_integration.py -v
```

### Manual Verification

1. `/noe` 実行後に FEP フィードバックが出力されることを確認
2. `/bou` 実行後に FEP フィードバックが出力されることを確認
3. FEP 判定が結論と整合していることを確認

---

## 実装順序

1. **Phase 1**: `workflow_integration.py` 作成 + テスト
2. **Phase 2**: O1 Noēsis SKILL.md に FEP PHASE 追加
3. **Phase 3**: O2 Boulēsis SKILL.md に FEP PHASE 追加
4. **Phase 4**: `/noe`, `/bou` ワークフローに統合ステップ追加
5. **Phase 5**: 実際に `/noe` を実行して動作確認

---

*Generated by Hegemonikón /plan v3.0*
