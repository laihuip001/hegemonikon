# FEP ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆè¨ˆç”» v2

> **Goal**: `/noe`, `/bou` ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§ FEP Agent ã‚’ä½¿ã£ãŸèªçŸ¥çš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å®Ÿè£…
> **Plan**: B (Robust)
> **Revision**: /syn ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®4ä»¶ã®ä¸å‚™ã‚’åæ˜ 

---

## STAGE 0: Blindspot + Scale

| ã‚«ãƒ†ã‚´ãƒª | ãƒªã‚¹ã‚¯ | è§£æ±ºç­– |
|:---------|:-------|:-------|
| ğŸ¯ Framing | ä½ | FEP çµ±åˆ = èªçŸ¥çš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ |
| ğŸ“ Scope | ä¸­ â†’ **è§£æ±º** | SKILL.md ã®ã¿å¤‰æ›´ã€workflow.md ã¯å‚ç…§ã®ã¿ |
| ğŸ”— Dependencies | ä¸­ â†’ **è§£æ±º** | æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ã€[encoding.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/encoding.py) æ‹¡å¼µ |
| ğŸ‘¤ Stakeholders | ä½ | Creator ã®ã¿ |
| â±ï¸ Temporal | ä½ | å°†æ¥çš„ã«å…¨ O-series ã«æ‹¡å¼µå¯èƒ½ãªè¨­è¨ˆ |

ğŸ“ **Scale**: Meso

---

## STAGE 1: Strategy Selection

âš–ï¸ **Explore/Exploit**: Exploit
- å¤±æ•—ã‚³ã‚¹ãƒˆ: ä½ (PoC æ®µéš)
- ç’°å¢ƒç¢ºå®Ÿæ€§: é«˜ (FEP Agent æ—¢ã«ãƒ†ã‚¹ãƒˆæ¸ˆã¿)
- æ™‚é–“åˆ¶ç´„: é€šå¸¸

**é¸æŠ**: Plan B (Robust)

---

## STAGE 2: Success Criteria

| è»¸ | Must | Should | Could |
|:---|:-----|:-------|:------|
| æ©Ÿèƒ½æ€§ | `/noe` å®Œäº†å¾Œã« FEP åˆ¤å®šãŒå‡ºåŠ›ã•ã‚Œã‚‹ | `/bou` ã§ã‚‚å‹•ä½œ | å…¨ O-series æ‹¡å¼µ |
| å“è³ª | æ—¢å­˜ 19 ãƒ†ã‚¹ãƒˆç¶­æŒ | æ–°è¦ 3 ãƒ†ã‚¹ãƒˆè¿½åŠ  | Coverage 85%+ |
| æ€§èƒ½ | +100ms ä»¥å†… | +50ms ä»¥å†… | +10ms ä»¥å†… |

âœ… **å®Œäº†æ¡ä»¶**: Must ãŒå…¨ã¦æº€ãŸã•ã‚ŒãŸæ™‚ç‚¹

---

## STAGE 3: Blueprint

### Goal Decomposition

```
æœ€çµ‚ç›®æ¨™: /noe, /bou ã§ FEP èªçŸ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå‡ºåŠ›ã•ã‚Œã‚‹
  â†‘
ã‚µãƒ–ã‚´ãƒ¼ãƒ« 2: SKILL.md ã« FEP PHASE ã‚’è¿½åŠ 
  â†‘ å‰æ: å¤‰æ›é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹
ã‚µãƒ–ã‚´ãƒ¼ãƒ« 1: encoding.py ã«å¤‰æ›é–¢æ•°ã‚’è¿½åŠ 
  â†‘ å‰æ: å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ãŒæ˜ç¢º
ç¾åœ¨åœ°: å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯æ˜ç¢ºåŒ–æ¸ˆã¿
```

---

## Proposed Changes

### Component: FEP Layer

---

#### [MODIFY] [encoding.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/encoding.py)

2ã¤ã®å¤‰æ›é–¢æ•°ã‚’è¿½åŠ :

```python
def encode_noesis_output(
    confidence_score: float,
    uncertainty_zones: List[Dict],
) -> Tuple[int, int, int]:
    """O1 NoÄ“sis ã® PHASE 5 å‡ºåŠ›ã‹ã‚‰è¦³å¯Ÿå€¤ã‚’ç”Ÿæˆã€‚
    
    Args:
        confidence_score: ä¿¡é ¼åº¦ (0.0-1.0)
        uncertainty_zones: ä¸ç¢ºå®Ÿé ˜åŸŸãƒªã‚¹ãƒˆ
    
    Returns:
        (context_idx, urgency_idx, confidence_idx)
    
    Mapping Logic:
        - context_clarity = 1.0 - (len(uncertainty_zones) * 0.2)
        - urgency = 0.3 (NoÄ“sis ã¯æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã€ä½ç·Šæ€¥åº¦)
        - confidence = confidence_score ã‚’ãã®ã¾ã¾ä½¿ç”¨
    """
    context_clarity = max(0.0, min(1.0, 1.0 - len(uncertainty_zones) * 0.2))
    return encode_structured_input(
        context="clear" if context_clarity >= 0.5 else "ambiguous",
        urgency="low",
        confidence="high" if confidence_score >= 0.7 else "medium" if confidence_score >= 0.4 else "low",
    )


def encode_boulesis_output(
    impulse_score: float,
    feasibility_score: float,
) -> Tuple[int, int, int]:
    """O2 BoulÄ“sis ã® PHASE 5 å‡ºåŠ›ã‹ã‚‰è¦³å¯Ÿå€¤ã‚’ç”Ÿæˆã€‚
    
    Args:
        impulse_score: è¡å‹•ã‚¹ã‚³ã‚¢ (0-100) â€” é«˜ã„ã»ã©è¡å‹•çš„
        feasibility_score: å®Ÿç¾å¯èƒ½æ€§ (0-100)
    
    Returns:
        (context_idx, urgency_idx, confidence_idx)
    
    Mapping Logic:
        - context = å®Ÿç¾å¯èƒ½æ€§ã§åˆ¤å®š (>70 = clear)
        - urgency = è¡å‹•ã‚¹ã‚³ã‚¢ã§åˆ¤å®š (è¡å‹•çš„ = é«˜ç·Šæ€¥åº¦)
        - confidence = å®Ÿç¾å¯èƒ½æ€§ã§åˆ¤å®š
    """
    urgency = "high" if impulse_score >= 70 else "medium" if impulse_score >= 40 else "low"
    confidence = "high" if feasibility_score >= 70 else "medium" if feasibility_score >= 40 else "low"
    context = "clear" if feasibility_score >= 50 else "ambiguous"
    
    return encode_structured_input(context=context, urgency=urgency, confidence=confidence)


def generate_fep_feedback_markdown(
    agent_result: Dict[str, Any],
    observation_description: str,
) -> str:
    """FEP Agent ã®çµæœã‚’ Markdown å½¢å¼ã§å‡ºåŠ›ã€‚
    
    Args:
        agent_result: HegemonikÃ³nFEPAgent.step() ã®æˆ»ã‚Šå€¤
        observation_description: è¦³å¯Ÿå€¤ã®èª¬æ˜ (ä¾‹: "context=clear, urgency=low, conf=high")
    
    Returns:
        Markdown å½¢å¼ã® FEP ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    """
    action_name = agent_result.get("action_name", "unknown")
    q_pi = agent_result.get("q_pi", [0.5, 0.5])
    action_prob = q_pi[agent_result.get("action", 0)] * 100
    entropy = agent_result.get("entropy", 0.0)
    map_state = agent_result.get("map_state_names", {})
    
    # ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã®è§£é‡ˆ
    if entropy < 1.0:
        entropy_desc = "ä½ã„ä¸ç¢ºå®Ÿæ€§"
    elif entropy < 2.0:
        entropy_desc = "ä¸­ç¨‹åº¦ã®ä¸ç¢ºå®Ÿæ€§"
    else:
        entropy_desc = "é«˜ã„ä¸ç¢ºå®Ÿæ€§ (EpochÄ“ æ¨å¥¨)"
    
    return f"""â”â”â” FEP Cognitive Feedback â”â”â”
â”Œâ”€[Active Inference Layer]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¦³å¯Ÿå€¤: {observation_description}         â”‚
â”‚ ä¿¡å¿µçŠ¶æ…‹:                                  â”‚
â”‚   phantasia: {map_state.get('phantasia', '?')}  â”‚
â”‚   assent: {map_state.get('assent', '?')}        â”‚
â”‚   horme: {map_state.get('horme', '?')}          â”‚
â”‚ ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼: {entropy:.2f} ({entropy_desc})    â”‚
â”‚ æ¨å¥¨: {action_name} ({action_prob:.0f}%)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"""
```

---

### Component: Skill Layer

---

#### [MODIFY] [o1-noesis/SKILL.md](file:///home/laihuip001/oikos/.agent/skills/ousia/o1-noesis/SKILL.md)

**è¿½åŠ ä½ç½®**: PHASE 5 ã®å¾Œã€ã€Œçµ±åˆå‡ºåŠ›å½¢å¼ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰

```markdown
## PHASE 6: FEP Cognitive Feedback (Optional)

> **Status**: è‡ªå‹•ç™ºå‹•ï¼ˆPHASE 5 å®Œäº†å¾Œï¼‰
> **ä¾å­˜**: `mekhane/fep/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. PHASE 5 ã® `confidence_score` ã¨ `uncertainty_zones` ã‚’å–å¾—
2. `encode_noesis_output()` ã§è¦³å¯Ÿå€¤ã«å¤‰æ›
3. `HegemonikÃ³nFEPAgent.step()` ã§ä¿¡å¿µæ›´æ–° + æ”¿ç­–æ¨è«–
4. `generate_fep_feedback_markdown()` ã§å‡ºåŠ›ç”Ÿæˆ

### ä½¿ç”¨ã‚³ãƒ¼ãƒ‰

\`\`\`python
from mekhane.fep import HegemonikÃ³nFEPAgent
from mekhane.fep.encoding import encode_noesis_output, generate_fep_feedback_markdown

# PHASE 5 ã®çµæœã‹ã‚‰
obs = encode_noesis_output(
    confidence_score=phase5_result["confidence_score"],
    uncertainty_zones=phase5_result["uncertainty_zones"],
)

agent = HegemonikÃ³nFEPAgent()
result = agent.step(encode_to_flat_index_from_tuple(obs))

print(generate_fep_feedback_markdown(result, f"context={obs[0]}, urgency={obs[1]}, conf={obs[2]}"))
\`\`\`

### å‡ºåŠ›å½¢å¼

\`\`\`
â”â”â” FEP Cognitive Feedback â”â”â”
â”Œâ”€[Active Inference Layer]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¦³å¯Ÿå€¤: context=clear, urgency=low, conf=high â”‚
â”‚ ä¿¡å¿µçŠ¶æ…‹:                                  â”‚
â”‚   phantasia: clear                         â”‚
â”‚   assent: granted                          â”‚
â”‚   horme: passive                           â”‚
â”‚ ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼: 1.42 (ä¸­ç¨‹åº¦ã®ä¸ç¢ºå®Ÿæ€§)      â”‚
â”‚ æ¨å¥¨: act (77%)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è§£é‡ˆ

| æ¨å¥¨ | æ„å‘³ | æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— |
|:-----|:-----|:-------------|
| **act** | ç¢ºä¿¡ã‚ã‚Šã€è¡Œå‹•å¯èƒ½ | çµè«–ã‚’æ¡ç”¨ã—ã€/ene ã§å®Ÿè¡Œ |
| **observe** | ä¸ç¢ºå®Ÿæ€§ãŒé«˜ã„ | è¿½åŠ èª¿æŸ» (/zet) ã¾ãŸã¯ /epo ã§åˆ¤æ–­åœæ­¢ |
```

---

#### [MODIFY] [o2-boulesis/SKILL.md](file:///home/laihuip001/oikos/.agent/skills/ousia/o2-boulesis/SKILL.md)

**è¿½åŠ ä½ç½®**: PHASE 5 ã®å¾Œï¼ˆO1 NoÄ“sis ã¨åŒæ§˜ã®æ§‹é€ ï¼‰

åŒæ§˜ã® FEP PHASE ã‚’è¿½åŠ ã€‚å¤‰æ›é–¢æ•°ã¯ `encode_boulesis_output()` ã‚’ä½¿ç”¨ã€‚

---

### Component: Tests

---

#### [MODIFY] [test_fep_agent.py](file:///home/laihuip001/oikos/hegemonikon/tests/test_fep_agent.py)

3ä»¶ã®ãƒ†ã‚¹ãƒˆè¿½åŠ :

```python
class TestWorkflowEncoding:
    def test_encode_noesis_output(self):
        from mekhane.fep.encoding import encode_noesis_output
        obs = encode_noesis_output(confidence_score=0.87, uncertainty_zones=[{"zone": "A"}])
        assert len(obs) == 3
        assert obs[2] == 2  # high confidence
    
    def test_encode_boulesis_output(self):
        from mekhane.fep.encoding import encode_boulesis_output
        obs = encode_boulesis_output(impulse_score=25, feasibility_score=80)
        assert obs[1] == 0  # low urgency (ç†Ÿæ…®)
        assert obs[2] == 2  # high confidence
    
    def test_generate_fep_feedback_markdown(self):
        from mekhane.fep.encoding import generate_fep_feedback_markdown
        mock_result = {
            "action_name": "act", "action": 1, "q_pi": [0.23, 0.77],
            "entropy": 1.42, "map_state_names": {"phantasia": "clear", "assent": "granted", "horme": "passive"}
        }
        output = generate_fep_feedback_markdown(mock_result, "test")
        assert "act (77%)" in output
        assert "phantasia: clear" in output
```

---

## Verification Plan

### Automated Tests

```bash
# æ—¢å­˜ãƒ†ã‚¹ãƒˆç¶­æŒç¢ºèª
PYTHONPATH=. pytest tests/test_fep_agent.py -v

# æ–°è¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
PYTHONPATH=. pytest tests/test_fep_agent.py -v -k "workflow"
```

### Manual Verification

1. `/noe [ãƒ†ã‚¹ãƒˆå•é¡Œ]` ã‚’å®Ÿè¡Œ
2. PHASE 5 å®Œäº†å¾Œã« FEP ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (act/observe) ãŒçµè«–ã¨æ•´åˆã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## STAGE 4: Devil's Advocate

| è¦–ç‚¹ | åˆ¤å®š | ç†ç”± |
|:-----|:-----|:-----|
| ğŸ”´ Feasibility | âœ… PASS | encoding.py æ‹¡å¼µã®ã¿ã€ä½ãƒªã‚¹ã‚¯ |
| ğŸ”´ Necessity | âœ… PASS | FEP åˆ¤å®šã¯èªçŸ¥çš„æ„æ€æ±ºå®šæ”¯æ´ã«æœ‰ç”¨ |
| ğŸ”´ Alternatives | âœ… PASS | æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸è¦ã¨åˆ¤æ–­æ¸ˆã¿ |
| ğŸ”´ Risks | âœ… PASS | æ—¢å­˜ãƒ†ã‚¹ãƒˆç¶­æŒã§æ¤œå‡ºå¯èƒ½ |
| ğŸ”´ Dependencies | âœ… PASS | pymdp ã®ã¿ã€æ—¢å­˜ |

### Pre-mortem

| å¤±æ•—ã‚·ãƒŠãƒªã‚ª | å¯¾ç­– |
|:-------------|:-----|
| PHASE 5 å‡ºåŠ›å½¢å¼ãŒå¤‰ã‚ã£ãŸ | å¤‰æ›é–¢æ•°ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š |
| FEP åˆ¤å®šãŒå¸¸ã«åŒã˜çµæœ | ãƒ†ã‚¹ãƒˆã§å¤šæ§˜ãªå…¥åŠ›ã‚’ã‚«ãƒãƒ¼ |
| å‡ºåŠ›ãŒé•·ã™ãã¦é‚ªé­” | Optional æ‰±ã„ã€ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ã« |

---

## å®Ÿè£…é †åº

1. **Phase 1**: [encoding.py](file:///home/laihuip001/oikos/hegemonikon/mekhane/fep/encoding.py) ã«3ã¤ã®é–¢æ•°è¿½åŠ  + ãƒ†ã‚¹ãƒˆ
2. **Phase 2**: O1 NoÄ“sis SKILL.md ã« FEP PHASE è¿½åŠ 
3. **Phase 3**: O2 BoulÄ“sis SKILL.md ã« FEP PHASE è¿½åŠ 
4. **Phase 4**: `/noe` ã‚’å®Ÿéš›ã«å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèª

---

*Generated by HegemonikÃ³n /plan v3.0*
