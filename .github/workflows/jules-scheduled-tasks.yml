# Jules Daily Specialist Reviews for HegemonikÃ³n (v4.0)
#
# tekhne-maker v5.0 ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—é§†å‹•è¨­è¨ˆã«åŸºã¥ã
# å°‚é–€å®¶ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®**æ¯Žæ—¥**å®šæ™‚å®Ÿè¡Œ
#
# v4.0 æ‹¡å¼µ:
#   - å‹•çš„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠž (git-diff / priority / fixed)
#   - çµæžœçµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (collect_results.py)
#   - n8n webhook é€šçŸ¥å¯¾å¿œ
#
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:
# - æ¯Žæ—¥ 10:00 UTC (19:00 JST)
# - 9 API ã‚­ãƒ¼ Ã— 80 ã‚¿ã‚¹ã‚¯ = 720 å°‚é–€å®¶/æ—¥

name: Jules Daily Specialist Reviews

on:
  schedule:
    # æ¯Žæ—¥ 10:00 UTC (19:00 JST)
    - cron: "0 10 * * *"
  workflow_dispatch:
    inputs:
      category:
        description: "å®Ÿè¡Œã™ã‚‹ã‚«ãƒ†ã‚´ãƒª (all/cognitive_load/ai_risk/async/theory)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cognitive_load
          - ai_risk
          - async
          - theory
          - aesthetics
          - naming
          - type_safety
          - error_handling
          - security
          - testing
          - documentation
          - function_design
          - class_design
          - hegemonikon
      target_mode:
        description: "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠžãƒ¢ãƒ¼ãƒ‰"
        required: true
        default: "git-diff"
        type: choice
        options:
          - git-diff
          - fixed
          - priority
      target_file:
        description: "ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« (fixed ãƒ¢ãƒ¼ãƒ‰ç”¨)"
        required: false
        default: "mekhane/symploke/jules_client.py"
      max_files:
        description: "æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«æ•° (git-diff/priority ãƒ¢ãƒ¼ãƒ‰)"
        required: false
        default: "10"
      sample:
        description: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Šã®å°‚é–€å®¶ã‚µãƒ³ãƒ—ãƒ«æ•° (0 = å…¨å“¡)"
        required: false
        default: "0"
      dry_run:
        description: "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿè¡Œã›ãšãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¢ºèªï¼‰"
        type: boolean
        default: false

env:
  JULES_REPO_SOURCE: "sources/github/${{ github.repository }}"
  JULES_BRANCH: "master"
  JULES_REQUEST_DELAY: "1.5"
  JULES_RETRY_BASE_DELAY: "3.0"

jobs:
  daily-specialist-review:
    name: "ðŸ” Daily Specialist Review (720/day capacity)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # git diff HEAD~1 ã«å¿…è¦

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install aiohttp

      - name: Run Specialist Batch
        env:
          # Secrets: JULIUS_API_KEY_1~18 â†’ ã‚³ãƒ¼ãƒ‰: JULES_API_KEY_01~18
          JULES_API_KEY_01: ${{ secrets.JULIUS_API_KEY_1 }}
          JULES_API_KEY_02: ${{ secrets.JULIUS_API_KEY_2 }}
          JULES_API_KEY_03: ${{ secrets.JULIUS_API_KEY_3 }}
          JULES_API_KEY_04: ${{ secrets.JULIUS_API_KEY_4 }}
          JULES_API_KEY_05: ${{ secrets.JULIUS_API_KEY_5 }}
          JULES_API_KEY_06: ${{ secrets.JULIUS_API_KEY_6 }}
          JULES_API_KEY_07: ${{ secrets.JULIUS_API_KEY_7 }}
          JULES_API_KEY_08: ${{ secrets.JULIUS_API_KEY_8 }}
          JULES_API_KEY_09: ${{ secrets.JULIUS_API_KEY_9 }}
          JULES_API_KEY_10: ${{ secrets.JULIUS_API_KEY_10 }}
          JULES_API_KEY_11: ${{ secrets.JULIUS_API_KEY_11 }}
          JULES_API_KEY_12: ${{ secrets.JULIUS_API_KEY_12 }}
          JULES_API_KEY_13: ${{ secrets.JULIUS_API_KEY_13 }}
          JULES_API_KEY_14: ${{ secrets.JULIUS_API_KEY_14 }}
          JULES_API_KEY_15: ${{ secrets.JULIUS_API_KEY_15 }}
          JULES_API_KEY_16: ${{ secrets.JULIUS_API_KEY_16 }}
          JULES_API_KEY_17: ${{ secrets.JULIUS_API_KEY_17 }}
          JULES_API_KEY_18: ${{ secrets.JULIUS_API_KEY_18 }}
        run: |
          cd mekhane/symploke

          # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
          CATEGORY="${{ github.event.inputs.category || 'all' }}"
          TARGET_MODE="${{ github.event.inputs.target_mode || 'git-diff' }}"
          TARGET="${{ github.event.inputs.target_file || 'mekhane/symploke/jules_client.py' }}"
          MAX_FILES="${{ github.event.inputs.max_files || '10' }}"
          SAMPLE="${{ github.event.inputs.sample || '0' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          echo "=== Jules Daily Specialist Review v4.0 (720/day) ==="
          echo "Date: $(date -u +%Y-%m-%d)"
          echo "Category: $CATEGORY"
          echo "Target Mode: $TARGET_MODE"
          echo "Target: $TARGET"
          echo ""

          # å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰æ§‹ç¯‰
          CMD="python run_specialists.py"
          CMD="$CMD --category $CATEGORY"
          CMD="$CMD --target-mode $TARGET_MODE"
          CMD="$CMD --target $TARGET"
          CMD="$CMD --max-files $MAX_FILES"
          CMD="$CMD --output ../../logs/specialist_daily/run_$(date -u +%Y%m%d_%H%M).json"

          if [ "$SAMPLE" != "0" ]; then
            CMD="$CMD --sample $SAMPLE"
          fi

          if [ "$DRY_RUN" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Executing: $CMD"
          eval $CMD

      - name: Collect Results
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          cd mekhane/symploke
          python collect_results.py --dir ../../logs/specialist_daily --days 1

      - name: Create Issues (Quality Filtered)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JULES_API_KEY_01: ${{ secrets.JULIUS_API_KEY_1 }}
          JULES_REPO_SOURCE: ${{ github.repository }}
        run: |
          cd mekhane/symploke
          echo "=== Creating Issues from quality findings ==="
          python create_issues.py \
            --dir ../../logs/specialist_daily \
            --days 1 \
            --min-score 4 \
            --repo ${{ github.repository }} \
            || echo "âš ï¸ Issue creation failed (non-fatal)"

      - name: Upload Results
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: specialist-results-${{ github.run_number }}
          path: |
            logs/specialist_daily/run_*.json
            logs/specialist_daily/digest_*.md
            logs/specialist_daily/digest_*.json
          retention-days: 30

      - name: Notify n8n (optional)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        continue-on-error: true
        run: |
          # n8n webhook é€šçŸ¥ (è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿)
          if [ -n "${{ secrets.N8N_WEBHOOK_URL }}" ]; then
            DIGEST_FILE=$(ls -t logs/specialist_daily/digest_*.json 2>/dev/null | head -1)
            if [ -n "$DIGEST_FILE" ]; then
              curl -s -X POST "${{ secrets.N8N_WEBHOOK_URL }}" \
                -H "Content-Type: application/json" \
                -d @"$DIGEST_FILE" \
                --max-time 10 || true
            fi
          fi

      - name: Summary
        run: |
          echo "## ðŸ” Daily Specialist Review Results (v4.0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Target Mode:** ${{ github.event.inputs.target_mode || 'git-diff' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Capacity:** 9 keys Ã— 80 tasks = 720 specialists/day" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º
          DIGEST_MD=$(ls -t logs/specialist_daily/digest_*.md 2>/dev/null | head -1)
          if [ -n "$DIGEST_MD" ]; then
            cat "$DIGEST_MD" >> $GITHUB_STEP_SUMMARY
          elif ls logs/specialist_daily/run_*.json 1> /dev/null 2>&1; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat logs/specialist_daily/run_*.json | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "çµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi
