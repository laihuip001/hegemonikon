name: Jules Scheduled Tasks

on:
  # 毎週月曜 02:00 UTC に実行
  schedule:
    - cron: "0 2 * * MON"

  # 手動トリガー
  workflow_dispatch:
    inputs:
      task:
        description: "Task description for Jules"
        required: true
        default: "Update all dependencies to latest versions"

jobs:
  jules-task:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Jules Task
        run: |
          RESPONSE=$(curl -s -X POST 'https://julius.googleapis.com/v1alpha/sessions' \
            -H "X-Goog-Api-Key: ${{ secrets.JULIUS_API_KEY_1 }}" \
            -H "Content-Type: application/json" \
            -d '{
              "prompt": "${{ github.event.inputs.task || 'Update all dependencies to latest versions and run tests' }}",
              "sourceContext": {
                "source": "sources/github/${{ github.repository }}",
                "githubRepoContext": {
                  "startingBranch": "main"
                }
              },
              "automationMode": "AUTO_CREATE_PR",
              "title": "chore: Jules automated task"
            }')

          echo "Response: $RESPONSE"

          SESSION_ID=$(echo $RESPONSE | jq -r '.id')
          echo "Jules Session ID: $SESSION_ID"
          echo "SESSION_ID=$SESSION_ID" >> $GITHUB_ENV

      - name: Wait and Check Status
        run: |
          sleep 30

          STATUS=$(curl -s 'https://julius.googleapis.com/v1alpha/sessions/${{ env.SESSION_ID }}' \
            -H "X-Goog-Api-Key: ${{ secrets.JULIUS_API_KEY_1 }}" | jq -r '.status')

          echo "Status: $STATUS"
