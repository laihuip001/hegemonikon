# HegemonikÃ³n Test Suite
#
# Runs the full pytest suite on push and PR.
# CPU-only: GPU-dependent tests (embedding, LLM) are mocked or skipped.
#
# Test count: ~1900+ (as of 2026-02-08)

name: Tests

on:
    push:
        branches: [master, main]
        paths:
            - "mekhane/**"
            - "hermeneus/**"
            - "synergeia/**"
            - "scripts/**"
            - "kernel/**"
            - "tests/**"
            - "pyproject.toml"
            - "requirements.txt"
    pull_request:
        branches: [master, main]
    workflow_dispatch:

jobs:
    test:
        name: "ðŸ§ª Python Tests"
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  # Install core test dependencies (CPU-only)
                  # 1. Install PyTorch CPU-only first
                  pip install torch --index-url https://download.pytorch.org/whl/cpu
                  # 2. Install remaining dependencies from PyPI
                  pip install pytest pytest-asyncio pytest-timeout pyyaml pydantic lancedb numpy scipy \
                              networkx pandas tabulate requests httpx schedule \
                              sentence-transformers aiohttp opentelemetry-api opentelemetry-sdk aioresponses \
                              python-dotenv
                  # Install project in development mode if setup exists
                  pip install -e ".[test]" 2>/dev/null || true

            - name: Run tests
              env:
                  PYTHONPATH: "."
                  # Skip GPU-dependent tests
                  CUDA_VISIBLE_DEVICES: ""
                  HF_HUB_OFFLINE: "1"
                  TRANSFORMERS_OFFLINE: "1"
              run: |
                  python -m pytest \
                    --tb=short \
                    -q \
                    --timeout=60 \
                    -x \
                    --ignore=mekhane/peira/scripts \
                    2>&1

            - name: Test Summary
              if: always()
              run: |
                  echo "## Test Results" >> $GITHUB_STEP_SUMMARY
                  python -m pytest --tb=no -q 2>&1 | tail -1 >> $GITHUB_STEP_SUMMARY || true
