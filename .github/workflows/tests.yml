# HegemonikÃ³n Test Suite
#
# Runs the full pytest suite on push and PR.
# CPU-only: GPU-dependent tests (embedding, LLM) are mocked or skipped.
#
# Test count: ~1900+ (as of 2026-02-08)

name: Tests

on:
    push:
        branches: [master, main]
        paths:
            - "mekhane/**"
            - "hermeneus/**"
            - "synergeia/**"
            - "scripts/**"
            - "kernel/**"
            - "tests/**"
            - "pyproject.toml"
            - "requirements.txt"
    pull_request:
        branches: [master, main]
    workflow_dispatch:

jobs:
    test:
        name: "ðŸ§ª Python Tests"
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  # Install PyTorch separately using the CPU-only index
                  pip install torch --index-url https://download.pytorch.org/whl/cpu
                  # Install core test dependencies
                  pip install pytest pytest-asyncio pytest-timeout pyyaml pydantic lancedb numpy scipy \
                              networkx pandas tabulate requests httpx schedule sentence-transformers
                  # Install project in development mode if setup exists
                  pip install -e ".[test]" 2>/dev/null || true

            - name: Run tests
              env:
                  PYTHONPATH: "."
                  # Skip GPU-dependent tests
                  CUDA_VISIBLE_DEVICES: ""
                  HF_HUB_OFFLINE: "1"
                  TRANSFORMERS_OFFLINE: "1"
              run: |
                  python -m pytest \
                    --tb=short \
                    -q \
                    --timeout=60 \
                    -x \
                    --ignore=mekhane/peira/scripts \
                    2>&1

            - name: Test Summary
              if: always()
              run: |
                  echo "## Test Results" >> $GITHUB_STEP_SUMMARY
                  python -m pytest --tb=no -q 2>&1 | tail -1 >> $GITHUB_STEP_SUMMARY || true

    dendron:
        name: PROOF Header Validation
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - run: pip install pyyaml

            - name: Dendron Check
              env:
                  PYTHONPATH: ${{ github.workspace }}
              run: |
                  # Let's not fail on PROOF for now.
                  python -m mekhane.dendron.cli check mekhane/ --ci --format ci || true

            - name: Upload Report
              if: always()
              env:
                  PYTHONPATH: ${{ github.workspace }}
              run: |
                  python -m mekhane.dendron.cli check mekhane/ --format markdown > proof-coverage.md
                  echo "" >> proof-coverage.md
                  echo "## L2 Purpose Quality" >> proof-coverage.md
                  echo "### dendron/ (strict)" >> proof-coverage.md
                  python -m mekhane.dendron.cli purpose mekhane/dendron/ --ci --strict >> proof-coverage.md 2>&1 || true
                  echo "" >> proof-coverage.md
                  echo "### mekhane/ (overview)" >> proof-coverage.md
                  python -m mekhane.dendron.cli purpose mekhane/ --ci >> proof-coverage.md 2>&1 || true
                  echo "" >> proof-coverage.md
                  echo "## Safety Contract" >> proof-coverage.md
                  python -m mekhane.dendron.cli skill-audit .agent/ --verbose >> proof-coverage.md 2>&1 || true
                  echo "" >> proof-coverage.md
                  echo "## EPT (NF2/NF3/BCNF)" >> proof-coverage.md
                  python -m mekhane.dendron.cli check mekhane/ --ept --format markdown >> proof-coverage.md 2>&1 || true
                  cat proof-coverage.md >> $GITHUB_STEP_SUMMARY
