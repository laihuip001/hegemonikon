# Antigravity @ メンション機能 検証プロトコル

> **目的**: Antigravity の @ 構文が実際にどう動くかを検証し、Prompt-Lang v2 `@context` 実装への入力とする

---

## 検証環境

- **IDE**: Antigravity (VS Code ベース)
- **ワークスペース**: `M:\Hegemonikon`
- **日時**: 2026-01-24

---

## 検証項目

### 1. ファイル参照 `@file`

| # | アクション | 期待 | 結果 |
|---|------------|------|------|
| 1.1 | `@kernel/doctrine.md を要約して` | ファイル内容を読み込んで要約 | ✅ PASS |
| 1.2 | `@forge/prompt-lang/prompt_lang.py の主要な関数を列挙して` | コード解析して関数リスト | 未実施 |
| 1.3 | 巨大ファイル（1000行超）を `@` で参照 | 部分抽出 or エラー | 未実施 |

### 2. ディレクトリ参照 `@dir`

| # | アクション | 期待 | 結果 |
|---|------------|------|------|
| 2.1 | `@kernel/ 配下のファイル構造を教えて` | ディレクトリ一覧 | 未実施 |
| 2.2 | `@.agent/skills/ を分析して` | 再帰的にスキル構造を把握 | 未実施 |
| 2.3 | 大規模ディレクトリ `@node_modules/` を参照 | レート制限 or 警告 | 未実施 |

### 3. 会話履歴参照 `@conv`

| # | アクション | 期待 | 結果 |
|---|------------|------|------|
| 3.1 | UI で過去会話タイトルを `@` で選択 | サジェストに過去会話が出る | ✅ PASS |
| 3.2 | 選択後、その会話の内容を参照できるか | サマリ or 詳細が注入される | ✅ PASS (ID+タイトル) |
| 3.3 | 別ワークスペースの会話も参照可能か | リーク挙動の確認 | 未実施 |

### 4. MCP 参照 `@mcp`

| # | アクション | 期待 | 結果 |
|---|------------|------|------|
| 4.1 | `@mcp:gnosis で「transformer」を検索して` | gnosis MCP のツール呼び出し | ✅ PASS |
| 4.2 | 未登録 MCP を `@` で参照 | エラーメッセージ | 未実施 |

### 5. Knowledge / Artifacts

| # | アクション | 期待 | 結果 |
|---|------------|------|------|
| 5.1 | 新規チャット開始時のヘッダを観察 | 会話サマリ自動注入の確認 | 未実施 |
| 5.2 | Planning モードで Artifact 生成後、次のターンで参照されるか | Artifact が文脈に入る | 未実施 |

---

## 検証結果詳細 (2026-01-24)

### 1.1 ファイル参照

```yaml
検証: 1.1 ファイル参照（小）
入力: "@kernel/doctrine.md を要約して"
観察:
  - ファイルサジェスト: あり（@doctrine.md として表示）
  - 内容読み込み: エージェントが view_file ツールで読み込み
  - 自動注入: なし（明示的なツール呼び出しが必要）
判定: PASS
備考: |
  @ はファイルを「読むべき」というヒントを渡すが、
  全文がプロンプトに自動注入されるわけではない。
  エージェントが判断してツールを呼ぶ設計。
```

### 3.1-3.2 会話履歴参照

```yaml
検証: 3.1-3.2 会話履歴参照
入力: "@[conversation:\"Prompt-Lang V2 And Legacy Integration\"] で決めた設計方針を要約して"
観察:
  - サジェスト: あり（過去会話タイトルが候補に表示）
  - 選択可能: あり
  - メタデータ注入: あり
    - Conversation ID: 6edf09c7-3a42-41e2-ab42-301d22fb36ee
    - Title: Prompt-Lang V2 And Legacy Integration
  - 構文: @[conversation:"タイトル"] 形式
判定: PASS
備考: |
  会話全文ではなく、ID + タイトルがメタデータとして渡される。
  エージェントは boot 時のサマリー情報を参照して回答可能。
  Prompt-Lang v2 の @context:conv: と互換性あり。
```

### 4.1 MCP 参照

```yaml
検証: 4.1 MCP参照
入力: "@mcp:gnosis: で「transformer」を検索して"
観察:
  - MCP呼び出し: 成功
  - 結果: 5件の論文（arXiv, OpenAlex）
  - 構文: @mcp:gnosis: でMCPサーバーを指定
判定: PASS
備考: |
  Antigravity は @mcp:server: 構文でMCPサーバーを明示的に指定可能。
  エージェントは対応する MCP ツールを呼び出して処理。
  Prompt-Lang v2 の @context:mcp: と互換性あり。
```

---

## 検証手順

### Step 1: ファイル参照

1. 新規チャットを開始
2. 「`@kernel/doctrine.md を要約して`」と入力
3. `@` 入力時にファイルサジェストが出るか確認
4. 応答を観察し、ファイル内容を読み込んだ証拠を記録

### Step 2: 会話参照

1. 別のチャットで意図的な決定を行う（例: 「API設計は REST でなく GraphQL を採用」）
2. 新規チャットを開始
3. `@` を入力し、過去会話がサジェストに出るか確認
4. 選択後、その決定が反映されるか確認

### Step 3: コンテキストリーク検証

1. ワークスペース A で機密情報を含む会話を行う
2. ワークスペース B で新規チャットを開始
3. ワークスペース A の情報がにじみ出るか観察

---

## 記録フォーマット

各検証項目について以下を記録:

```yaml
検証: 1.1 ファイル参照（小）
入力: "@kernel/doctrine.md を要約して"
応答: |
  [応答内容をここに貼り付け]
観察:
  - ファイルサジェスト: あり/なし
  - 内容読み込み: 全文/部分/なし
  - トークン消費: 軽い/重い（体感）
判定: PASS / FAIL / PARTIAL
備考: |
  [その他の観察]
```

---

## 次のアクション

1. [x] 検証実施（基本3項目完了）
2. [x] 結果を docs/research/ に記録
3. [ ] Prompt-Lang v2 パーサー `_parse_context_content()` 実装
4. [ ] 残り検証項目（ディレクトリ、リーク、Knowledge）
