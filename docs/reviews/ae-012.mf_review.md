# 視覚リズムの指揮者 レビュー

## 対象ファイル
`mekhane/symploke/boot_integration.py`

## 判定
発言（要改善）

## 発見事項
- 関数サイズの不均一 (Medium): `generate_boot_template` (約90行) が他の関数 (平均 ~50行) と比較して突出して長い。
- 波形の乱れ (Low): `_load_skills` (lines 160-179) において、ループ内の深いネスト (4-5段: for -> if -> if -> try) が発生し、視覚的なリズムを崩している。
- 視覚的な重心の偏り (Low): `postcheck_boot_report` (lines 482-487) の f-string 内に複雑な条件分岐が含まれており、行が右側に大きく偏っている。

## 修正案

### 1. `_load_skills` のネスト解消 (Early Return / Helper Extraction)

```python
def _load_single_skill(skill_dir: Path) -> Optional[dict]:
    """Load a single skill from directory."""
    skill_md = skill_dir / "SKILL.md"
    if not skill_dir.is_dir() or not skill_md.exists():
        return None

    try:
        content = skill_md.read_text(encoding="utf-8")
        # ... (parse logic) ...
        return {
            "name": name,
            "dir": skill_dir.name,
            "path": str(skill_md.resolve()),
            "description": description,
            "body": body,
        }
    except Exception:
        return None

def _load_skills(project_root: Path) -> dict:
    # ...
    skills = []
    skill_paths = []
    for skill_dir in sorted(skills_dir.iterdir()):
        skill = _load_single_skill(skill_dir)
        if skill:
            skills.append(skill)
            skill_paths.append(skill["path"])
    # ...
```

### 2. `generate_boot_template` の分割

```python
def _append_handoff_section(lines: list, handoffs: dict):
    lines.append("## Handoff 個別要約")
    lines.append("<!-- REQUIRED: 各 Handoff の S/A/R を1行以上 -->")
    lines.append("")
    # ... handoff logic ...

def _append_ki_section(lines: list, ki_items: list):
    lines.append("## KI 深読み")
    lines.append("<!-- REQUIRED: サマリー引用 + 自分の解釈を記述 -->")
    lines.append("")
    # ... ki logic ...

def generate_boot_template(result: dict) -> Path:
    # ...
    _append_handoff_section(lines, result.get("handoffs", {}))
    _append_ki_section(lines, result.get("ki", {}).get("ki_items", []))
    # ...
```

### 3. `postcheck_boot_report` の重心調整

```python
    # 複雑な条件を一時変数に抽出して右への偏りを解消
    fill_msg = ""
    if fill_remaining > 0:
        fill_msg = f" (fill_penalty: {fill_remaining} FILL remaining)"

    adj_keys = [k for k, v in adjunction_indicators.items() if v]
    adj_msg = f" ({', '.join(adj_keys)})" if adj_keys else ""

    if epsilon_count > 0:
        detail_msg = (
            f"Adjunction L⊣R: ε={epsilon_precision:.0%}, Drift={drift:.0%}"
            f"{fill_msg}{adj_msg}"
        )
    else:
        detail_msg = "Adjunction L⊣R: ε=0%, Drift=100% (no context restoration detected)"

    checks.append({
        "name": "adjunction_metrics",
        "passed": True,
        "detail": detail_msg,
    })
```

## 重大度
Medium
