# 専門家レビュー: Logic ハルシネーション検出者

## 概要
* **対象ファイル**: `mekhane/symploke/jules_client.py`
* **レビュー担当**: Logic Hallucination Detector (AI-004)

## 分析結果

### 1. HTTPセッション管理のハルシネーション (パフォーマンス/リソース)
* **発見**: `get_session` および `create_session` メソッド内で `async with aiohttp.ClientSession() as session:` を使用し、リクエストごとに新しいセッションを作成・破棄している。
* **ロジック欠陥**: `poll_session` メソッドはこの `get_session` をループ内で呼び出す。`batch_execute` はこれを並行実行する。コードは非同期 (`async/await`) で記述されているため「高速」に見えるが、実際には TCP コネクションの確立・切断のオーバーヘッドがリクエスト毎に発生し、Keep-Alive の恩恵を全く受けていない。これは `aiohttp` の設計思想（セッションの再利用）に対する「論理的な誤解（ハルシネーション）」である。
* **重大度**: High

### 2. 状態解析の隠蔽 (エラーハンドリング)
* **発見**: `parse_state` 関数において、`ValueError` が発生した場合に `SessionState.IN_PROGRESS` を返している。
* **ロジック欠陥**: 未知の状態（APIの仕様変更やエラーメッセージなど）をすべて「進行中」と解釈してしまう。これにより、API が致命的なエラー文字列を返していても、クライアントはタイムアウトまでポーリングを続け、真のエラー原因を隠蔽する。正常に動作しているという「偽の信念」をシステムに植え付けるロジックである。
* **重大度**: High

### 3. 架空APIへの依存 (存在論的ハルシネーション)
* **発見**: `https://jules.googleapis.com/v1alpha` というエンドポイントを使用している。
* **ロジック欠陥**: 現時点での公開情報において、Google Cloud は "Jules" という名称の公開 API を提供していない可能性が高い（あるいは非公開プレビュー）。コードはこの API が特定のスキーマ（`sourceContext`, `automationMode` 等）を持って実在することを前提に構築されているが、これが実在しない場合、このコード全体が機能しない「幻想」に基づいていることになる。
* **重大度**: Critical

### 4. バッチ処理における識別子の喪失 (データ整合性)
* **発見**: `batch_execute` 内の `bounded_execute` において、例外発生時に `id=""` (空文字) を持つ `JulesSession` を返している。
* **ロジック欠陥**: 失敗したセッションをリストに含めて返す設計は良いが、ID を空にすることで、呼び出し元がどのタスクが失敗したのかを追跡したり、ログに記録したりする手段（Prompt以外）を失う。特に再試行ロジックを組む際に支障をきたす。
* **重大度**: Medium

## 推奨事項
1.  **セッションのライフサイクル修正**: `JulesClient` の `__init__` で `ClientSession` を作成し、`close` メソッドで閉じる、あるいはコンテキストマネージャとしてクラスを設計し、リクエスト間で接続を再利用すること。
2.  **厳格な状態解析**: `parse_state` で未知の値が来た場合は、`IN_PROGRESS` ではなく `UNKNOWN` または例外として扱い、ポーリングループが即座に異常を検知できるようにすること。
3.  **API実在性の確認**: API ドキュメントを確認し、エンドポイントとリクエストスキーマが正しいか検証すること。モックテストだけでなく、実際の接続テストが必要。
4.  **エラー情報の保持**: バッチ処理の例外ハンドリング時に、可能な限り元のコンテキスト情報を保持し、単なる空文字 ID を避けること。

## 沈黙の判断 (Silence Judgment)
**Speak**. このコードは構文的には正しいが、非同期IOの利点を殺す実装や、エラーを無限ループに変えるロジックが含まれており、実運用において重大なパフォーマンス問題やデバッグ困難な状況を引き起こす。
