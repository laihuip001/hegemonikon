# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/api/server.py`

## 判定
発言（要改善）

## 発見事項
- **ルーター定義の不統一 (High)**
  - `mekhane/api/routes/ccl.py` は `APIRouter(tags=["ccl"])` と定義され、内部パスで `/ccl/parse` のようにプレフィックスをハードコードしている。一方、他のルーター（例: `dendron.py`, `fep.py`）は `APIRouter(prefix="/dendron")` のようにコンストラクタでプレフィックスを指定している。
  - `server.py` は一律に `app.include_router(..., prefix=API_PREFIX)` でマウントしているため、`ccl` だけが実装パターンが異なり、将来的なルート変更や再利用時にパス解決の不整合（`prefix` の二重適用や欠落）を招くリスクがある。

- **モジュールの内部実装（重量/軽量）に関する過剰な仮定 (Medium)**
  - `_register_routers` 関数内で `gnosis`, `ccl`, `pks` などを「遅延ロード対象（heavy/risky）」として `try-except` ブロックで囲んでいる。
  - しかし、これらのモジュール自体（例: `gnosis.py`, `ccl.py`）は既に内部で重い依存関係（`GnosisIndex`, `hermeneus` 等）を遅延インポートしており、モジュール自体のインポートは軽量かつ安全である。
  - `server.py` が「このモジュールは重い/危険だ」と決めつけて防御的ロードを行うのは、モジュールの内部実装に対する古い仮定に基づいている。これにより、単純な `SyntaxError` や `ImportError`（依存関係ではなくコードミスによるもの）が警告のみで握りつぶされ、発見が遅れる可能性がある。

- **グローバルな副作用と例外処理 (Medium)**
  - `sys.path.insert(0, ...)` によるモジュールレベルでのパス変更は、このファイルをインポートするだけで実行環境全体に影響を与える（特にテスト環境）。
  - `_cleanup_stale_socket` 関数内で `sys.exit(1)` を呼び出している。これはライブラリ関数としての再利用性を著しく低下させ、予期せぬプロセス終了を招く恐れがある（例外を送出すべき）。

## 重大度
High
