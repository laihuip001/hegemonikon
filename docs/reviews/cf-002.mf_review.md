# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/pks/feedback.py`

## 判定
発言（要改善）

## 発見事項
- **Implicit Series Assumption (Ghost Feedback) - High Severity**
  - **問題**: `FeedbackCollector.record` は `series` 引数として任意の文字列（空文字含む）を受け入れますが、`adjust_threshold` メソッドは特定のシリーズID（"O", "S", "H", "P", "K", "A"）を前提としたロジックで動作します。
  - **現状**: `pks_engine.py` の `record_feedback` は、コンテキストがない場合（特に CLI からの手動フィードバック `pks feedback` 時）に `series=""` を渡すことがあります。このフィードバックは記録されますが、どのシリーズの閾値調整にも寄与しない「ゴーストデータ」となり、ユーザーのフィードバックが無意味化されています。
  - **修正提案**:
    ```python
    # mekhane/pks/feedback.py
    def record(self, feedback: PushFeedback) -> None:
        if not feedback.series:
            # デフォルトシリーズへの割り当て、またはエラーログ出力
            feedback.series = "O"
        # ...
    ```
    または `PushFeedback.__post_init__` で `series` の必須検証を行うべきです。

- **Hardcoded Constant Assumption (`base_threshold`) - Medium Severity**
  - **問題**: `FeedbackCollector.get_stats` メソッド内で、閾値調整量を算出する際に `self.adjust_threshold(series) - 0.65` と、`0.65` という定数をハードコードしています。
  - **現状**: `PKSEngine` は初期化時に `threshold` 引数（デフォルト 0.65）を受け取り、これを `base_threshold` として使用します。もしユーザーが `threshold=0.8` などに変更した場合、`get_stats` が報告する調整値は実際のエンジン動作（ベースからの変動）と乖離します。特にクランプ処理 `max(0.3, min(0.9, ...))` が絡む場合、絶対値としての閾値と相対的な調整幅の意味が混同されます。
  - **修正提案**:
    ```python
    # mekhane/pks/feedback.py
    class FeedbackCollector:
        def __init__(self, persist_path: Optional[Path] = None, base_threshold: float = 0.65):
            self.base_threshold = base_threshold
            # ...

        def get_stats(self) -> dict[str, dict]:
            # ...
            "threshold_adjustment": self.adjust_threshold(series, self.base_threshold) - self.base_threshold,
    ```

## 重大度
High
