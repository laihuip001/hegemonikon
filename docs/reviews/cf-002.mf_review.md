# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/api/server.py`

## 判定
発言（要改善）

## 発見事項
- [High] モジュールレベルでの `sys.path` 副作用
  - `server.py` のトップレベルで `sys.path.insert(0, ...)` を実行している。これにより、このモジュールをインポートするだけでグローバルなインタプリタ状態（`sys.path`）が変更される。これは、他のインポート解決挙動に影響を与える暗黙の副作用である。
  - 修正提案: `sys.path` 操作を `main()` 関数内または `if __name__ == "__main__":` ブロック内に移動する。

- [High] 外部モジュール `scripts/wf_postcheck.py` への暗黙の依存
  - `mekhane` パッケージ外にある `scripts` ディレクトリ内のモジュールに依存しており、`sys.path` 操作なしではインポートできない構造になっている。`mekhane` パッケージ単体での動作を阻害する。
  - 修正提案: `scripts` を `mekhane` パッケージ内に移動するか、適切なパッケージ構造に再編成する。

- [Medium] ヘルパー関数内の `sys.exit(1)`
  - `_cleanup_stale_socket` 関数内で、エラー時に `sys.exit(1)` を呼び出している。ライブラリとしてインポート可能なモジュールがプロセスを強制終了させることは、呼び出し元（テストランナーや他のツール）に対する契約違反である。
  - 修正提案: `sys.exit(1)` の代わりに例外（`RuntimeError` 等）を送出し、呼び出し元でキャッチして制御する。

- [Low] `uvicorn.run` の文字列参照
  - `uvicorn.run("mekhane.api.server:app", ...)` とハードコードされた文字列を使用しており、ファイル名や変数名の変更に追従できない自己参照的な暗黙契約である。
  - 修正提案: `reload=True` の場合はやむを得ないが、コメント等でファイル名との同期を明示するか、テストで検証可能な状態にする。

- [Low] ルーターの脆弱な遅延ロード
  - `_register_routers` 内で多数のルーターを `try-except Exception` で囲んでインポートしている。`ImportError` 以外の予期せぬエラー（内部ロジックエラー等）も握りつぶしてしまう可能性がある。
  - 修正提案: `ImportError` または `ModuleNotFoundError` に限定してキャッチするか、エラーログを詳細（スタックトレース含む）に出力する。

## 重大度
High
