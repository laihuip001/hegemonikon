# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/export_chats.py`

## 判定
発言（要改善）

## 発見事項
- **環境固有パスのハードコード (Critical)**: `DEFAULT_OUTPUT_DIR` が `/home/makaron8426/oikos/mneme/.hegemonikon/sessions` に固定されており、特定のユーザー環境を前提としている。他のユーザーやCI環境で動作しない。
  - **提案**: `pathlib.Path.home()` を使用するか、環境変数 `ANTIGRAVITY_SESSION_DIR` を参照する。
  ```python
  # 修正案
  import os
  DEFAULT_OUTPUT_DIR = Path(os.environ.get("ANTIGRAVITY_SESSION_DIR", Path.home() / "oikos/mneme/.hegemonikon/sessions"))
  ```

- **外部アプリケーションDOM構造への依存 (High)**: `button.select-none`, `.flex.flex-col.gap-y-3.px-4.relative`, `jetski-agent` などのCSSセレクタに依存している。これらは外部アプリケーション（Antigravity IDE）の内部構造であり、変更されると機能が停止する。
  - **提案**: セレクタを定数として定義し、外部契約であることを明示する。また、要素が見つからない場合の警告ログを強化する。
  ```python
  # 修正案
  # External Contract: Antigravity IDE DOM Selectors (Subject to change)
  SELECTOR_CONVERSATION_BTN = "button.select-none"
  SELECTOR_MESSAGE_CONTAINER = ".flex.flex-col.gap-y-3.px-4.relative"
  ```

- **外部ポートの固定 (Medium)**: `CDP_PORT` が `9222` に固定されている。環境によってはポートが異なる可能性がある。
  - **提案**: 環境変数 `CDP_PORT` を参照できるようにする。
  ```python
  # 修正案
  CDP_PORT = int(os.environ.get("CDP_PORT", 9222))
  ```

## 重大度
Critical
