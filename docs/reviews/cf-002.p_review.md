# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/pks/push_dialog.py`

## 判定
発言（要改善）

## 発見事項
- **関連度スコア計算ロジックの不一致 (High)**
  - `push_dialog.py` の `related()` メソッド内で `relevance_score = 1.0 - distance` と計算しているが、`pks_engine.py` の `RelevanceDetector.score()` では `max(0.0, 1.0 - (distance / 2.0))` というロジックを使用している。
  - これにより、同じ「関連度」という指標でありながら、エンジン経由とダイアログ経由で数値の尺度が異なっており、ユーザーに混乱を与える可能性がある。
- **GnosisIndex 設定の無視 (High)**
  - `related()` メソッド内で `GnosisIndex()` を引数なしでインスタンス化している。
  - `PKSEngine` は `lance_dir` を引数で受け取り、非デフォルトのインデックス位置を指定可能だが、`PushDialog` はその設定を無視して常にデフォルト位置を参照してしまう。
  - これにより、カスタム設定で運用されている環境では `related()` が機能しない、または誤ったデータを参照する危険がある。
- **ロジックの重複 (Medium)**
  - `related()` メソッドは検索結果を `KnowledgeNugget` オブジェクトに変換する処理を独自に実装しており、`pks_engine.py` のロジックと重複している。
  - `KnowledgeNugget` の構造変更や正規化ロジックの変更があった際、両方のファイルを修正する必要があり、保守性が低下している。

## 重大度
High
