# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/pks/feedback.py`

## 判定
発言（要改善）

## 発見事項
- **`PushFeedback.reaction` の非Enum化 (High)**
  - `reaction` フィールドは `str` 型だが、実際には `REACTION_WEIGHTS` のキー ("used", "deepened", "dismissed", "ignored") に依存している。
  - 呼び出し側 (`PKSEngine` 等) が誤った文字列 ("liked" 等) を渡してもエラーにならず、静かに重み 0.0 として処理される。
  - 定義と利用の間の契約が暗黙的であり、コンパイラや型チェッカーで検証できない。

- **`PushFeedback.series` の非Enum化 (Medium)**
  - `series` も `str` 型だが、Attractor Series ("O", "S", "H", "P", "K", "A") を想定していると思われる。
  - 任意の文字列を受け入れるため、タイポやフォーマット違い ("k" vs "K") が別々のエントリとして集計される恐れがある。

- **永続化データ構造との暗黙的結合 (High)**
  - `record` メソッドは `asdict(feedback)` を用いて `PushFeedback` の構造をそのまま JSON に保存している。
  - `_load` は `list[dict]` として読み込むのみで、スキーマ移行やバリデーションがない。
  - `PushFeedback` のフィールド名や構造を変更すると、過去の保存データと不整合が生じ、将来的に読み込み側で `KeyError` や意図しない挙動を引き起こす「時限爆弾」となる。

- **環境への暗黙的依存 (Medium)**
  - `DEFAULT_PATH` が `Path.home() / "oikos/mneme/..."` にハードコードされている。
  - 実行環境（コンテナ、CI、別のユーザー環境）におけるディレクトリ構造という「外部システムとの契約」を勝手に仮定している。

## 重大度
High
