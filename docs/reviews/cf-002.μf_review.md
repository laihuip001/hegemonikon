# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/pks/push_dialog.py`

## 判定
発言（要改善）

## 発見事項
- **[High] Dataclassフィールド未対応 (KnowledgeNugget)**
  - `pks_engine.py` の `KnowledgeNugget` 定義には `url` (Optional[str]) および `authors` (Optional[str]) フィールドが存在するが、`push_dialog.py` の `related` メソッドでのインスタンス化時にこれらが無視されている。`GnosisIndex` の検索結果にはこれらの情報が含まれているため、マッピングすべきである。
  - **推奨修正**:
    ```python
    # mekhane/pks/push_dialog.py:145 付近
    nuggets.append(
        KnowledgeNugget(
            title=title,
            source=r.get("source", "unknown"),
            relevance_score=1.0 - r.get("_distance", 0.5),
            abstract=r.get("abstract", ""),
            url=r.get("url"),          # 追加
            authors=r.get("authors"),  # 追加
            push_reason="関連知識",
        )
    )
    ```

- **[High] Dataclassフィールド未対応 (KnowledgeNugget 表示/プロンプト)**
  - `_why_template` メソッド、`_WHY_PROMPT`、`_DEEPER_PROMPT` において、`KnowledgeNugget` オブジェクトが持つ `url` や `authors` 情報が利用されていない。特に `url` は参照元へのアクセスに重要であり、`authors` は信頼性評価に重要であるため、これらを含めるべきである。
  - **推奨修正**:
    - `_why_template`: `lines` に `url` (論文リンク) や `authors` を追加。
    - `_WHY_PROMPT` / `_DEEPER_PROMPT`: `{url}` や `{authors}` プレースホルダーを追加し、`format` 引数で渡す。

## 重大度
High
