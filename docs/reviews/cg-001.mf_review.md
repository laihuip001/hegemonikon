# ãƒã‚¹ãƒˆæ·±åº¦è­¦å ±è€… ãƒ¬ãƒ“ãƒ¥ãƒ¼

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`mekhane/anamnesis/gnosis_chat.py`

## åˆ¤å®š
ç™ºè¨€ï¼ˆè¦æ”¹å–„ï¼‰

## ç™ºè¦‹äº‹é …
- [High] `GnosisChat.interactive` (L539-L547): `while` -> `if` -> `for` -> `if` (4 levels).
- [High] `GnosisChat.interactive` (L549-L563): `while` -> `if` -> `if` -> `for` (4 levels).
- [Medium] `KnowledgeIndexer.discover_knowledge_files` (L202-L209): `if` -> `if` -> `for` (3 levels).
- [Medium] `KnowledgeIndexer._chunk_text` (L235-L243): `while` -> `if` -> `if` (3 levels).
- [Medium] `GnosisChat._retrieve` (L407-L413): `if` -> `if` -> `for` (3 levels).

## é‡å¤§åº¦
High

## ä¿®æ­£ææ¡ˆ

### 1. `GnosisChat.interactive` (L539-L563) - Extract Methods
`interactive` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚’åˆ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«æŠ½å‡ºã™ã‚‹ã“ã¨ã§ã€`while` ãƒ«ãƒ¼ãƒ—å†…ã®ãƒã‚¹ãƒˆã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

```python
    def _handle_sources_command(self, last_result: dict):
        if not last_result:
            return

        print("\nğŸ“š Sources:")
        for i, s in enumerate(last_result["sources"], 1):
            icon = {"papers": "ğŸ“„", "knowledge": "ğŸ§ "}.get(s["table"], "ğŸ“")
            print(f"  [{i}] {icon} [{s['source']}] {s['title']}")
            print(f"      Relevance: {s['relevance']}")
            if s["url"]:
                print(f"      {s['url']}")

    def _handle_stats_command(self):
        self._load_index()
        stats = self._index.stats()
        print(f"\nğŸ“Š Papers: {stats['total']}")
        for src, cnt in stats.get("sources", {}).items():
            print(f"   {src}: {cnt}")

        # Knowledge table stats
        if "knowledge" in self._index.db.table_names():
            kt = self._index.db.open_table("knowledge")
            kdf = kt.to_pandas()
            print(f"\nğŸ§  Knowledge chunks: {len(kdf)}")
            for src, cnt in kdf["source"].value_counts().items():
                print(f"   {src}: {cnt}")

    def interactive(self):
        # ... (ç•¥) ...
        while True:
            # ... (ç•¥) ...
            if question == "/sources":
                self._handle_sources_command(last_result)
                continue

            if question == "/stats":
                self._handle_stats_command()
                continue
            # ...
```

### 2. `KnowledgeIndexer.discover_knowledge_files` (L202-L209) - Flatten Logic
`if` ã®ãƒã‚¹ãƒˆã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã™ã‚‹ã‹ã€ã‚¬ãƒ¼ãƒ‰ç¯€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
        # 6. Kernel docs
        if KERNEL_DIR.exists():
            for f in sorted(KERNEL_DIR.glob("*.md")):
                files.append({
                    "path": f,
                    "source_type": "kernel",
                    "title": f.stem.replace("_", " ").title(),
                })

        # CEP (Flattened)
        cep_dir = KERNEL_DIR / "cep"
        if cep_dir.exists():
            for f in sorted(cep_dir.glob("*.md")):
                files.append({
                    "path": f,
                    "source_type": "kernel",
                    "title": f"CEP: {f.stem}",
                })
```

### 3. `KnowledgeIndexer._chunk_text` (L235-L243) - Guard Clause / Helper Method
ãƒ¡ã‚½ãƒƒãƒ‰æŠ½å‡º `_adjust_chunk_end` ã‚’ä½¿ç”¨ã—ã¦ãƒã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚

```python
    def _adjust_chunk_end(self, text: str, start: int, end: int, chunk_size: int) -> int:
        if end >= len(text):
            return end

        chunk = text[start:end]
        last_nl = chunk.rfind("\n")
        if last_nl > chunk_size // 2:
            return start + last_nl + 1
        return end
```

### 4. `GnosisChat._retrieve` (L407-L413) - Extract Method
`try-except` ãƒ–ãƒ­ãƒƒã‚¯ã”ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã«æŠ½å‡ºã—ã¦ãƒã‚¹ãƒˆã‚’æµ…ãã—ã¾ã™ã€‚

```python
        # Knowledge table
        if self.search_knowledge:
            self._search_knowledge_table(fetch_k, results)

    def _search_knowledge_table(self, fetch_k: int, results: list):
        try:
            if "knowledge" not in self._index.db.table_names():
                return

            embedder = self._index._get_embedder()
            # ...
            for r in k_results:
                r["_source_table"] = "knowledge"
            results.extend(k_results)
        except Exception:
            pass
```
