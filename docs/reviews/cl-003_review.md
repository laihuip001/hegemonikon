# 専門家レビュー: メンタルモデル穴検出者

## タスク
`mekhane/symploke/jules_client.py` の分析

## 分析観点
暗黙的な前提条件を洗い出し

## 発見事項

### 1. 未知のステータスの扱いに関する前提
- **箇所**: `parse_state` 関数および `poll_session` メソッド
- **内容**: `parse_state` は未知のステータス文字列を受け取ると `SessionState.IN_PROGRESS` (進行中) とみなす。また、`poll_session` は `COMPLETED` または `FAILED` 以外を進行中とみなしてポーリングを継続する。
- **暗黙の前提**: API が将来的に `CANCELLED`, `TIMED_OUT`, `REJECTED` などの新しい**終端ステータス**を追加しない、あるいはそれらは稀であると仮定している。
- **リスク**: API が新しい終端ステータスを返した場合、クライアントはそれを進行中と誤認し、タイムアウトまで無駄にポーリングし続けることになる。

### 2. 固定されたタイムアウト設定
- **箇所**: `JulesClient.DEFAULT_TIMEOUT` (300秒 = 5分)
- **内容**: ポーリングのデフォルトタイムアウトが5分に固定されている。
- **暗黙の前提**: すべてのタスク（コード生成、PR作成など）が5分以内に完了すると仮定している。
- **リスク**: 複雑なタスクや Jules 側の負荷が高い場合、処理が正常に進んでいてもタイムアウトエラーとなり、結果を取得できない可能性がある。

### 3. APIプランの前提 (Ultraプラン)
- **箇所**: `JulesClient.MAX_CONCURRENT = 60`
- **内容**: コメントに `# Ultra plan limit` とあり、並列数の上限がハードコードされている。
- **暗黙の前提**: このクライアントの利用者は常に最上位の Ultra プランを利用していると仮定している。
- **リスク**: 下位プランのユーザーが利用した場合、レート制限や同時実行数制限に即座に抵触し、エラーが多発する可能性がある。

### 4. 自動化モードの固定
- **箇所**: `create_session` メソッド内の payload
- **内容**: `"automationMode": "AUTO_CREATE_PR"` がハードコードされている。
- **暗黙の前提**: ユーザーは常に PR 作成を意図しており、単なるコード提案やプランニングのみを求めていないと仮定している。
- **リスク**: PR を作成せずにコードだけ確認したい場合や、別のワークフロー（Issue作成のみ等）に対応できない。

### 5. エラーレスポンス情報の欠落
- **箇所**: `create_session`, `get_session` メソッド
- **内容**: `resp.raise_for_status()` を使用しているが、レスポンスボディの読み取り処理がない（429以外）。
- **暗黙の前提**: HTTP ステータスコードだけでエラーの原因特定が十分である、あるいは API が有用なエラー詳細を JSON で返さないと仮定している。
- **リスク**: API がバリデーションエラーの詳細などを JSON で返していても、それが `HTTPError` に含まれず、デバッグが困難になる。

### 6. バッチ実行時のダミーセッションオブジェクト
- **箇所**: `batch_execute` メソッド内の `bounded_execute`
- **内容**: 例外発生時、ID が空文字 `""` の `JulesSession` オブジェクトを `FAILED` ステータスで返している。
- **暗黙の前提**: 呼び出し元が ID のないセッションオブジェクトを適切にハンドリングできる（あるいは ID を使わない）と仮定している。
- **リスク**: 呼び出し元が `session.id` を使ってログ記録や再試行を行おうとすると不整合が生じたり、後続処理でエラーになる可能性がある。

## 重大度
**中**

- クリティカルなバグではないが、API の仕様変更や利用環境（プラン、タスクの重さ）の変化に対して脆弱である。特にタイムアウトと未知のステータスの扱いは、本番運用において予期せぬ遅延や動作不良を引き起こす可能性が高い。

## 推奨事項

1.  **未知のステータスの安全な処理**: 未知のステータスは `UNKNOWN` として扱い、ポーリングループ内で `UNKNOWN` が長時間続く場合は警告を出すか、あるいは特定の未知のステータスは即時終了させるロジックを検討する（APIドキュメントの確認が必要）。
2.  **タイムアウトの柔軟化**: `DEFAULT_TIMEOUT` をより長めに設定するか、タスクの複雑さに応じて動的に設定できるようにする。または、呼び出し元で明示的に指定することを推奨するドキュメントを追加する。
3.  **設定の外部化**: `MAX_CONCURRENT` や `DEFAULT_TIMEOUT` などの定数を環境変数や設定ファイルから読み込めるようにし、プランに応じた設定変更を可能にする。
4.  **エラーハンドリングの強化**: `raise_for_status()` の前にレスポンスボディを確認し、エラーメッセージがある場合はそれを例外に含めるようにする。
5.  **自動化モードのパラメータ化**: `automationMode` を `create_session` の引数として受け取れるように変更する。

## 沈黙判定
**発言**

- このコードは一見動作するように見えるが、エラー耐性と拡張性に欠ける「メンタルモデルの穴」が存在する。特に外部API依存のコードにおいて、タイムアウトやステータス変更への考慮不足は運用上のリスクとなるため、修正を促すべきである。
