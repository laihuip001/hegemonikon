# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/gnosis_chat.py`

## 判定
発言（要改善）

## 発見事項

### 1. 例外の隠蔽 (High)
`_retrieve` メソッドおよび `KnowledgeIndexer.index_knowledge` において、`try...except Exception: pass` (または `continue`) が多用されており、あらゆる例外を握りつぶしています。
これにより、データベース接続エラーやファイル読み込みエラーが発生しても呼び出し元は検知できず、「検索結果が0件」として扱われるため、システムの状態が予測不能になります。

**該当箇所:**
- `GnosisChat._retrieve`: `except Exception: pass`
- `KnowledgeIndexer.index_knowledge`: `except Exception: pass` (ループ内)

**改善案:**
- 特定の例外 (`FileNotFoundError`, `LanceDBError` 等) のみを捕捉する。
- 予期せぬ例外は上位に伝播させるか、少なくともログ出力を行う。

### 2. 副作用のあるメソッド (High)
`Reranker.rerank` メソッドは、引数として渡された `results` リストをインプレースで変更（`_rerank_score` キーの追加、ソート）しています。
メソッド名は「rerank（再ランク付け）」であり、新しいリストを返すことを示唆しますが、実際には入力オブジェクトの状態を変更しています。
呼び出し元が `results` を再利用する場合、予期せぬ挙動を引き起こす可能性があります。

**該当箇所:**
- `Reranker.rerank`: `results.sort(...)`, `r["_rerank_score"] = ...`

**改善案:**
- 入力リストをコピーして新しいリストを返すか、メソッド名を `rerank_inplace`等に変更する。

### 3. 不透明な戻り値の型 (Medium)
`GnosisChat.ask` や `_retrieve`、`Reranker.rerank` の戻り値が `dict` や `list[dict]` となっています。
辞書のキー（`answer`, `sources`, `_source_table`, `_rerank_score` 等）が実装詳細に依存しており、呼び出し元から構造を予測できません。

**該当箇所:**
- `ask(self, question: str) -> dict`
- `rerank(...) -> list[dict]`

**改善案:**
- `TypedDict` または `dataclass` を定義し、戻り値の構造を明示する。
  ```python
  @dataclass
  class ChatResponse:
      answer: str
      sources: list[Source]
      retrieval_time: float
      ...
  ```

### 4. 暗黙的な状態変更 (Medium)
`GnosisChat.ask` メソッドは、名前からは「質問への回答」のみを期待させますが、内部で `self.history.add(...)` を呼び出し、インスタンスの状態（会話履歴）を更新しています。
Chatボットとしては自然ですが、純粋な問い合せメソッドとしては副作用があります。

**該当箇所:**
- `GnosisChat.ask`: `self.history.add(...)`

**改善案:**
- docstring に副作用（履歴更新）を明記する。

## 重大度
High
