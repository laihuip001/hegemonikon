# 予測誤差審問官 レビュー

## 対象ファイル
`scripts/attractor_dashboard.py`

## 判定
発言（要改善）

## 発見事項
- **Critical**: 指定された `scripts/attractor_dashboard.py` が存在しません。本レビューでは、機能的に等価と推測される `scripts/fep_dashboard.py` を対象として分析を行いました。
- **High (副作用非明示)**: `main` 関数内で `Path.home() / "oikos/hegemonikon/logs"` という外部環境への隠れた依存があります。ホームディレクトリの構造に依存しており、実行環境によって動作が予測不能です。環境変数や引数で明示すべきです。
- **High (副作用非明示)**: `main` 関数が `sys.exit(1)` を直接呼び出しています。これは呼び出し元にとって予期せぬプロセス終了（驚き）となります。例外を発生させ、制御を委譲すべきです。
- **Medium (暗黙状態変更)**: モジュールトップレベルで `sys.path.insert(0, ...)` が実行されています。インポートしただけでグローバルな `sys.path` が変更される副作用があり、他のモジュールへの干渉が予測不能です。
- **Medium (型予測困難)**: `analyze` 関数の戻り値が `dict` 型であり、具体的な構造（キー `entropy_over_time`, `phases` 等）がシグネチャから予測できません。`TypedDict` または `Dataclass` を定義して明示すべきです。
- **Medium (例外隠蔽)**: `load_log` 関数内で `json.JSONDecodeError` を `try-except` で捕捉し、ログ出力なしに `continue` しています。データの不整合が静かに無視されるため、予測誤差の原因特定を困難にします。
- **Low (副作用非明示)**: `main` 関数内で `print` 文による標準出力への副作用が多用されています。ロギング機能を使用するか、出力を分離すべきです。

## 修正提案
```python
# 提案: 依存の注入と型定義による予測可能性の向上

from dataclasses import dataclass
from typing import List, Dict, Optional
import os

@dataclass
class DashboardAnalysis:
    valid_entries: int
    entropy_over_time: List[float]
    # ... 他のフィールドも定義

def load_log(log_path: Path) -> List[dict]:
    entries = []
    with open(log_path) as f:
        for i, line in enumerate(f):
            try:
                entries.append(json.loads(line))
            except json.JSONDecodeError as e:
                # 予測誤差（例外）を隠蔽せず、少なくとも警告する
                print(f"Warning: Malformed JSON at line {i+1}: {e}", file=sys.stderr)
    return entries

def analyze(entries: List[dict]) -> DashboardAnalysis:
    # ... データクラスを返す
    pass

def main(log_path: Optional[str] = None, output_path: Optional[str] = None):
    # Path.home() への依存を排除し、デフォルト値も明示的に扱う
    base_dir = Path(os.getenv("HEGEMONIKON_LOG_DIR", "."))
    # ...
```

## 重大度
Critical
