# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/symploke/boot_integration.py`

## 判定
発言（要改善）

## 発見事項
- **(副作用非明示: High)** `get_boot_context` 関数内で `urllib.request.urlopen` を使用して `http://localhost:5678/webhook/session-start` への Webhook 送信を行っています。関数名 `get_` は副作用のない参照透過な操作を期待させますが、外部システムへの通知という副作用が含まれており、予測可能性を損なっています。
- **(副作用非明示: High)** `print_boot_summary` 関数内で `mode="detailed"` の場合、内部的に `generate_boot_template` を呼び出し `/tmp` 配下にファイルを作成しています。関数名 `print_` は標準出力への表示のみを期待させますが、ファイルシステムへの永続的な変更が含まれています。
- **(暗黙状態変更: Medium)** モジュールトップレベルで `sys.path.insert(0, ...)` を実行しています。このモジュールをインポートするだけでグローバルな `sys.path` が変更され、他のモジュールのインポート解決に予期せぬ影響を与える可能性があります。
- **(型予測困難: Medium)** `get_boot_context`, `_load_projects`, `_load_skills` などの主要関数の戻り値が汎用的な `dict` となっており、具体的な構造（キーや値の型）がシグネチャから判別できません。呼び出し元は実行時の振る舞いに依存する必要があります。
- **(暗黙状態変更: Low)** `main` 関数内で `warnings.filterwarnings("ignore")` を実行しており、グローバルな警告抑制設定を変更しています。

## 修正提案

### 1. Webhook 送信の分離と明示化
データ取得と外部通知を分離し、`main` 関数などの上位層で制御することを提案します。

```python
# 変更案
def get_boot_context(...) -> BootContext:
    # 純粋なデータ取得
    pass

def notify_session_start(data: BootContext):
    # n8n 通知 (副作用あり)
    try:
        # ... urllib.request ...
    except Exception:
        pass

def main():
    data = get_boot_context(...)
    notify_session_start(data)  # 副作用を明示的に呼び出す
```

### 2. ファイル生成の分離
表示処理とファイル生成処理を分離してください。

```python
# 変更案
def generate_boot_template(result: BootContext) -> Path:
    # ... ファイル生成 ...
    return path

def print_boot_summary(result: BootContext):
    # ... 表示のみ ...
    pass

def main():
    # ...
    if args.mode == "detailed":
        template_path = generate_boot_template(result)
        print(f"Template created at: {template_path}")
```

### 3. グローバル状態変更の局所化
`sys.path` の変更は `if __name__ == "__main__":` ブロック内、またはエントリーポイント関数内で行うか、`PYTHONPATH` 環境変数を使用してください。

### 4. 型定義の導入
`TypedDict` または `Dataclass` を導入し、戻り値の構造を明示してください。

```python
from typing import TypedDict, List, Optional

class HandoffResult(TypedDict):
    count: int
    latest: Optional[dict]
    # ...

class BootContext(TypedDict):
    handoffs: HandoffResult
    ki: dict
    # ...

def get_boot_context(...) -> BootContext:
    # ...
```

## 重大度
High
