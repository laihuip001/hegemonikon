# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/api/server.py`

## 判定
発言（要改善）

## 発見事項
- **副作用の予測不可能性 (High)**: ヘルパー関数 `_cleanup_stale_socket` が `sys.exit(1)` を呼び出しており、例外発生ではなくプロセス終了という強い副作用を持っています。
  - **提案**: `sys.exit(1)` の代わりに例外（例: `RuntimeError`）を送出し、呼び出し元（`main`）でキャッチして終了するように変更すべきです。
- **暗黙的な状態変更 (Medium)**: モジュールレベルで `sys.path.insert(0, str(_PROJECT_ROOT))` が実行されており、インポートするだけでグローバルな `sys.path` が変更されます。
  - **提案**: エントリーポイントとして実行された場合（`if __name__ == "__main__":`）のみパスを追加するか、環境変数 `PYTHONPATH` で管理するように変更すべきです。
- **例外の隠蔽 (Medium)**: `_register_routers` 関数内で `import` エラーやその他の例外を `try...except Exception` で捕捉し、警告ログを出力するだけに留めています。これにより、重要な機能が欠落した状態でサーバーが起動しても、呼び出し元（`create_app`）からは正常終了したように見えます。
  - **提案**: 必須のルーターとオプショナルなルーターを区別し、必須のものは例外をそのまま送出する、あるいは失敗したルーターのリストを戻り値として返すなど、状態を明示的にすべきです。
- **暗黙的な状態変更 (Medium)**: `create_app` 関数内で `app.state.start_time = time.time()` を設定していますが、これは関数のドキュメントや型ヒントからは読み取れない副作用です。
  - **提案**: ドキュメントに明記するか、ミドルウェアとして分離することを検討すべきです。

## 重大度
High
