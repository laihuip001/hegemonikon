# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/gnosis_chat.py`

## 判定
発言（要改善）

## 発見事項

### 1. 戻り値の型が呼び出し元で予測困難 (High)
`GnosisChat.ask`, `Reranker.rerank`, `KnowledgeIndexer.discover_knowledge_files` メソッドが `dict` または `list[dict]` を返却しています。
辞書のキー構成（"answer", "sources", "_rerank_score" 等）が型ヒントから読み取れず、呼び出し側で文字列キーに依存する実装を強いています。これは将来的な変更に対する脆弱性（予測誤差）を高めます。

**修正コード提案:**
`dataclass` または `TypedDict` を定義し、構造を明示してください。

```python
from dataclasses import dataclass
from typing import List

@dataclass
class ChatSource:
    title: str
    source: str
    table: str
    url: str
    relevance: float

@dataclass
class ChatResponse:
    answer: str
    sources: List[ChatSource]
    retrieval_time: float
    generation_time: float
    context_docs: int
    turn: int

class GnosisChat:
    def ask(self, question: str) -> ChatResponse:
        # ...
```

### 2. 副作用（標準出力）が非明示 (Medium)
`Reranker._load`, `KnowledgeIndexer.index_knowledge`, `GnosisChat._load_index`, `GnosisChat._load_model` 内で `print()` が直接使用されています。
ライブラリとしてインポートされた場合、呼び出し側の意図しない標準出力が発生します。関数名から予測できない副作用です。

**修正コード提案:**
`logging` モジュールを使用するか、呼び出し元にログ情報を返す設計にしてください。

### 3. 例外の発生が隠蔽されている (Medium)
`KnowledgeIndexer.index_knowledge` や `GnosisChat._retrieve` で `except Exception: pass` が多用されています。
ファイル読み込みエラーやDB接続エラーが発生しても、呼び出し元は正常終了と区別がつきません。これにより、「何も起きなかった」という誤った予測を誘発します。

**修正コード提案:**
特定の例外（`FileNotFoundError`, `lancedb.Error` 等）のみをキャッチするか、エラー情報をログ出力・戻り値に含めてください。

### 4. 暗黙の状態変更（遅延ロード） (Low)
`GnosisChat` の `_index` や `_model` は初回アクセス時にロードされます（遅延初期化）。
メソッド呼び出し（`ask` や `interactive`）が、重いリソース消費（VRAM確保、モデルロード）という副作用を引き起こすことが明示的ではありません。

**修正コード提案:**
コンストラクタでロードするか、明示的な `load()` メソッドを用意し、状態遷移を予測可能にしてください。

## 重大度
High
