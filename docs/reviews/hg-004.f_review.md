# CCL式美学者 レビュー

## 対象ファイル
`mekhane/anamnesis/gnosis_chat.py`

## 判定
発言（要改善）

## 発見事項
- **ネストが3レベル超過 (Medium)**:
  - `KnowledgeIndexer.index_knowledge` (L113): `for` > `try` > `for` > `if` (4レベル)
  - `GnosisChat._retrieve` (L200): `if` > `try` > `if` > `for` (4レベル)
  - `GnosisChat.interactive` (L349): `while` > `if` > `if` > `for` (4レベル)
  - コードの意図が深く埋もれており、CCL式としての美しさを損なっています。
- **冗長なCCL式 / 意図不明 (Low)**:
  - 複数の `try...except Exception: pass` (L105, L114, L196, L203, L331) はエラーを完全に握りつぶしており、意図が不明確です。`/noe` のトレースを妨げます。
- **CCL式が60ポイント超過 (Medium)**:
  - パス定義 (L41, L42) が80文字を超えています。
  - `primary_key` の生成式 (L126) も長大です。分割を推奨します。

## 修正コード提案

### 1. ネストの解消 (Guard Clauses / Method Extraction)

```python
# Before (interactive)
if question == "/stats":
    self._load_index()
    stats = self._index.stats()
    # ... deeply nested ...
    if "knowledge" in self._index.db.table_names():
        # ... deeply nested ...
        for src, cnt in kdf["source"].value_counts().items():
            print(f"   {src}: {cnt}")
    continue

# After (Method Extraction)
def _handle_stats(self):
    self._load_index()
    stats = self._index.stats()
    # ...
    self._print_knowledge_stats()

def _print_knowledge_stats(self):
    if "knowledge" not in self._index.db.table_names():
        return
    # ...
    for src, cnt in kdf["source"].value_counts().items():
        print(f"   {src}: {cnt}")
```

### 2. 意図の明確化 (Intent Clarity)

```python
# Before (_retrieve)
try:
    if "knowledge" in self._index.db.table_names():
        # ...
except Exception:
    pass

# After
try:
    self._search_knowledge_table(results, fetch_k, query)
except Exception as e:
    # 意図的な無視であっても、その理由は記録されるべき
    print(f"[Warn] Knowledge search skipped: {e}")
```

## 重大度
Medium
