# CCL式美学者 レビュー

## 対象ファイル
`mekhane/anamnesis/gnosis_chat.py`

## 判定
発言（要改善）

## 発見事項
- `KnowledgeIndexer.discover_knowledge_files`: セッションログのタイトル抽出ロジックが60pt超過かつ意図不明（マジックナンバー `3` や `split` の意図）。 (Medium)
- `KnowledgeIndexer.discover_knowledge_files`: 類似したファイル探索ブロックが6回繰り返されており冗長。 (Low)
- `GnosisChat._retrieve`: `search_knowledge` ブロック内のネストが4レベルに達している（3レベル超過）。 (Low)

## 重大度
Medium

## 修正コード提案 (抜粋)

### 1. タイトル生成の関数化と意図の明確化

```python
def _format_session_title(stem: str) -> str:
    """セッションログのファイル名からタイトルを抽出.
    Format: YYYY-MM-DD_conv_Title_Name -> Title Name
    """
    if "_" not in stem:
        return stem
    # 日付とプレフィックスを除去してタイトル部分のみ抽出
    # e.g. "2026-05-20_conv_Topic_Name" -> "Topic Name"
    return stem.split("_", 3)[-1].replace("_", " ")

# Usage within loop:
# "title": _format_session_title(f.stem)
```

### 2. ファイル探索ロジックの共通化 (冗長性排除)

```python
    @staticmethod
    def discover_knowledge_files() -> list[dict]:
        files = []
        # 定義リスト: (source_type, glob_pattern, path_obj)
        sources = [
            ("handoff", "handoff_*.md", MNEME_SESSIONS),
            ("session", "2026-*_conv_*.md", MNEME_SESSIONS),
            ("ki", "insight_*.md", MNEME_SESSIONS),
            ("review", "weekly_review_*.md", MNEME_SESSIONS),
            ("ki", "*.md", MNEME_KNOWLEDGE),
            ("handoff", "*.md", HANDOFF_DIR),
            ("kernel", "*.md", KERNEL_DIR),
        ]

        for src_type, pattern, base_dir in sources:
            if not base_dir.exists():
                continue
            for f in sorted(base_dir.glob(pattern)):
                title = _format_session_title(f.stem) if src_type == "session" else f.stem.replace("_", " ").title()
                files.append({
                    "path": f,
                    "source_type": src_type,
                    "title": title
                })

        # CEP (Special case)
        cep_dir = KERNEL_DIR / "cep"
        if cep_dir.exists():
             for f in sorted(cep_dir.glob("*.md")):
                files.append({
                    "path": f,
                    "source_type": "kernel",
                    "title": f"CEP: {f.stem}",
                })
        return files
```

### 3. ネストの解消 (`_retrieve`)

```python
        # Knowledge table
        if self.search_knowledge:
            self._search_knowledge_table(query, results, fetch_k)

    def _search_knowledge_table(self, query, results, fetch_k):
        try:
            if "knowledge" not in self._index.db.table_names():
                return

            embedder = self._index._get_embedder()
            qvec = embedder.embed(query)
            table = self._index.db.open_table("knowledge")
            k_results = table.search(qvec).limit(fetch_k).to_list()
            for r in k_results:
                r["_source_table"] = "knowledge"
            results.extend(k_results)
        except Exception:
            pass
```
