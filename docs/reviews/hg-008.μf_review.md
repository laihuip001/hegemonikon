# Dendron×PROOF一致検査官 レビュー

## 対象ファイル
`mekhane/pks/push_dialog.py`

## 判定
発言（要改善）

## 発見事項

- **(High) Purpose Mismatch (File Level)**:
  - PROOF行: `PROOF: [L2/インフラ] このファイルは存在しなければならない`
  - Dendron Purpose: `PURPOSE: Push された知識への対話インターフェース` (コメント), `PURPOSE: PushDialog — 推薦知識への対話的アクセス` (docstring)
  - 説明: PROOF行の説明が汎用的すぎて、Dendron Purpose と一致していない。また、ファイルヘッダーに `# PURPOSE` が重複して存在する。

- **(High) PROOF Missing (Methods)**:
  - `PushDialog.__init__`: `# PURPOSE: PushDialog の初期化` はあるが、`# PROOF` がない。
  - `PushDialog.why`: `# PURPOSE: なぜこの知識が push されたか説明` はあるが、`# PROOF` がない。
  - `PushDialog._why_template`: `# PURPOSE: テンプレートベースの推薦理由` はあるが、`# PROOF` がない。
  - `PushDialog.deeper`: `# PURPOSE: nugget について追加質問 (LLM 経由)` はあるが、`# PROOF` がない。
  - `PushDialog.related`: `# PURPOSE: この nugget に関連する知識を検索` はあるが、`# PROOF` がない。
  - 説明: 関数単位で Dendron Purpose が存在するが、対応する PROOF 行が欠如している。

- **(Medium) Registration Missing**:
  - `mekhane/pks/PROOF.md` に `push_dialog.py` および `PushDialog` クラスの登録がない。

- **(Medium) Theorem Reference Mismatch**:
  - `A0 (FEP)` が参照されているが、標準定理セット（A1-A5, K1-K5など）に含まれていない可能性がある（A2 (Active Inference) が適切か）。

## 重大度
High

## 修正コード提案

```python
#!/usr/bin/env python3
# PURPOSE: Push された知識への対話インターフェース
"""
PROOF: [L2/Interface] Push された知識への対話的アクセス手段が必要

A2 (Active Inference) → 能動的推論 = 受身のプッシュではなく対話的探求
→ Creator が「なぜ？」「もっと」「関連は？」と問える
→ push_dialog.py が担う

# PURPOSE: PushDialog — 推薦知識への対話的アクセス
"""

# ... (imports)

# PURPOSE: Push された知識への対話インターフェース
class PushDialog:
    """Push された知識への対話インターフェース
    ...
    """
    # ...

    # PURPOSE: PushDialog の初期化
    def __init__(self, use_llm: bool = True, model: str = "gemini-2.0-flash"):
        # PROOF: [L2/Init] LLM クライアントの初期化が必要
        self._llm = PKSLLMClient(model=model, enabled=use_llm)

    # PURPOSE: なぜこの知識が push されたか説明
    def why(self, nugget: KnowledgeNugget) -> str:
        # PROOF: [L2/Explanation] 推薦理由の明示が信頼性を担保する (Trust)
        """なぜこの知識が push されたか説明
        ...
        """
        # ...

    # PURPOSE: テンプレートベースの推薦理由
    def _why_template(self, nugget: KnowledgeNugget) -> str:
        # PROOF: [L2/Fallback] LLM 不可時の代替手段が必要 (Robustness)
        """テンプレートベースの推薦理由"""
        # ...

    # PURPOSE: nugget について追加質問 (LLM 経由)
    def deeper(self, nugget: KnowledgeNugget, question: str) -> str:
        # PROOF: [L2/Exploration] 知識の深掘りによる理解促進 (Epistemic Value)
        """nugget について追加質問
        ...
        """
        # ...

    # PURPOSE: この nugget に関連する知識を検索
    def related(self, nugget: KnowledgeNugget, k: int = 5) -> list[KnowledgeNugget]:
        # PROOF: [L2/Association] 関連知識の提示によるコンテキスト拡張 (Context)
        """この nugget に関連する知識を GnosisIndex で検索"""
        # ...
```
