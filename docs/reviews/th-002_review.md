# 専門家レビュー: 信念状態一貫性評価者

## タスク
`mekhane/symploke/jules_client.py` の分析

## 分析観点
暗黙的前提の統一性（Belief State Consistency）

## 発見事項

### 1. 未知の状態に対する楽観的仮定 (`parse_state`)
- **内容**: `parse_state` 関数は `ValueError` を捕捉した際、一律に `SessionState.IN_PROGRESS` を返しています。
- **暗黙的前提**: 「未知の状態は常に一時的なものであり、待機すれば解消する」という信念が存在します。
- **矛盾**: もしAPIが新しい終端状態（例: `CANCELLED`, `REJECTED`, `EXPIRED`）を追加した場合、クライアントはそれを進行中と誤認し、タイムアウトまで無駄なポーリングを継続することになります。

### 2. 非同期クライアントのリソース管理における不整合
- **内容**: `JulesClient` は非同期IO (`aiohttp`) を採用していますが、`create_session` および `get_session` メソッド内で毎回 `aiohttp.ClientSession` を新規作成・破棄しています。
- **暗黙的前提**: 「このクライアントは高効率な並行処理を行う」というクラス設計（`batch_execute` 等）に対し、「接続のオーバーヘッドは無視できる」という実装詳細が矛盾しています。特に `batch_execute` で多数の同時リクエストを行う際、コネクションプーリングの恩恵を放棄しています。

### 3. エラー処理境界の不統一
- **内容**: `create_and_poll` は例外（`TimeoutError`, `RateLimitError`）を発生させますが、`batch_execute` は内部で例外を捕捉し、空のIDを持つ「合成された失敗セッション」を返します。
- **暗黙的前提**: 「単体実行時は呼び出し元が例外処理を行うべき」だが、「バッチ実行時は呼び出し元は戻り値の状態（FAILED）を確認すべき」という、利用コンテキストによる期待値のブレがあります。

## 重大度
**中 (Medium)**

## 推奨事項

1. **状態解析の厳格化**: `parse_state` は未知の値を `SessionState.UNKNOWN` にマッピングし、ポーリングループ内で `UNKNOWN` を検出した場合は即時終了するか、警告を出して一定回数後に終了するロジックに変更すべきです。
2. **セッションの永続化**: `JulesClient` に `__aenter__` / `__aexit__` を実装し、インスタンス寿命に合わせた `aiohttp.ClientSession` の再利用を推奨します。これにより `batch_execute` 時のパフォーマンスとリソース効率が向上します。
3. **エラー処理の統一**: バッチ処理においても例外をラップするカスタムResult型を使用するか、単体処理でも同様のオブジェクトを返すように統一し、APIの一貫性を保つべきです。

## 沈黙判定
**発言**
（リソース効率と堅牢性に関わる設計上の矛盾が見られるため、修正を提案します）
