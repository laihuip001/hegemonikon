# MICKS Business System — TO Design Document (Anchor-Buoy Pattern)

> **Created**: 2026-02-06 | **Updated**: 2026-02-06 v1.1
> **Purpose**: Formalize the design rationale (WHY) for TOs and relationships as a guide for implementation.

---

## 0. Architecture Overview

```text
┌────────────┐     ┌────────────┐
│   System   │     │   Search   │
│ (選択状態) │     │ (検索条件) │
├────────────┤     ├────────────┤
│G_UI_選択*ID│     │G_SCH_会社名 │
│G_UI_全件キー│     │G_SCH_システム名│
└─────┬──────┘     └────────────┘
      │ Anchor-Buoy
┌─────┴─────────────────────────┐
│ 会社一覧 / システム一覧 / ... │
│ (各階層のデータTO)            │
└───────────────────────────────┘
```

**責任分離**:

- `System`: どのレコードを選択しているか（UI状態管理、ハイパーバイザー）
- `Search`: 何を検索しているか（フィルタ条件管理、グローバル検索ハブ）

---

## 1. 設計原則（公理）

### 公理1: 1 Screen = 1 Table = 1 Responsibility

各レイアウトは**1つのテーブルに責任を持つ**。

- 会社一覧UI → 会社の一覧/選択/検索
- システム一覧UI → システムの一覧/選択/検索
- 大機能一覧UI → 大機能の一覧/選択/検索

### 公理2: Controller Separation (認知ハイパーバイザー)

`System` および `Search` テーブルは**UI状態のみを管理**し、業務データを持たない。

| テーブル | 接頭辞 | 用途 |
| :--- | :--- | :--- |
| **System** | `G_UI_` | どのレコードが選択されているか（階層遷移用） |
| **Search** | `G_SCH_` | どのような条件で絞り込んでいるか（検索機能用） |

### 公理3: Ladder Navigation

階層的な画面遷移を実現する。

```text
会社 → システム → 大機能 → 中機能 → 小機能 → 修正・要望
```

---

## 2. 演繹（導出過程）

### 問題: なぜテーブル間の直接リレーションではダメか？

**FileMakerの制約**: 同じベーステーブル間に複数のリレーションパスを持てない（ループ禁止）。

**例**:

```text
会社一覧 ─── システム一覧  (既存)
    ↑           │
    └───────────┘  ← ループ形成で新規リレーション不可
```

### 解決策: Anchor-Buoy パターン

**全てのTOを `System`（または `Search`）に直接接続する**ことで、テーブル間のループを回避する。

```text
        ┌───────────────────────────────────────────┐
        │                 System                    │
        │          (Anchor = 中心ハブ)              │
        └─────────────────┬─────────────────────────┘
                          │
    ┌─────────┬───────────┼───────────┬─────────────┐
    │         │           │           │             │
    ▼         ▼           ▼           ▼             ▼
 会社一覧  会社一覧   システム   システム    大機能    ...
           _詳細      一覧      一覧_詳細   一覧
```

**メリット**:

1. ループが発生しない
2. 状態管理が一元化される
3. どのレイアウトからも同じパターンでアクセス可能

---

## 3. TO一覧（演繹的に必要なもの）

### 命名規則

| パターン | TO名 | 用途 |
| :--- | :--- | :--- |
| 一覧表示 | `{テーブル名}` | ポータル一覧（親の選択IDでフィルタ） |
| 詳細表示 | `{テーブル名}_詳細` | 選択1件の詳細 |

### 完全TO一覧

| TO名 | ベーステーブル | 接続元（System側） | 接続先 |
| :--- | :--- | :--- | :--- |
| `会社一覧` | 会社一覧 | `G_UI_全件キー` | `UI_全件キー` |
| `会社一覧_詳細` | 会社一覧 | `G_UI_選択会社ID` | `__pk_会社一覧ID` |
| `システム一覧` | システム一覧 | `G_UI_選択会社ID` | `_fk_会社一覧ID` |
| `システム一覧_詳細` | システム一覧 | `G_UI_選択システムID` | `__pk_システム一覧ID` |
| `大機能一覧` | 大機能一覧 | `G_UI_選択システムID` | `_fk_システム一覧ID` |
| `大機能一覧_詳細` | 大機能一覧 | `G_UI_選択大機能ID` | `__pk_大機能一覧ID` |
| `中機能一覧` | 中機能一覧 | `G_UI_選択大機能ID` | `_fk_大機能一覧ID` |
| `中機能一覧_詳細` | 中機能一覧 | `G_UI_選択中機能ID` | `__pk_中機能一覧ID` |
| `小機能一覧` | 小機能一覧 | `G_UI_選択中機能ID` | `_fk_中機能一覧ID` |
| `小機能一覧_詳細` | 小機能一覧 | `G_UI_選択小機能ID` | `__pk_小機能一覧ID` |
| `修正・要望` | 修正・要望 | `G_UI_選択小機能ID` | `_fk_小機能一覧ID` |
| `修正・要望_詳細` | 修正・要望 | `G_UI_選択修正要望ID` | `__pk_修正要望ID` |

---

## 4. Controller テーブル フィールド一覧

### System (選択状態管理)

| フィールド名 | 型 | 格納 | 用途 |
| :--- | :--- | :--- | :--- |
| `__pk_システムID` | テキスト | 通常 | 主キー |
| `G_UI_全件キー` | テキスト | グローバル | 全件表示用（常に "1"） |
| `G_UI_選択会社ID` | テキスト | グローバル | 選択中の会社 |
| `G_UI_選択システムID` | テキスト | グローバル | 選択中のシステム |
| `G_UI_選択大機能ID` | テキスト | グローバル | 選択中の大機能 |
| `G_UI_選択中機能ID` | テキスト | グローバル | 選択中の中機能 |
| `G_UI_選択小機能ID` | テキスト | グローバル | 選択中の小機能 |
| `G_UI_選択修正要望ID` | テキスト | グローバル | 選択中の修正・要望 |

### Search (検索条件管理)

製品として当然あるべき機能を「Search」テーブルに集約する。

| フィールド名 | 型 | 格納 | 用途 |
| :--- | :--- | :--- | :--- |
| `G_SCH_会社名` | テキスト | グローバル | 会社名検索 |
| `G_SCH_システム名` | テキスト | グローバル | システム名検索 |
| `G_SCH_機能名` | テキスト | グローバル | 機能名キーワード検索 |
| `G_SCH_発生日_開始` | 日付 | グローバル | 発生日範囲（開始） |
| `G_SCH_発生日_終了` | 日付 | グローバル | 発生日範囲（終了） |
| `G_SCH_期限_開始` | 日付 | グローバル | 期限範囲（開始） |
| `G_SCH_期限_終了` | 日付 | グローバル | 期限範囲（終了） |
| `G_SCH_進捗` | テキスト | グローバル | 進捗ステータス絞込 |
| `G_SCH_修正要望区分` | テキスト | グローバル | 修正/要望 区分絞込 |

---

## 5. 各テーブル 必須フィールド

### 共通パターン

| フィールド名 | 用途 |
| :--- | :--- |
| `__pk_{テーブル}ID` | 主キー（UUID） |
| `_fk_{親テーブル}ID` | 外部キー（親への参照） |
| `UI_全件キー` | 全件表示用（計算: "1"）※会社一覧のみ |

### 修正・要望テーブル 特有フィールド (例外)

修正・要望テーブルには、階層を跨いだ検索と値一覧の動的制御のため、親および先祖のIDを冗長に保持する。

| フィールド名 | 用途 |
| :--- | :--- |
| `大機能ID` | 大機能への直接参照（値一覧用） |
| `中機能ID` | 中機能への直接参照（値一覧用） |
| `小機能ID` | 小機能への直接参照（`_fk_小機能一覧ID` と同期） |

**設計意図**: これにより、どの階層から「修正・要望」画面に遷移しても、関連する上位階層のコンテキストを即座に復元・フィルタリング可能にする（Excel構成案：92行目の要件に対応）。

---

## 6. Ladder Navigation の実装

### 画面遷移パターン

| 遷移元 | ボタン | スクリプト | 変更するフィールド |
| :--- | :--- | :--- | :--- |
| 会社一覧UI | → システム一覧へ | `UI_会社_システム一覧へ移動` | - |
| システム一覧UI | → 大機能一覧へ | `UI_システム_大機能一覧へ移動` | `G_UI_選択大機能ID = ""` |
| システム一覧UI | ← 戻る | `UI_システム_戻る` | `G_UI_選択システムID = ""` |

### 遷移時の状態リセット

「下の階層に入る時は、その階層の選択状態をリセットする」

```text
会社 → システム: G_UI_選択システムID = ""
システム → 大機能: G_UI_選択大機能ID = ""
...
```

---

## 7. まとめ

### なぜこの設計か（WHY）

1. **FileMaker制約回避**: テーブル間直接リレーションはループを生む
2. **責任分離**:
   - `System`: 選択パス（Ladder Navigation）を管理
   - `Search`: フィルタ条件（UI状態）を独立管理。肥大化を防ぎ、将来の検索プリセット保存にも対応可能。
3. **パターン統一**: 全階層で同じ構造（一覧TO + 詳細TO）
4. **拡張性**: 新しい階層を追加しても同じパターン

### 禁止事項

- [ ] テーブル間の直接リレーション（System を経由しない接続）
- [ ] 無印TO以外での一覧表示
- [ ] `_詳細` 以外での詳細表示

---

### リビジョン

- TO設計書 v1.1 (2026-02-06)
