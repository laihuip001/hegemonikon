#!/bin/bash
# PROOF: [L2/ã‚¤ãƒ³ãƒ•ãƒ©] <- mekhane/anamnesis/mk-bye.sh
#
# /bye ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ (v2.0)
# 1. Handoff ãƒ•ã‚¡ã‚¤ãƒ«ç›´æŽ¥ä¿å­˜ (ãƒ­ãƒ¼ã‚«ãƒ« â€” å¸¸ã«æˆåŠŸ)
# 2. ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (export_chats.py)
# 3. Slack é€šçŸ¥ (curl â€” éžåŒæœŸ)
# 4. n8n Webhook é€šçŸ¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ â€” å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š)
#
# Usage:
#   ./mk-bye.sh [ä¸»é¡Œ(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HEGEMONIKON_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
VENV_PYTHON="$HEGEMONIKON_DIR/.venv/bin/python"
EXPORT_SCRIPT="$SCRIPT_DIR/export_chats.py"
N8N_WEBHOOK_URL="http://localhost:5678/webhook/bye-handoff"
HANDOFF_DIR="$HOME/oikos/mneme/.hegemonikon/handoffs"

# Slack Webhook
SLACK_WEBHOOK_URL=""
if [ -f "$HEGEMONIKON_DIR/.env" ]; then
    SLACK_WEBHOOK_URL=$(grep '^SLACK_WEBHOOK_URL=' "$HEGEMONIKON_DIR/.env" | cut -d= -f2 | tr -d '"')
fi

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¸»é¡Œï¼‰
SUBJECT="$1"
if [ -z "$SUBJECT" ]; then
    SUBJECT="Auto-generated Handoff"
fi

TIMESTAMP=$(date +%Y%m%d_%H%M)
DATE_ISO=$(date -Iseconds)

echo "=== /bye Sequence Initiated ==="
echo "Subject: $SUBJECT"

# 1. Handoff ãƒ•ã‚¡ã‚¤ãƒ«ç›´æŽ¥ä¿å­˜ (æœ€å„ªå…ˆ)
echo "[1/4] ðŸ’¾ Saving Handoff locally..."
mkdir -p "$HANDOFF_DIR"

# ã‚µãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åå®‰å…¨ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
SAFE_SUBJECT=$(echo "$SUBJECT" | sed 's/[^a-zA-Z0-9_-]/_/g' | head -c 50)
HANDOFF_FILE="$HANDOFF_DIR/handoff_${TIMESTAMP}_${SAFE_SUBJECT}.md"

cat > "$HANDOFF_FILE" <<EOF
# Handoff: ${SUBJECT}

> **æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M')
> **Agent**: Claude (Antigravity)
> **Generated by**: mk-bye.sh v2.0

---

## ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦

ä¸»é¡Œ: ${SUBJECT}

---

*Handoff generated: ${DATE_ISO}*
EOF

echo "  Saved: $HANDOFF_FILE"

# 2. Export Chat History
echo "[2/4] ðŸ“¤ Exporting chat history..."
if [ -x "$VENV_PYTHON" ] && [ -f "$EXPORT_SCRIPT" ]; then
    if "$VENV_PYTHON" "$EXPORT_SCRIPT" --single "$SUBJECT" --format md 2>/dev/null; then
        echo "  Chat export successful."
    else
        echo "  Chat export failed. Continuing..."
    fi
else
    echo "  Export script not available. Skipping..."
fi

# 3. Slack é€šçŸ¥ (éžåŒæœŸ â€” ãƒãƒ³ã‚°ã—ãªã„)
echo "[3/4] ðŸ“± Slack notification..."
if [ -n "$SLACK_WEBHOOK_URL" ]; then
    curl -s -X POST "$SLACK_WEBHOOK_URL" \
        -H "Content-type: application/json" \
        -d "{\"text\": \"ðŸ‘‹ */bye* â€” ${SUBJECT}\nðŸ“„ Handoff: $(basename "$HANDOFF_FILE")\"}" \
        --connect-timeout 3 --max-time 5 &>/dev/null &
    echo "  Slack: notified (background)"
else
    echo "  Slack: webhook not configured"
fi

# 4. n8n Webhook (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ â€” å¤±æ•—ã—ã¦ã‚‚å•é¡Œãªã—)
echo "[4/4] ðŸ”— n8n Webhook..."
RESPONSE=$(curl -s -X POST "$N8N_WEBHOOK_URL" \
    -H "Content-Type: application/json" \
    -d "{\"subject\": \"$SUBJECT\", \"timestamp\": \"$DATE_ISO\", \"handoff_file\": \"$HANDOFF_FILE\"}" \
    --connect-timeout 3 --max-time 5 2>/dev/null || echo "unreachable")

if [ "$RESPONSE" = "unreachable" ]; then
    echo "  n8n: unreachable (local save successful, this is optional)"
else
    echo "  n8n: $RESPONSE"
fi

# ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥
if command -v notify-send &>/dev/null; then
    notify-send -u critical -i dialog-information \
        "ðŸ‘‹ /bye Sequence Complete" \
        "Subject: $SUBJECT" 2>/dev/null &
fi

echo "=== /bye Sequence Completed ==="
