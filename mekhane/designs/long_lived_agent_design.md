# 長期エージェント寿命設計文書

> **Status**: Draft (2026-02-15)
> **Priority**: Mid-term (F7)
> **導出**: /eat+ T3-4 (長期エージェント寿命)

## 問題定義

### /boot⊣/bye の限界

現行の `/boot`⊣`/bye` 随伴対は**セッション単位の記憶**を前提とする:

```
/boot: Handoff 読込 → コンテキスト復元
  ↕ セッション内作業
/bye: コンテキスト保存 → Handoff 生成
```

しかし、長期実行エージェント (Jules Daily Pipeline, Sentinel 等) は:

- 複数セッションにまたがるタスクを持つ
- 中断・再開が予測不能
- 意図 (intent) の一貫性がセッション間で劣化するリスクがある

### Context Rot × 長期タスク

| セッション長 | 状態 | リスク |
|:------------|:-----|:------|
| ≤30 msg | 🟢 健全 | - |
| 31-40 | 🟡 注意 | 中間セーブ必要 |
| 41-50 | 🟠 危険 | 新規タスク受付停止 |
| >50 | 🔴 破綻 | /bye 強制 |

長期エージェントは構造的に 🟠-🔴 で動作し続ける問題がある。

## 設計方針

### Intent-WAL (Write-Ahead Log)

データベースの WAL パターンを借用する:

```
[タスク開始]
  Intent 宣言を WAL に書き込む (= Handoff の先書き)

[実行中]
  定期的に WAL を更新 (進捗 + 状態)

[中断時]
  現在の WAL がリカバリポイントになる

[再開時]
  WAL から intent + 進捗を復元
```

**利点**: 中断がいつ起きても intent が残る。`/bye` の事前版。

### 定期 /rom (ROM焼付け)

セッション内で定期的にコンテキストを外部ファイルに焼き付ける:

```
# 20ステップごと、または N chat messages が🟡に到達時
/rom → context を構造化 → ROM ファイルに保存
```

現行の `/rom` WF を拡張し、自動トリガーを追加する。

### 階層的記憶モデル

```
┌────────────────────────────┐
│ コンテキストウィンドウ (RAM)  │  ← 揮発性、~200K tokens
├────────────────────────────┤
│ Intent-WAL                 │  ← 半永続、ファイルベース
├────────────────────────────┤
│ Handoff (ROM)              │  ← 永続、セッション間
├────────────────────────────┤
│ KI / Sophia                │  ← 永続、プロジェクト間
└────────────────────────────┘
```

## 実装ロードマップ

| Phase | 内容 | 推定工数 | 依存 |
|:------|:-----|:---------|:-----|
| **P1** | Intent-WAL フォーマット定義 | 2h | - |
| **P2** | `/rom` 自動トリガー (BC-18 連動) | 3h | P1 |
| **P3** | Jules Pipeline への WAL 統合 | 4h | P1, P2 |
| **P4** | `/boot` の WAL 読み込み対応 | 2h | P1 |

## HGK 体系との接続

| 概念 | HGK 対応 |
|:-----|:---------|
| Intent-WAL | O2 Boulēsis (意志の永続化) |
| Context Rot 対策 | K2 Chronos (時間的文脈) |
| 階層的記憶 | K4 Sophia (知識の階層) |
| /boot⊣/bye 拡張 | D-pair (忘却と構成の随伴) |

## リスク

| リスク | 影響 | 緩和策 |
|:-------|:-----|:-------|
| WAL のオーバーヘッド | ステップ数増加 | 書込み頻度を BC-18 閾値に連動 |
| WAL と Handoff の重複 | 管理負担 | WAL → Handoff 自動変換 |
| Intent ドリフト | 長期で意図が変質 | 定期 /dia- で intent 監査 |

## 次のアクション

1. Intent-WAL の YAML フォーマットを設計
2. `/rom` WF の自動トリガー条件を BC-18 と統合
3. Jules Pipeline で PoC 実施

---

*Design v0.1 — /eat+ F7*
