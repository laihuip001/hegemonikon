{
    "name": "WF-04: Perplexity Auto-Digest v2",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "*/30 * * * *"
                        }
                    ]
                }
            },
            "id": "schedule-trigger",
            "name": "30åˆ†ã”ã¨ãƒã‚§ãƒƒã‚¯",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const fs = require('fs');\nconst path = require('path');\n\nconst INCOMING_DIR = '/oikos/mneme/.hegemonikon/incoming';\n\ntry {\n  if (!fs.existsSync(INCOMING_DIR)) {\n    return [];\n  }\n\n  const files = fs.readdirSync(INCOMING_DIR)\n    .filter(f => f.endsWith('.md') && !f.startsWith('.'))\n    .map(f => {\n      const fullPath = path.join(INCOMING_DIR, f);\n      const stat = fs.statSync(fullPath);\n      const content = fs.readFileSync(fullPath, 'utf-8');\n      return { filename: f, path: fullPath, size: stat.size, content: content };\n    })\n    .filter(f => f.content.trim().length > 0);\n\n  if (files.length === 0) {\n    return [];\n  }\n\n  return files.map(f => ({ json: f }));\n} catch (e) {\n  throw new Error('Scan failed: ' + e.message);\n}"
            },
            "id": "scan-incoming",
            "name": "incoming/ ã‚¹ã‚­ãƒ£ãƒ³",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                450,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const fs = require('fs');\nconst path = require('path');\n\nconst content = $input.item.json.content;\nconst filename = $input.item.json.filename;\n\nconst lines = content.split('\\n');\nlet title = '';\nlet sources = [];\nlet keyFindings = [];\n\nfor (const line of lines) {\n  if (line.startsWith('# ') && !title) {\n    title = line.replace('# ', '').trim();\n  }\n  if (line.match(/\\[\\d+\\]/) || line.match(/https?:\\/\\//)) {\n    sources.push(line.trim());\n  }\n  if (line.includes('**') && line.trim().length > 10) {\n    keyFindings.push(line.trim());\n  }\n}\n\nconst now = new Date().toISOString().slice(0, 10);\nconst digest = `# Perplexity Digest: ${title || filename}\\n\\n> **æ¶ˆåŒ–æ—¥**: ${now}\\n> **å…ƒãƒ•ã‚¡ã‚¤ãƒ«**: ${filename}\\n> **ã‚µã‚¤ã‚º**: ${$input.item.json.size} bytes\\n\\n---\\n\\n## ä¸»è¦ãªç™ºè¦‹ (${keyFindings.length}ä»¶)\\n\\n${keyFindings.slice(0, 15).map((f, i) => `${i+1}. ${f}`).join('\\n')}\\n\\n---\\n\\n## å¼•ç”¨ãƒ»ã‚½ãƒ¼ã‚¹ (${sources.length}ä»¶)\\n\\n${sources.slice(0, 10).map(s => `- ${s}`).join('\\n')}\\n\\n---\\n\\n## åŸæ–‡ (å…ˆé ­500æ–‡å­—)\\n\\n${content.slice(0, 500)}...\\n\\n---\\n\\n*Auto-digested by Hegemonikon WF-04*\\n`;\n\nconst processedDir = '/oikos/mneme/.hegemonikon/processed';\nif (!fs.existsSync(processedDir)) {\n  fs.mkdirSync(processedDir, { recursive: true });\n}\n\nfs.renameSync($input.item.json.path, path.join(processedDir, filename));\nfs.writeFileSync(path.join(processedDir, `digest_${now}_${filename}`), digest, 'utf-8');\n\nreturn [{\n  json: {\n    title: title || filename,\n    findings: keyFindings.length,\n    sources: sources.length,\n    status: 'digested'\n  }\n}];"
            },
            "id": "digest-generator",
            "name": "ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆç”Ÿæˆ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "const items = $input.all();\nconst now = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });\n\nconst summary = items.map(item => {\n  const d = item.json;\n  return `ğŸ“„ **${d.title}** â€” ç™ºè¦‹: ${d.findings}ä»¶ | ã‚½ãƒ¼ã‚¹: ${d.sources}ä»¶`;\n}).join('\\n');\n\nreturn [{ json: {\n  message: `ğŸ“¥ Perplexity æ¶ˆåŒ–å®Œäº† (${now})\\n\\n${items.length}ä»¶å‡¦ç†:\\n${summary}`,\n  count: items.length\n} }];"
            },
            "id": "summary",
            "name": "ã‚µãƒãƒªãƒ¼ç”Ÿæˆ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                850,
                300
            ]
        }
    ],
    "connections": {
        "30åˆ†ã”ã¨ãƒã‚§ãƒƒã‚¯": {
            "main": [
                [
                    {
                        "node": "incoming/ ã‚¹ã‚­ãƒ£ãƒ³",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "incoming/ ã‚¹ã‚­ãƒ£ãƒ³": {
            "main": [
                [
                    {
                        "node": "ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆç”Ÿæˆ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆç”Ÿæˆ": {
            "main": [
                [
                    {
                        "node": "ã‚µãƒãƒªãƒ¼ç”Ÿæˆ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "tags": [
        {
            "name": "hegemonikon"
        },
        {
            "name": "perplexity"
        }
    ],
    "versionId": "2.0.0"
}