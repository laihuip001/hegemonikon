{
    "name": "WF-05: Health Alert â†’ Severity Classification",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "health-alert",
                "responseMode": "lastNode",
                "options": {}
            },
            "id": "webhook-health",
            "name": "Health Alert Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                250,
                300
            ],
            "webhookId": "health-alert"
        },
        {
            "parameters": {
                "jsCode": "const fs = require('fs');\nconst data = $input.item.json.body || $input.item.json;\nconst items = data.items || [];\nconst score = data.score || 0;\n\nconst errors = items.filter(i => i.status === 'error');\nconst warns = items.filter(i => i.status === 'warn');\n\nlet severity = 'LOW';\nif (errors.length >= 3 || score < 0.3) severity = 'CRITICAL';\nelse if (errors.length >= 1 || score < 0.5) severity = 'HIGH';\nelse if (warns.length >= 2 || score < 0.7) severity = 'MEDIUM';\n\nconst errorNames = errors.map(e => `${e.name}: ${(e.detail || '').slice(0,40)}`).join(', ');\nconst warnNames = warns.map(w => `${w.name}: ${(w.detail || '').slice(0,40)}`).join(', ');\nconst ts = data.timestamp || new Date().toISOString();\nconst icon = severity === 'CRITICAL' ? 'ğŸš¨' : severity === 'HIGH' ? 'ğŸ”´' : severity === 'MEDIUM' ? 'ğŸŸ¡' : 'ğŸŸ¢';\nconst scoreBar = 'â–ˆ'.repeat(Math.round(score * 10)) + 'â–‘'.repeat(10 - Math.round(score * 10));\n\n// P3: ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©\ntry {\n  const metricsDir = '/oikos/mneme/.hegemonikon';\n  if (!fs.existsSync(metricsDir)) fs.mkdirSync(metricsDir, { recursive: true });\n  const metric = { ts, score, severity, errors: errors.length, warns: warns.length };\n  fs.appendFileSync(metricsDir + '/health_metrics.jsonl', JSON.stringify(metric) + '\\n', 'utf-8');\n} catch(e) {}\n\n// P3: staticData ã§ç›´è¿‘æ¨ç§»ã‚’ä¿æŒ\nconst state = $getWorkflowStaticData('global');\nif (!state.history) state.history = [];\nstate.history.push({ ts, score, severity });\n// ç›´è¿‘100ä»¶ã®ã¿ä¿æŒ\nif (state.history.length > 100) state.history = state.history.slice(-100);\n\n// æ¨ç§»çµ±è¨ˆ\nconst recent = state.history.slice(-10);\nconst avgScore = recent.reduce((s, h) => s + h.score, 0) / recent.length;\nconst trend = recent.length >= 2 ? (recent[recent.length - 1].score - recent[0].score > 0 ? 'ğŸ“ˆ' : recent[recent.length - 1].score - recent[0].score < 0 ? 'ğŸ“‰' : 'â¡ï¸') : 'â€”';\n\n// Slack URL check\nlet hasSlackUrl = false;\ntry {\n  const { execSync } = require('child_process');\n  const url = execSync('echo $SLACK_WEBHOOK_URL', { encoding: 'utf-8' }).trim();\n  hasSlackUrl = url.length > 0 && url.startsWith('http');\n} catch(e) {}\n\nconst shouldNotify = (severity === 'CRITICAL' || severity === 'HIGH') && hasSlackUrl;\n\nconst slackPayload = shouldNotify ? JSON.stringify({\n  blocks: [\n    { type: 'header', text: { type: 'plain_text', text: icon + ' HGK Health: ' + severity, emoji: true } },\n    { type: 'section', fields: [\n      { type: 'mrkdwn', text: '*Score:*\\n' + (score * 100).toFixed(0) + '% [' + scoreBar + ']' },\n      { type: 'mrkdwn', text: '*Errors (' + errors.length + '):*\\n' + (errorNames || 'none') }\n    ]},\n    { type: 'section', fields: [\n      { type: 'mrkdwn', text: '*Trend:*\\n' + trend + ' avg=' + (avgScore * 100).toFixed(0) + '% (last ' + recent.length + ')' },\n      { type: 'mrkdwn', text: '*Warns (' + warns.length + '):*\\n' + (warnNames || 'none') }\n    ]},\n    { type: 'context', elements: [\n      { type: 'mrkdwn', text: '_WF-05 Auto-Alert | ' + state.history.length + ' data points_' }\n    ]}\n  ]\n}) : '';\n\nreturn [{ json: {\n  severity, score,\n  errorCount: errors.length, warnCount: warns.length,\n  errorNames: errorNames || '(none)',\n  warnNames: warnNames || '(none)',\n  timestamp: ts,\n  trend, avgScore: +avgScore.toFixed(3),\n  dataPoints: state.history.length,\n  shouldNotify, slackPayload\n} }];"
            },
            "id": "classify-alert",
            "name": "é‡å¤§åº¦åˆ†é¡ + ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                450,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{$json.shouldNotify}}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "if-should-notify",
            "name": "é€šçŸ¥å¿…è¦?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.SLACK_WEBHOOK_URL }}",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $json.slackPayload }}",
                "options": {
                    "timeout": 10000
                }
            },
            "id": "slack-notify",
            "name": "Slack é€šçŸ¥",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                850,
                200
            ]
        },
        {
            "parameters": {
                "jsCode": "const prev = $('é‡å¤§åº¦åˆ†é¡ + ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©').item.json;\nreturn [{ json: { severity: prev.severity, score: prev.score, trend: prev.trend, avgScore: prev.avgScore, dataPoints: prev.dataPoints, slack: 'sent' } }];"
            },
            "id": "result-sent",
            "name": "çµæœ (é€ä¿¡æ¸ˆ)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1050,
                200
            ]
        },
        {
            "parameters": {
                "jsCode": "const prev = $('é‡å¤§åº¦åˆ†é¡ + ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©').item.json;\nconst reason = (prev.severity === 'HIGH' || prev.severity === 'CRITICAL') ? 'SLACK_WEBHOOK_URL not set' : 'severity=' + prev.severity;\nreturn [{ json: { severity: prev.severity, score: prev.score, trend: prev.trend, avgScore: prev.avgScore, dataPoints: prev.dataPoints, slack: 'skipped (' + reason + ')' } }];"
            },
            "id": "result-skipped",
            "name": "çµæœ (ã‚¹ã‚­ãƒƒãƒ—)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                850,
                400
            ]
        }
    ],
    "connections": {
        "Health Alert Webhook": {
            "main": [
                [
                    {
                        "node": "é‡å¤§åº¦åˆ†é¡ + ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "é‡å¤§åº¦åˆ†é¡ + ãƒ¡ãƒˆãƒªã‚¯ã‚¹è“„ç©": {
            "main": [
                [
                    {
                        "node": "é€šçŸ¥å¿…è¦?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "é€šçŸ¥å¿…è¦?": {
            "main": [
                [
                    {
                        "node": "Slack é€šçŸ¥",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "çµæœ (ã‚¹ã‚­ãƒƒãƒ—)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Slack é€šçŸ¥": {
            "main": [
                [
                    {
                        "node": "çµæœ (é€ä¿¡æ¸ˆ)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "tags": [
        {
            "name": "hegemonikon"
        },
        {
            "name": "health"
        },
        {
            "name": "alert"
        }
    ],
    "active": true,
    "versionId": "9.0.0"
}