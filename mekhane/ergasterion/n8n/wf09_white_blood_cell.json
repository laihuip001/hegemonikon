{
    "name": "WF-09: White Blood Cell (Sympatheia)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "wbc-alert",
                "responseMode": "lastNode",
                "options": {}
            },
            "id": "wbc-webhook",
            "name": "ç•°å¸¸å—ä¿¡",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                250,
                400
            ],
            "webhookId": "wbc-alert-wh"
        },
        {
            "parameters": {
                "jsCode": "const fs = require('fs');\n\nconst STATE_FILE = '/oikos/mneme/.hegemonikon/wbc_state.json';\nconst now = new Date();\n\n// å…¥åŠ›ã‚’å–å¾— (webhook v2: body ã«ãƒã‚¹ãƒˆ)\nconst raw = $input.first().json;\nconst input = raw.body || raw;\nconst source = input.source || 'unknown';\nconst severity = input.severity || 'medium';\nconst details = input.details || 'No details';\nconst files = input.files || [];\n\n// éå»ã®ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿\nlet state = { alerts: [], totalAlerts: 0, lastEscalation: null };\ntry { state = JSON.parse(fs.readFileSync(STATE_FILE, 'utf-8')); } catch(e) {}\n\n// è„…å¨ãƒ¬ãƒ™ãƒ«åˆ¤å®š\nconst THREAT_WEIGHTS = {\n  'SACRED_TRUTH.md': 10,\n  'registry.yaml': 7,\n  'docker-compose.yml': 7,\n  'behavioral_constraints.md': 8,\n  'hegemonikon.md': 6\n};\n\nlet threatScore = 0;\nif (severity === 'critical') threatScore += 5;\nelse if (severity === 'high') threatScore += 3;\nelse threatScore += 1;\n\nfor (let i = 0; i < files.length; i++) {\n  for (const key in THREAT_WEIGHTS) {\n    if (files[i].indexOf(key) >= 0) threatScore += THREAT_WEIGHTS[key];\n  }\n}\n\n// ç›´è¿‘1æ™‚é–“ã®ã‚¢ãƒ©ãƒ¼ãƒˆæ•° (é€£ç¶šæ”»æ’ƒæ¤œçŸ¥)\nconst oneHourAgo = now.getTime() - 3600000;\nconst recentAlerts = (state.alerts || []).filter(function(a) { return new Date(a.timestamp).getTime() > oneHourAgo; });\nif (recentAlerts.length >= 3) threatScore += 5;\n\nconst level = threatScore >= 8 ? 'CRITICAL' : threatScore >= 4 ? 'HIGH' : 'LOW';\nconst shouldEscalate = level === 'CRITICAL' || level === 'HIGH';\n\n// è¨ºæ–­çµæœ\nconst diagnosis = {\n  timestamp: now.toISOString(),\n  source: source,\n  severity: severity,\n  threatScore: threatScore,\n  level: level,\n  details: details,\n  files: files,\n  recentAlertCount: recentAlerts.length,\n  shouldEscalate: shouldEscalate\n};\n\n// çŠ¶æ…‹ä¿å­˜ (ç›´è¿‘24æ™‚é–“åˆ†ã®ã¿ä¿æŒ)\nconst oneDayAgo = now.getTime() - 86400000;\nstate.alerts = (state.alerts || []).filter(function(a) { return new Date(a.timestamp).getTime() > oneDayAgo; });\nstate.alerts.push(diagnosis);\nstate.totalAlerts = (state.totalAlerts || 0) + 1;\nif (shouldEscalate) state.lastEscalation = now.toISOString();\n\ntry { fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2), 'utf-8'); } catch(e) {}\n\n// Slack ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ç”Ÿæˆ\nconst emoji = level === 'CRITICAL' ? 'ğŸš¨ğŸ©¸' : level === 'HIGH' ? 'âš ï¸ğŸ©¸' : 'ğŸ©¸';\nconst fileList = files.length > 0 ? files.slice(0,5).join(', ') : 'N/A';\nconst slackPayload = JSON.stringify({\n  blocks: [\n    { type: 'header', text: { type: 'plain_text', text: emoji + ' WBC Alert: ' + level + ' threat detected', emoji: true } },\n    { type: 'section', text: { type: 'mrkdwn', text: '*Source:* ' + source + '\\n*Severity:* ' + severity + '\\n*Threat Score:* ' + threatScore + '/15\\n*Details:* ' + details } },\n    { type: 'section', text: { type: 'mrkdwn', text: '*Files:* ' + fileList + '\\n*Recent alerts (1h):* ' + recentAlerts.length } },\n    { type: 'context', elements: [{ type: 'mrkdwn', text: '_WF-09 White Blood Cell | Total: ' + state.totalAlerts + '_' }] }\n  ]\n});\n\nreturn [{ json: Object.assign(diagnosis, { slackPayload: slackPayload }) }];"
            },
            "id": "threat-analysis",
            "name": "è„…å¨åˆ†æ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                450,
                400
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{$json.shouldEscalate}}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "if-escalate",
            "name": "ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆ?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                650,
                400
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.SLACK_WEBHOOK_URL }}",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $json.slackPayload }}",
                "options": {
                    "timeout": 10000
                }
            },
            "id": "slack-escalate",
            "name": "Creatorç·Šæ€¥é€šçŸ¥",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                850,
                300
            ]
        }
    ],
    "connections": {
        "ç•°å¸¸å—ä¿¡": {
            "main": [
                [
                    {
                        "node": "è„…å¨åˆ†æ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "è„…å¨åˆ†æ": {
            "main": [
                [
                    {
                        "node": "ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆ?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆ?": {
            "main": [
                [
                    {
                        "node": "Creatorç·Šæ€¥é€šçŸ¥",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "tags": [
        {
            "name": "hegemonikon"
        },
        {
            "name": "sympatheia"
        },
        {
            "name": "wbc"
        }
    ],
    "active": true
}