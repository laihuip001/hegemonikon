{
    "name": "WF-15: Heartbeat (Sympatheia)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "*/5 * * * *"
                        }
                    ]
                }
            },
            "id": "heartbeat-cron",
            "name": "5åˆ†æ¯ã®é¼“å‹•",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "heartbeat",
                "responseMode": "lastNode",
                "options": {}
            },
            "id": "heartbeat-webhook",
            "name": "æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                250,
                500
            ],
            "webhookId": "heartbeat-wh"
        },
        {
            "parameters": {
                "jsCode": "const fs = require('fs');\n\nconst now = new Date();\nconst checks = [];\nlet healthy = true;\n\n// 1. n8n DB ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯\ntry {\n  const dbPath = '/home/node/.n8n/database.sqlite';\n  if (fs.existsSync(dbPath)) {\n    const stat = fs.statSync(dbPath);\n    const ageSec = Math.round((Date.now() - stat.mtimeMs) / 1000);\n    checks.push({ name: 'n8n_db', status: 'ok', detail: 'modified ' + ageSec + 's ago' });\n  } else {\n    checks.push({ name: 'n8n_db', status: 'error', detail: 'DB not found' });\n    healthy = false;\n  }\n} catch(e) {\n  checks.push({ name: 'n8n_db', status: 'warn', detail: e.message.slice(0,50) });\n}\n\n// 2. mneme ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ›¸ãè¾¼ã¿ + é¼“å‹•ã‚«ã‚¦ãƒ³ãƒˆ\nlet beats = 0;\ntry {\n  const metricsDir = '/oikos/mneme/.hegemonikon';\n  const hbFile = metricsDir + '/heartbeat.json';\n  \n  // å‰å›ã®heartbeatã‚’èª­ã‚€ (ã‚«ã‚¦ãƒ³ãƒˆç¶™ç¶š)\n  try {\n    const prev = JSON.parse(fs.readFileSync(hbFile, 'utf-8'));\n    beats = (prev.beats || 0) + 1;\n  } catch(e) {\n    beats = 1;\n  }\n  \n  const heartbeat = {\n    timestamp: now.toISOString(),\n    beats: beats,\n    healthy: healthy,\n    checks: checks\n  };\n  fs.writeFileSync(hbFile, JSON.stringify(heartbeat, null, 2), 'utf-8');\n  checks.push({ name: 'mneme_write', status: 'ok', detail: 'beat #' + beats });\n} catch(e) {\n  checks.push({ name: 'mneme_write', status: 'error', detail: e.message.slice(0,80) });\n  healthy = false;\n}\n\n// Slack: ç•°å¸¸æ™‚ã®ã¿\nconst shouldAlert = !healthy;\n\nlet slackPayload = '';\nif (shouldAlert) {\n  slackPayload = JSON.stringify({\n    blocks: [\n      { type: 'header', text: { type: 'plain_text', text: 'ğŸ«€ Sympatheia: ANOMALY', emoji: true } },\n      { type: 'section', text: { type: 'mrkdwn', text: 'Beat #' + beats + '\\n' + checks.filter(function(c) { return c.status !== 'ok'; }).map(function(c) { return 'âŒ ' + c.name + ': ' + c.detail; }).join('\\n') } },\n      { type: 'context', elements: [{ type: 'mrkdwn', text: '_WF-15 Heartbeat_' }] }\n    ]\n  });\n}\n\nreturn [{ json: {\n  healthy: healthy,\n  beats: beats,\n  checks: checks,\n  shouldAlert: shouldAlert,\n  slackPayload: slackPayload\n} }];"
            },
            "id": "heartbeat-check",
            "name": "è‡ªå·±è¨ºæ–­",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                450,
                400
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{$json.shouldAlert}}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "if-alert",
            "name": "ç•°å¸¸ã‚ã‚Š?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                650,
                400
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "={{ $env.SLACK_WEBHOOK_URL }}",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{ $json.slackPayload }}",
                "options": {
                    "timeout": 10000
                }
            },
            "id": "slack-sos",
            "name": "SOS é€šçŸ¥",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                850,
                300
            ]
        }
    ],
    "connections": {
        "5åˆ†æ¯ã®é¼“å‹•": {
            "main": [
                [
                    {
                        "node": "è‡ªå·±è¨ºæ–­",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼": {
            "main": [
                [
                    {
                        "node": "è‡ªå·±è¨ºæ–­",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "è‡ªå·±è¨ºæ–­": {
            "main": [
                [
                    {
                        "node": "ç•°å¸¸ã‚ã‚Š?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ç•°å¸¸ã‚ã‚Š?": {
            "main": [
                [
                    {
                        "node": "SOS é€šçŸ¥",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "tags": [
        {
            "name": "hegemonikon"
        },
        {
            "name": "sympatheia"
        },
        {
            "name": "heartbeat"
        }
    ],
    "active": true,
    "versionId": "3.0.0"
}