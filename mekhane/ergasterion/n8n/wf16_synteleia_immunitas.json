{
    "name": "WF-16: Synteleia Immunitas (è‡ªå‹•ç›£æŸ»)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "cronExpression",
                            "expression": "0 */6 * * *"
                        }
                    ]
                }
            },
            "id": "immunitas-cron",
            "name": "6hè£œåŠ©å·¡å› (ãƒ¡ã‚¤ãƒ³ã¯git hook)",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "synteleia-audit",
                "responseMode": "lastNode",
                "options": {}
            },
            "id": "immunitas-webhook",
            "name": "æ‰‹å‹•ç›£æŸ»ãƒˆãƒªã‚¬ãƒ¼",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                250,
                500
            ],
            "webhookId": "synteleia-audit"
        },
        {
            "parameters": {
                "jsCode": "// Synteleia Immunitas â€” git diff å–å¾— + ç›£æŸ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆ\nconst { execSync } = require('child_process');\nconst fs = require('fs');\n\nconst HGK_DIR = '/home/makaron8426/oikos/hegemonikon';\nconst LOG_DIR = '/oikos/mneme/.hegemonikon/synteleia_logs';\nconst now = new Date();\n\ntry {\n  // ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ\n  if (!fs.existsSync(LOG_DIR)) fs.mkdirSync(LOG_DIR, { recursive: true });\n\n  // git diff å–å¾— (staged + unstaged)\n  let diff = '';\n  try {\n    diff = execSync('git diff --stat && echo \"---\" && git diff --cached --stat', {\n      cwd: HGK_DIR, encoding: 'utf-8', timeout: 10000\n    });\n  } catch(e) {\n    diff = 'git diff failed: ' + e.message;\n  }\n\n  // æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®å†…å®¹ã‚’å–å¾—\n  let lastCommitDiff = '';\n  try {\n    lastCommitDiff = execSync('git log -1 --format=\"%H %s\" && git diff HEAD~1..HEAD --stat', {\n      cwd: HGK_DIR, encoding: 'utf-8', timeout: 10000\n    });\n  } catch(e) {\n    lastCommitDiff = 'no recent commit diff';\n  }\n\n  // å¤‰æ›´ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—\n  const hasDiff = diff.trim().length > 10 || lastCommitDiff.trim().length > 10;\n  if (!hasDiff) {\n    return [{ json: {\n      timestamp: now.toISOString(),\n      skipped: true,\n      reason: 'no changes detected',\n      auditNeeded: false\n    }}];\n  }\n\n  // ç›£æŸ»å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹æˆ\n  const auditContent = [\n    '## Git Changes (Uncommitted)',\n    diff,\n    '',\n    '## Last Commit',\n    lastCommitDiff\n  ].join('\\n');\n\n  return [{ json: {\n    timestamp: now.toISOString(),\n    skipped: false,\n    auditNeeded: true,\n    auditContent: auditContent,\n    diffLength: diff.length,\n    source: 'wf16-immunitas-cron'\n  }}];\n\n} catch(e) {\n  return [{ json: {\n    timestamp: now.toISOString(),\n    skipped: true,\n    error: e.message,\n    auditNeeded: false\n  }}];\n}"
            },
            "id": "git-diff",
            "name": "å¤‰ç•°æ¤œå‡º (git diff)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                480,
                400
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{$json.auditNeeded}}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "if-audit-needed",
            "name": "å¤‰ç•°ã‚ã‚Š?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                700,
                400
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://localhost:9696/api/synteleia/audit",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\"content\": \"{{ $json.auditContent }}\", \"target_type\": \"code\", \"source\": \"{{ $json.source }}\", \"with_l2\": false, \"auto_escalate\": true}",
                "options": {
                    "timeout": 30000
                }
            },
            "id": "synteleia-audit",
            "name": "Synteleia ç›£æŸ»",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                920,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ç›£æŸ»çµæœã‚’è§£æã—ã€ã‚¢ãƒ©ãƒ¼ãƒˆè¦å¦ã‚’åˆ¤å®š\nconst fs = require('fs');\nconst LOG_DIR = '/oikos/mneme/.hegemonikon/synteleia_logs';\nconst now = new Date();\nconst result = $input.first().json;\n\n// ç›£æŸ»ãƒ­ã‚°ã‚’ä¿å­˜ (Layer C: Pronoia ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿è“„ç©)\nconst logFile = LOG_DIR + '/audit_' + now.toISOString().replace(/[:.]/g, '-') + '.json';\ntry {\n  if (!fs.existsSync(LOG_DIR)) fs.mkdirSync(LOG_DIR, { recursive: true });\n  fs.writeFileSync(logFile, JSON.stringify(result, null, 2), 'utf-8');\n} catch(e) {\n  // ãƒ­ã‚°ä¿å­˜å¤±æ•—ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã«å½±éŸ¿ã—ãªã„\n}\n\nconst criticalCount = result.critical_count || 0;\nconst highCount = result.high_count || 0;\nconst totalIssues = result.total_issues || 0;\nconst passed = result.passed !== false;\n\nconst shouldAlert = criticalCount > 0 || highCount > 0;\n\nlet notifPayload = '';\nif (shouldAlert) {\n  const emoji = criticalCount > 0 ? 'ğŸš¨ğŸ›¡ï¸' : 'âš ï¸ğŸ›¡ï¸';\n  const lines = [\n    emoji + ' Synteleia Immunitas: ' + totalIssues + ' issues detected',\n    '',\n    'ğŸ”´ Critical: ' + criticalCount,\n    'ğŸŸ  High: ' + highCount,\n    'ğŸ“Š Total: ' + totalIssues,\n    '',\n    'ğŸ“‹ Summary: ' + (result.summary || 'N/A'),\n  ];\n\n  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¥ã®çµæœ\n  if (result.agent_results) {\n    lines.push('');\n    lines.push('--- Agent Results ---');\n    for (const ar of result.agent_results) {\n      const icon = ar.passed ? 'âœ…' : 'âŒ';\n      lines.push(icon + ' ' + ar.agent_name + ' (' + Math.round(ar.confidence * 100) + '%)');\n      if (ar.issues && ar.issues.length > 0) {\n        for (const iss of ar.issues.slice(0, 3)) {\n          lines.push('  â†’ [' + iss.severity + '] ' + iss.message);\n        }\n      }\n    }\n  }\n\n  notifPayload = lines.join('\\n');\n}\n\nreturn [{ json: {\n  timestamp: now.toISOString(),\n  passed,\n  shouldAlert,\n  criticalCount,\n  highCount,\n  totalIssues,\n  notifPayload,\n  logFile,\n  report: result.report || ''\n}}];"
            },
            "id": "result-analyzer",
            "name": "å…ç–«å¿œç­”åˆ¤å®š",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1140,
                300
            ]
        },
        {
            "parameters": {
                "conditions": {
                    "boolean": [
                        {
                            "value1": "={{$json.shouldAlert}}",
                            "value2": true
                        }
                    ]
                }
            },
            "id": "if-alert",
            "name": "å…ç–«åå¿œ?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 1,
            "position": [
                1360,
                300
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "http://localhost:9696/api/sympatheia/notifications",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={\"title\": \"Synteleia Immunitas Alert\", \"body\": \"{{ $json.notifPayload }}\", \"level\": \"HIGH\", \"source\": \"wf16-immunitas\"}",
                "options": {
                    "timeout": 10000
                }
            },
            "id": "wbc-notify",
            "name": "WBC é€šçŸ¥",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                1580,
                200
            ]
        }
    ],
    "connections": {
        "30åˆ†æ¯ã®å…ç–«å·¡å›": {
            "main": [
                [
                    {
                        "node": "å¤‰ç•°æ¤œå‡º (git diff)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "æ‰‹å‹•ç›£æŸ»ãƒˆãƒªã‚¬ãƒ¼": {
            "main": [
                [
                    {
                        "node": "å¤‰ç•°æ¤œå‡º (git diff)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å¤‰ç•°æ¤œå‡º (git diff)": {
            "main": [
                [
                    {
                        "node": "å¤‰ç•°ã‚ã‚Š?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å¤‰ç•°ã‚ã‚Š?": {
            "main": [
                [
                    {
                        "node": "Synteleia ç›£æŸ»",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        },
        "Synteleia ç›£æŸ»": {
            "main": [
                [
                    {
                        "node": "å…ç–«å¿œç­”åˆ¤å®š",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å…ç–«å¿œç­”åˆ¤å®š": {
            "main": [
                [
                    {
                        "node": "å…ç–«åå¿œ?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "å…ç–«åå¿œ?": {
            "main": [
                [
                    {
                        "node": "WBC é€šçŸ¥",
                        "type": "main",
                        "index": 0
                    }
                ],
                []
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "tags": [
        {
            "name": "hegemonikon"
        },
        {
            "name": "sympatheia"
        },
        {
            "name": "synteleia"
        },
        {
            "name": "immunitas"
        }
    ],
    "active": true
}