# 視覚リズムの指揮者 レビュー

## 対象ファイル
`mekhane/ergasterion/digestor/pipeline.py`

## 判定
発言（要改善）

## 発見事項
- 視覚的な重心の偏り (Medium): `_load_existing_keys` メソッドにて、ネスト深度が10レベルに達しており、コードの重心が極端に右側に寄っている。特にJSONの階層をそのままループで掘り下げる構造が、視覚的なリズムを阻害している。
- インデントの波形の乱れ (Low): 上記の深いネストにより、スクロール時に左側の空白領域が大きく広がり、コードの波形が急激に右へシフトしている。

## 修正案
`_load_existing_keys` メソッドを、データソースごとに `_load_gnosis_keys` と `_load_sophia_keys` に分割し、早期リターンを活用することでネストを浅くする。

```python
    # PURPOSE: 既存インデックスから primary_key を収集
    def _load_existing_keys(self) -> set[str]:
        """既存インデックスから primary_key を収集"""
        keys: set[str] = set()
        keys.update(self._load_gnosis_keys())
        keys.update(self._load_sophia_keys())

        if keys:
            print(f"[Digestor]   → Loaded {len(keys)} existing keys for dedup")
        return keys

    def _load_gnosis_keys(self) -> set[str]:
        """Gnosis インデックスからキーを収集"""
        keys = set()
        gnosis_path = Path.home() / ".hegemonikon" / "gnosis"
        if not gnosis_path.exists():
            return keys

        for json_file in gnosis_path.glob("*.json"):
            try:
                with open(json_file, "r") as f:
                    data = json.load(f)

                items = data if isinstance(data, list) else [data]
                for item in items:
                    if isinstance(item, dict):
                        pk = item.get("primary_key") or item.get("id", "")
                        if pk:
                            keys.add(pk)
            except Exception:
                continue
        return keys

    def _load_sophia_keys(self) -> set[str]:
        """Sophia インデックスからキーを収集"""
        keys = set()
        sophia_path = Path.home() / ".hegemonikon" / "sophia" / "sophia.pkl"
        if not sophia_path.exists():
            return keys

        try:
            import pickle
            with open(sophia_path, "rb") as f:
                data = pickle.load(f)
            metadata = data.get("metadata", {})
            for _id, meta in metadata.items():
                if isinstance(meta, dict):
                    title = meta.get("title", "")
                    if title:
                        keys.add(f"title:{title}")
        except Exception as e:
            print(f"[Digestor]   → Sophia keys load failed: {e}")
        return keys
```

## 重大度
Medium
