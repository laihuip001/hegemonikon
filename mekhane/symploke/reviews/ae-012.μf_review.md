# è¦–è¦šãƒªã‚ºãƒ ã®æŒ‡æ®è€… ãƒ¬ãƒ“ãƒ¥ãƒ¼

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`mekhane/anamnesis/session_monitor.py`

## åˆ¤å®š
ç™ºè¨€ï¼ˆè¦æ”¹å–„ï¼‰

## ç™ºè¦‹äº‹é …
- (é–¢æ•°å˜ä½) é–¢æ•°ã‚µã‚¤ã‚ºã®ä¸å‡ä¸€ï¼ˆ10è¡Œã¨200è¡ŒãŒæ··åœ¨ï¼‰: `monitor_once` é–¢æ•°ï¼ˆç´„70è¡Œï¼‰ãŒã€ä»–ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆæ•°è¡Œã€œ30è¡Œç¨‹åº¦ï¼‰ã«æ¯”ã¹ã¦çªå‡ºã—ã¦å¤§ããã€ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ãƒªã‚ºãƒ ã‚’ä¹±ã—ã¦ã„ã‚‹ (Medium)
- (é–¢æ•°å˜ä½) è¦–è¦šçš„ãªé‡å¿ƒã®åã‚Šï¼ˆå³å´ã«å¯„ã‚Šã™ãï¼‰: `monitor_once` å†…ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã«ãŠã„ã¦ã€`try-except` ãƒ–ãƒ­ãƒƒã‚¯ã‚„æ¡ä»¶åˆ†å²ãŒæ·±ããƒã‚¹ãƒˆã—ã¦ãŠã‚Šï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«3ã€œ4ï¼‰ã€ã‚³ãƒ¼ãƒ‰ã®é‡å¿ƒãŒå³ã«å¯„ã£ã¦ã„ã‚‹ (Medium)

## é‡å¤§åº¦
Medium

## ä¿®æ­£ææ¡ˆ
`monitor_once` å†…ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆå˜ä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆ¤å®šãƒ»ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã‚’ç‹¬ç«‹ã—ãŸé–¢æ•° `_process_single_session` ã¨ã—ã¦åˆ‡ã‚Šå‡ºã™ã“ã¨ã§ã€ãƒã‚¹ãƒˆã‚’æµ…ãã—ã€é–¢æ•°ã‚µã‚¤ã‚ºã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ã‚’ææ¡ˆã—ã¾ã™ã€‚

```python
def _process_single_session(client: AntigravityClient, state: dict, session: dict) -> bool:
    """å˜ä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†ã¨ä¿å­˜ã‚’è¡Œã† (Returns: True if updated)"""
    cascade_id = session.get("cascade_id", "")
    step_count = session.get("step_count", 0)
    summary = session.get("summary", f"Session {cascade_id[:8]}")
    status = session.get("status", "")

    if not cascade_id:
        return False

    prev_steps = state.get(cascade_id, {}).get("step_count", 0)
    if step_count <= prev_steps:
        return False

    delta = step_count - prev_steps
    print(f"[Monitor] ğŸ“ {summary[:50]}... (+{delta} steps)")

    try:
        conv = client.session_read(cascade_id, full=True)
        if "error" in conv:
            print(f"  âš ï¸ Read error: {conv['error']}")
            return False

        # MD ä¿å­˜
        md_content = format_session_md(conv, summary, cascade_id)
        safe_name = sanitize_filename(summary)
        ts = datetime.now().strftime("%Y-%m-%d")
        filename = f"live_{ts}_{safe_name}.md"
        filepath = OUTPUT_DIR / filename

        OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
        filepath.write_text(md_content, encoding="utf-8")
        print(f"  âœ… Saved: {filepath.name} ({len(md_content)} bytes)")

        state[cascade_id] = {
            "step_count": step_count,
            "summary": summary,
            "last_updated": datetime.now().isoformat(),
            "status": status,
        }
        return True

    except Exception as e:
        print(f"  âŒ Error: {e}")
        return False

def monitor_once(client: AntigravityClient, state: dict) -> dict:
    """1å›ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«"""
    # å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾—
    info = client.session_info()
    if "error" in info:
        print(f"[Monitor] âŒ LS API error: {info['error']}")
        return state

    sessions = info.get("sessions", [])
    if not sessions:
        print("[Monitor] No sessions found")
        return state

    # æœ€æ–° N ä»¶ã‚’å¯¾è±¡
    recent = sessions[:MAX_SESSIONS]
    updated_count = 0

    for s in recent:
        if _process_single_session(client, state, s):
            updated_count += 1

    if updated_count == 0:
        print(f"[Monitor] âœ… No updates ({len(recent)} sessions checked)")
    else:
        print(f"[Monitor] ğŸ“Š {updated_count} sessions updated")
        save_state(state)

    return state
```
