# シンプリシティの門番 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- 重大なコード重複 (High): `index_handoffs`, `index_conversations`, `index_steps`, `index_exports`, `index_roms`, `index_from_json` の6関数すべてにおいて、GnosisIndexの初期化・既存データの読み込み・重複排除・Embeddingのバッチ処理・LanceDBへの登録という一連のロジックがほぼ完全に重複している。これらは単一の `_batch_index_records(records, source_name)` のようなヘルパー関数に集約すべきである。これは DRY原則および Reduced Complexity の重大な違反であり、保守性を著しく損なっている。
- バッチサイズの不統一 (Medium): Embedding処理におけるバッチサイズが、`index_conversations` / `index_steps` / `index_exports` では 16、`index_from_json` では 32 とバラバラにハードコードされている。明確な理由がない限り、定数 (`BATCH_SIZE`) として統一すべきである。
- 不要なシェルスクリプト依存 (Low): `index_from_api` 関数内で `subprocess` を使用して `scripts/agq-sessions.sh` を呼び出しているが、同ファイル内の `index_conversations` 関数では Python クライアントである `AntigravityClient` を使用している。もし `AntigravityClient` で同等の情報が取得可能であれば、外部シェルスクリプトへの依存は不要な複雑さであり排除すべきである。

## 重大度
High
