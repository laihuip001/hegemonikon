# シンプリシティの門番 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項

1. **冗長かつ危険なタイムアウト実装 (High)**
   - `hgk_paper_search` (L754-766) で `signal.alarm` を使用して30秒のタイムアウトを実装しているが、これはUnix依存であり、スレッドセーフではなく、Windows環境で動作しない。
   - `SemanticScholarClient` 内部で `httpx` による30秒のタイムアウトが既に実装されており (L125)、このコードは完全に冗長である。削除すべき。

2. **不要なサブプロセス呼び出し (High)**
   - `hgk_pks_stats`, `hgk_pks_health`, `hgk_pks_search` が `subprocess` を使用して自プロジェクト内の `mekhane.pks.pks_cli` を呼び出している。
   - 一方で `hgk_proactive_push` は `PKSEngine` を直接 import して使用しており、実装が一貫していない。
   - 同一プロセス内で完結できる処理をサブプロセス化することは、オーバーヘッドと複雑さを増大させるだけであり (YAGNI)、直接 import に統一すべき。

3. **パス定義の重複と不整合 (High)**
   - `MNEME_DIR` の定義が3箇所で分散・重複しており、ロジックも異なる。
     - L155: `_MNEME_DIR` (os.getenv または `~/oikos/...`)
     - L351: `MNEME_DIR` (`PROJECT_ROOT.parent/...`)
     - L137: `_trace_tool_call` 内で再定義
   - これにより、環境によってはログ、セッション、ステータスが異なるディレクトリを参照するバグの温床となっている。「唯一の正解」を1箇所で定義すべき。

4. **変数の定義順序と可読性 (Low)**
   - `hgk_status` (L540) が、300行下で定義される `INCOMING_DIR` (L830) を参照している。
   - Pythonの遅延バインディングにより動作はするが、上から下への「直感的ロジック (Intuitive Logic)」を阻害している。定数はファイル上部に集約すべき。

5. **手動フロントマター解析 (Low)**
   - `hgk_digest_check` (L845) で `yaml` が import されているにもかかわらず、手動で文字列解析を行ってフロントマターをパースしている。
   - `yaml.safe_load` を使用すれば数行で済む処理であり、車輪の再発明である。

6. **God File (Medium)**
   - 1250行を超える単一ファイルに、OAuth認証、ポリシー管理、監査ログ、20以上のMCPツール実装が混在している。
   - 特にツール群は `mekhane/mcp/tools/` 等に分割・委譲すべきである (Reduced Complexity)。

## 重大度
High
