# シンプリシティの門番 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **コード重複（Medium）**: `index_handoffs`, `index_conversations`, `index_steps`, `index_exports`, `index_from_json` の5つの関数において、以下のロジックが重複しています。共通化することで約100行のコード削減と一貫性の向上が見込めます。
  - 既存レコードとの重複排除 (Deduplication)
  - Embedding のバッチ生成
  - LanceDB へのデータ投入 (Schema Filtering)
  - 提案: `_upsert_records(index, embedder, records, batch_size=16)` のようなヘルパー関数を作成し、共通処理を括り出してください。特に `index_from_json` は Schema Filtering が欠如しており、実装の不一致も見られます。

- **冗長なインポート（Low）**: `sessions_to_records` 関数内 (L89) で `from datetime import datetime as _dt` が行われていますが、ファイル冒頭 (L28) で既に `from datetime import datetime` が宣言されています。ループ内でのインポートは不要であり、可読性とパフォーマンスを損ないます。

## 重大度
Medium
