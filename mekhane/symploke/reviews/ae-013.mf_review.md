# シンプリシティの門番 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **未使用import**: `import os` がインポートされていますが、コード内で使用されていません。 (Low)
- **未使用変数**: `_original_stdout`, `_stderr_wrapper` に値が代入されていますが、その後参照されていません。 (Medium)
- **不要なsys.path追加**: `_mekhane_dir` を `sys.path` に追加していますが、全てのインポートは `from mekhane...` で行われており、`_project_root` だけで解決可能です。 (Low)
- **冗長なオブジェクト生成**: `search` ツール内で `source="both"` の場合、`EmbeddingAdapter` が2回インスタンス化され、モデルのロードとクエリのエンコードが2回実行されています。 (Medium)

## 重大度
Medium

## 修正提案
```python
<<<<<<< SEARCH
import sys
import os

# Platform-specific asyncio setup
=======
import sys

# Platform-specific asyncio setup
>>>>>>> REPLACE
<<<<<<< SEARCH
_original_stdout = sys.stdout
_stderr_wrapper = sys.stderr


# PURPOSE: log — MCPサービスの処理
=======
# PURPOSE: log — MCPサービスの処理
>>>>>>> REPLACE
<<<<<<< SEARCH
# Both paths needed: project root for `from mekhane.xxx` imports,
# mekhane dir for any relative imports within mekhane
for _p in [str(_project_root), str(_mekhane_dir)]:
    if _p not in sys.path:
        sys.path.insert(0, _p)
log(f"Added to path: {_project_root} + {_mekhane_dir}")
=======
# Only project root needed for `from mekhane.xxx` imports
if str(_project_root) not in sys.path:
    sys.path.insert(0, str(_project_root))
log(f"Added to path: {_project_root}")
>>>>>>> REPLACE
<<<<<<< SEARCH
            log(f"Searching for: {query}")
            results = []

            # Search Sophia
            if source in ("sophia", "both") and SOPHIA_INDEX.exists():
                adapter = EmbeddingAdapter()
                adapter.load(str(SOPHIA_INDEX))
                query_vec = adapter.encode([query])[0]
                sophia_results = adapter.search(query_vec, k=limit)

                for r in sophia_results:
                    results.append(
                        {
                            "source": "sophia",
                            "score": r.score,
                            "ki_name": r.metadata.get("ki_name", "N/A"),
                            "artifact": r.metadata.get("artifact", ""),
                            "summary": r.metadata.get("summary", "")[:150],
                            "file_path": r.metadata.get("file_path", ""),
                        }
                    )

            # Search Kairos
            if source in ("kairos", "both") and KAIROS_INDEX.exists():
                adapter = EmbeddingAdapter()
                adapter.load(str(KAIROS_INDEX))
                query_vec = adapter.encode([query])[0]
                kairos_results = adapter.search(query_vec, k=limit)

                from datetime import datetime, timedelta
=======
            log(f"Searching for: {query}")
            results = []

            # Initialize adapter once if needed
            search_sophia = source in ("sophia", "both") and SOPHIA_INDEX.exists()
            search_kairos = source in ("kairos", "both") and KAIROS_INDEX.exists()

            if search_sophia or search_kairos:
                adapter = EmbeddingAdapter()
                query_vec = adapter.encode([query])[0]

                # Search Sophia
                if search_sophia:
                    adapter.load(str(SOPHIA_INDEX))
                    sophia_results = adapter.search(query_vec, k=limit)

                    for r in sophia_results:
                        results.append(
                            {
                                "source": "sophia",
                                "score": r.score,
                                "ki_name": r.metadata.get("ki_name", "N/A"),
                                "artifact": r.metadata.get("artifact", ""),
                                "summary": r.metadata.get("summary", "")[:150],
                                "file_path": r.metadata.get("file_path", ""),
                            }
                        )

                # Search Kairos
                if search_kairos:
                    adapter.load(str(KAIROS_INDEX))
                    kairos_results = adapter.search(query_vec, k=limit)

                    from datetime import datetime, timedelta
>>>>>>> REPLACE
```
