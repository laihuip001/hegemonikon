# ハルシネーション検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/index.py`

## 判定
発言（要改善）

## 発見事項
- **Critical**: `LanceQueryBuilder` オブジェクト ( `table.search(...)` の戻り値 ) に `to_list()` メソッドは存在しません。
  - `to_pandas().to_dict('records')` や `to_arrow().to_pylist()` を使用すべきです。
  - 該当箇所:
    - `results = search_query.to_list()` ( `GnosisIndex.search` )
    - `results = (...).to_list()` ( `GnosisIndex.get_by_primary_key` )

- **High**: `search_query.where()` メソッドに `prefilter` 引数は存在しません。
  - `lancedb` の `where` は通常 SQL フィルタ文字列のみを受け取ります。
  - 該当箇所: `search_query.where(f"source = '{source_filter}'", prefilter=True)` ( `GnosisIndex.search` )

- **Medium**: `limit(None)` の使用は不適切である可能性があります。
  - `lancedb` (および多くのDBクライアント) の `limit` は整数を期待します。全件取得の場合は `limit` を省略するか、明示的な大きな数値を指定するのが一般的です。`None` を渡すとエラーになるか、予期しない動作をする恐れがあります。
  - 該当箇所: `table.search().select(["primary_key", "title"]).limit(None).to_pandas()` ( `GnosisIndex._load_primary_keys` )

## 重大度
Critical
