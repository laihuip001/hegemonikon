# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_monitor.py`

## 判定
発言（要改善）

## 発見事項

### 1. `session_info()` の戻り値に関する誤った仮定 (High)
`monitor_once` 関数内で `client.session_info()` の戻り値に `{"error": ...}` が含まれることを期待しているが、`AntigravityClient.session_info()` (引数なし) は RPC エラーや接続エラー時に例外 (`urllib.error.URLError` 等) を送出する実装になっている。

- **現状**: `if "error" in info:` ブロックはデッドコードとなっており、例外発生時は `monitor_once` 内でキャッチされず、特に `--once` モード実行時 (`main` 関数経由) にスクリプトがクラッシュする。
- **違反**: File A (`session_monitor.py`) が File B (`AntigravityClient`) のエラーハンドリング契約 (例外送出) を誤認している。
- **修正案**: `client.session_info()` 呼び出しを `try-except` ブロックで囲み、例外発生時に適切にエラーログを出力して `state` を返すように修正する。

### 2. Markdown フォーマットロジックの重複 (Medium)
`format_session_md` 関数は、`AntigravityClient` に追加された `archive_sessions` メソッド (Proposal D: Session Archive) と同様の Markdown 出力ロジックを独自に実装している。

- **現状**: ライブラリ側 (`AntigravityClient`) と利用者側 (`session_monitor.py`) で類似のフォーマットロジックが重複しており、将来的なフォーマット変更時に不整合が生じるリスクがある。
- **違反**: File A が File B の提供する機能 (`archive_sessions`) を利用せず、内部構造 (データ形式) を前提に再実装している (DRY 原則違反)。
- **修正案**: `AntigravityClient` の `archive_sessions` メソッドを利用するか、フォーマットロジックを共通化する。あるいは `session_monitor.py` が独自フォーマットを維持する意図を明記する。

### 3. 出力ディレクトリの不一致 (Low)
`OUTPUT_DIR` が `~/.hegemonikon/sessions` にハードコードされているが、`AntigravityClient` は `~/.ochema/sessions` をデフォルトのアーカイブ先としている。

- **現状**: 成果物の出力先がツール間で分散している (`.hegemonikon` vs `.ochema`)。
- **違反**: 定数/設定値の暗黙的な共有違反 (ディレクトリ構成の不一致)。
- **修正案**: `AntigravityClient` 側で推奨されるディレクトリ定数を公開し、それを参照するか、プロジェクト全体で統一する。

## 重大度
High
