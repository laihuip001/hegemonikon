# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/ochema/__init__.py`

## 判定
発言（要改善）

## 発見事項
- **Critical (Encapsulation Violation)**: `mekhane/mcp/ochema_mcp_server.py` および `mekhane/anamnesis/session_indexer.py` が `AntigravityClient` のプライベートメソッド `_rpc` を直接呼び出し、かつ RPC エンドポイント文字列 `"exa.language_server_pb.LanguageServerService/GetAllCascadeTrajectories"` をハードコードしています。これは `proto.py` の定数 (`RPC_GET_TRAJECTORIES`) と重複しており、Single Source of Truth 原則に違反します。プロトコル変更時に破損するリスクが高いです。
- **High (Private Method Usage)**: `mekhane/mcp/hgk_gateway.py` の `hgk_ask` 関数が、既存セッションへの追記を実現するために `AntigravityClient` のプライベートメソッド `_send_message` と `_poll_response` を直接呼び出しています。これは `AntigravityClient.ask` が新規セッションのみをサポートし、継続セッション用の公開 API が欠如しているため、利用側がカプセル化を破ることを強いられている状態です。
- **High (Private Method Usage)**: `mekhane/anamnesis/session_indexer.py` が `_rpc` を使用している理由は、公開メソッド `session_info()` が返す要約情報に `workspaces` フィールドが含まれていないためです。必要なデータが公開 API から取得できないため、内部構造への依存が発生しています。
- **Medium (Redundant Logic)**: `mekhane/mcp/ochema_mcp_server.py` の `session_info` ツール実装は、`AntigravityClient.session_info()` が既に提供しているロジック（RPC呼び出しと整形）を再実装しています。不必要なコード重複であり、保守性を低下させています。

## 重大度
High
