# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/ergasterion/digestor/pipeline.py`

## 判定
発言（要改善）

## 発見事項
- **重複排除ロジックの乖離と再実装 (Medium)**:
  `_fetch_from_gnosis` メソッド内で `arxiv_id` -> `url` -> `id` の優先順位で重複排除を行っているが、これは `mekhane/anamnesis/models/paper.py` の `Paper.primary_key` プロパティ（`doi` -> `arxiv_id` -> `source:source_id`）の実装と乖離している。`Paper` モデルが定義する「同一性」の定義を無視し、独自の（そして不完全な）ロジックを再実装しているため、将来的なモデル変更に追随できないリスクがある。

- **ベクトルモデルの暗黙的仮定 (High)**:
  `_deduplicate_by_similarity` メソッドにおいて、外部ファイル `sophia.pkl` から読み込んだベクトルと、`EmbeddingAdapter`（デフォルト設定）で生成したベクトルを直接比較（内積計算）している。
  `sophia.pkl` に保存されたベクトルがどのモデルで生成されたかを確認する機構がなく、環境変数 `EMBEDDING_MODEL` やデフォルトモデルが変更された場合、異なる埋め込み空間のベクトル同士を比較することになり、類似度判定が完全に無意味になる（かつエラーも出ないため検知困難）。

- **ハードコードされたパス構造 (Medium)**:
  `~/.hegemonikon/digestor` や `~/.hegemonikon/sophia/sophia.pkl` といったパスがハードコードされており、システム全体のディレクトリ構造に対する暗黙の契約となっている。これらは設定ファイルや環境変数、あるいは共通の定数定義から参照されるべきである。

## 重大度
High
