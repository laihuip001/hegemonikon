# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項
- **(High) `DigestorPipeline.run` の戻り値型不一致**
  - `hgk_digest_run` 関数内で `pipeline.run()` の戻り値を `dict` と想定して分岐処理 (`if isinstance(report, dict):`) を行っているが、実際には `DigestResult` データクラスのインスタンスが返される。
  - このため、意図された構造化出力フォーマット（取得数、候補数などの表示）がスキップされ、データクラスの文字列表現 (`str(report)`) がそのまま出力される状態となっている。
  - `report.get('fetched')` 等の辞書アクセスも `DigestResult` の属性 (`total_papers` 等) と一致していない。

- **(High) `DigestCandidate` の新規フィールド `suggested_templates` が無視されている**
  - `DigestCandidate` データクラスに追加された `suggested_templates` フィールド（テンプレート推奨機能）が、`hgk_digest_list` での表示に反映されていない。
  - 重要な機能追加（C改善）が利用側に波及しておらず、モバイルからの確認時に情報が欠落している。

- **(Medium) `AntigravityClient` の非公開メソッドへの依存**
  - `hgk_ask` 関数内で、既存セッションへのメッセージ送信を実現するために `client._send_message` および `client._poll_response` という非公開メソッド（`_`で始まる）を直接呼び出している。
  - 内部実装の変更により突然動作しなくなるリスクがある（カプセル化の破壊）。

- **(Medium) `min_score` 設定値の不一致（構成ファイルの無視）**
  - `topics.yaml` では `min_score: 0.45` と定義されているが、`hgk_gateway.py` 経由で呼び出される `pipeline.run` → `selector.select_candidates` はデフォルト引数の `0.3` を使用している。
  - `hgk_digest_topics` では `topics.yaml` の値を表示しているため、表示（0.45）と実際の動作（0.3）に不整合が生じている。

## 重大度
High
