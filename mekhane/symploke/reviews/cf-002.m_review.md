# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/fep/derivative_selector.py`

## 判定
発言（要改善）

## 発見事項
- **Enum非網羅 (High)**: `derivative_selector.py` は O/S/H/P/K/A の全6シリーズ（計72派生）を定義しているが、主要な利用側である `mekhane/workflow_runner.py` 内の `DERIVATIVE_PROCESSING_HINTS` は O1 と A2 の派生しか定義していない。
  - 結果として、S/H/P/K シリーズの派生が選択された場合、`workflow_runner.py` はデフォルトの "デフォルト処理" ヒントにフォールバックし、ドメイン固有の処理ロジックが欠落する。これは `derivative_selector.py` の拡張（全シリーズ対応）に対し、利用側が追従していない典型的な暗黙契約違反である。

- **シグネチャ不一致 (Medium)**: `select_derivative` 関数に `use_llm_fallback` 引数が追加された（v3.1）が、`mekhane/workflow_runner.py` の `run_workflow` 関数はこの引数を公開・伝播していない。
  - `workflow_runner` の利用者は LLM フォールバックの有無を制御できず、`derivative_selector.py` のデフォルト値（`True`）に強制的に従属することになる。これは機能追加が利用側に隠蔽されている状態である。

- **フィールド未対応 (Low)**: `DerivativeRecommendation` dataclass と `workflow_runner.py` の `WorkflowResult` dataclass は大部分のフィールド（`theorem`, `derivative`, `confidence`, `rationale`, `alternatives`）が重複しており、手動同期が必要な構造になっている。
  - 現時点では不一致はないが、`DerivativeRecommendation` にフィールドが追加された場合、`WorkflowResult` への反映漏れが発生するリスクが高い構造的脆弱性がある。

## 重大度
High
