# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **知識テーブル (`knowledge`) のスキーマ不一致 (High)**
  - `session_indexer.py` は `GnosisIndex.TABLE_NAME` ("knowledge") を使用していますが、`mekhane/anamnesis/models/paper.py` で定義された `Paper` スキーマとは異なる構造のデータを挿入しています。
  - `Paper` スキーマ: `id`, `source_id`, `published`, `pdf_url`, `categories` 等が標準。
  - `session_indexer` スキーマ: `content` (独自), `step_count` (独自), `primary_key` (共通だが生成規則が異なる可能性)。
  - `GnosisIndex` (および `session_indexer.py` 自身) は "P4 pattern" (既存テーブルのスキーマに合わせてフィールドをフィルタリングする) を実装しているため、テーブルを作成した側のスキーマが優先され、後から書き込む側の独自フィールド (`content` 等) が**無言で削除**されるリスクがあります。これは重大なデータ損失を引き起こします。

- **モジュールレベルでの副作用 (High)**
  - `sys.path.insert` をモジュールレベルで実行しており、このファイルをインポートする全てのモジュールに影響を与えます。

- **内部実装への過度な依存 (Medium)**
  - `GnosisIndex` の `add_papers` メソッドを利用せず、`index.db` や `Embedder` を直接操作してインデックス処理を再実装しています。これにより `GnosisIndex` 側のロジック変更（重複排除ロジックの改善など）に追随できなくなります。
  - `agq-sessions.sh` への相対パス依存 (`../../scripts/agq-sessions.sh`) がハードコードされています。

## 重大度
High
