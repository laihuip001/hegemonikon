# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/index.py`

## 判定
発言（要改善）

## 発見事項
- (High) モジュールレベルでの `sys.stdout.reconfigure(encoding="utf-8")` (Windows環境下) の実行。インポートするだけでグローバルな標準出力エンコーディングを変更してしまう副作用があり、ライブラリとしての暗黙の契約（副作用のないインポート）に違反している。
- (High) `GnosisIndex.add_papers` メソッドにおいて、`Paper` データクラスに新規フィールドが追加された場合、既存のデータベーススキーマに存在しないフィールドは黙って削除される（`filtered_data = ...`）。呼び出し側はデータが永続化されたと仮定するが、実際にはスキーマ不一致により一部データが欠損するため、データクラス変更時の暗黙の契約に違反している。
- (Medium) `Embedder` クラスにおいて、`sentence-transformers` が利用できない場合のフォールバック（ONNX）が `bge-small` (384次元) に固定されている。デフォルトの `bge-m3` (1024次元) を期待して初期化された場合でも、環境によって次元数が変化し、既存のインデックスに対する検索が次元不一致によりサイレントに失敗（空リストを返す）する。これは環境依存による暗黙の契約違反である。

## 重大度
High
