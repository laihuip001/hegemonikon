# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_monitor.py`

## 判定
発言（要改善）

## 発見事項
- **Orphaned Output (Critical)**: 本ファイルが生成する `live_*.md` ファイルは、記憶システムの中核である `session_indexer.py` のインデックス対象（`handoff_*.md`, `*_conv_*.md` のみ）に含まれていません。結果として、モニターされたセッション記録は記憶システムから完全に無視されており、ファイル生成と消費の契約が不成立です。
- **Implicit Schema Dependency (High)**: `AntigravityClient.session_read` が返す辞書の内部構造（特に `conversation` リスト内の `role`, `content`, `model`, `tool`, `status` キー）に強く依存しています。`AntigravityClient` は `LLMResponse` dataclass を定義していますが、`session_read` は依然として非構造化辞書を返しており、API変更時の脆弱性が高い状態です。
- **Logic Duplication (High)**: `format_session_md` 関数における Markdown 生成ロジックは、`antigravity_client.py` 内の `archive_sessions` (Proposal D) や `session_indexer.py` のロジックと重複しています。フォーマット変更が必要な場合、複数箇所の修正が必要となり、整合性が崩れるリスクがあります。
- **Global Side Effect (Medium)**: `sys.path.insert(0, str(_HEGEMONIKON_ROOT))` により、実行環境のモジュール探索パスをグローバルに変更しています。これは他モジュールからインポートされた場合に予期せぬ副作用を引き起こす可能性があります。
- **Path Duplication (Medium)**: 出力先ディレクトリ `.../.hegemonikon/sessions` が `session_indexer.py` (`_HANDOFF_DIR`, `_EXPORT_DIR`) と個別にハードコードされています。ディレクトリ構成の変更時に同期漏れが発生する契約違反です。
- **Magic Number Duplication (Low)**: `MAX_SESSIONS = 20` が定義されていますが、これは `AntigravityClient.session_info` のデフォルト値 `20` と重複しており、Single Source of Truth 原則に違反しています。

## 重大度
High
