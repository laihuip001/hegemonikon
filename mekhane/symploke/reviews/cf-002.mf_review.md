# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **(High) Kairos Index メタデータフィールド不一致**: `sophia_mcp_server.py` は Kairos インデックス内の全ドキュメントが `primary_task` フィールドを持つことを前提としていますが、`kairos_ingest.py` が生成する `conversation` / `conversation_chunk` タイプのドキュメントは `primary_task` を持たず、代わりに `title` を使用します。これにより、検索結果で会話ログが「N/A」と表示されます。
- **(Medium) インデックスパスのハードコーディング**: `sophia_mcp_server.py` は `SOPHIA_INDEX` および `KAIROS_INDEX` のパスをハードコーディングしており、`sophia_ingest.py` / `kairos_ingest.py` が使用する環境変数 `HGK_SOPHIA_INDEX` などを無視しています。環境依存の設定が不一致になるリスクがあります。
- **(Medium) 知識ディレクトリパスのハードコーディング**: `sophia_mcp_server.py` は `SophiaBacklinker` を使用していますが、`SophiaBacklinker` 内部で `KNOWLEDGE_DIR` がハードコーディングされており、`sophia_ingest.py` の `HGK_KNOWLEDGE_DIR` 環境変数によるオーバーライド設定と整合性が取れていません。

## 重大度
High
