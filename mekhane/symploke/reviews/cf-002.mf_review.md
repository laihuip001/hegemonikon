# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/api/routes/chat.py`

## 判定
発言（要改善）

## 発見事項
- **カプセル化違反 (High)**: `OchemaService._get_cortex_client()` および `CortexClient._get_token()`, `_get_project()` という protected method に直接アクセスしている。これらは `ochema` モジュールの内部実装であり、公開 API ではないため、将来的な実装変更により `chat.py` が破損するリスクが高い（暗黙の契約への依存）。
- **設定値の暗黙的無視 (Medium)**: `ChatRequest.generation_config` (temperature, maxOutputTokens) が API モデル定義に含まれているが、`cortex-gemini` モデルおよび `claude-*` モデルのリクエスト処理ではこれらが静かに無視されている。クライアントは設定が有効であると期待するが、実際にはデフォルト値または制御不能な値が使用される。これは API の契約違反である。
- **責務の漏洩 (Medium)**: Cortex API の `:generateChat` エンドポイント呼び出しロジックが `chat.py` 内にハードコードされている。本来 `CortexClient` または `OchemaService` が提供すべき機能（無課金枠利用など）がルーター層に漏れ出しており、認証トークンの取得ロジックなどと密結合している。

## 重大度
High
