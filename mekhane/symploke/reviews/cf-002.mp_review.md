# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/index.py`

## 判定
発言（要改善）

## 発見事項
- (Medium) グローバル副作用: `sys.stdout.reconfigure(encoding="utf-8")` がモジュールレベルで実行され、インポートするだけで全プロセスの標準出力エンコーディングを変更してしまう。
- (High) 暗黙のロジック / 次元不一致: `Embedder` クラスが、初期化時の指定 (`bge-m3` / 1024次元) に反して内部で `bge-small` (ONNX / 384次元) にサイレントフォールバックする挙動を持つ。これにより、呼び出し側 (`library_search.py` 等) が期待する次元数と異なるベクトルが返され、既存インデックスとの整合性が崩壊する可能性がある。
- (Medium) 定数旧値参照: `GnosisIndex.TABLE_NAME` ("knowledge") が `gnosis_chat.py` や `proactive_push.py` 内でハードコードされた文字列リテラルとして参照されており、定数変更時に追従できない。
- (Low) 曖昧な戻り値: `GnosisIndex.search` が `list[dict]` を返すが、そのキー構成は挿入元 (`add_papers`, `session_indexer`) に依存するダックタイピングであり、利用側 (`gnosis_chat.py`) が特定のキー (`content` 等) の存在を暗黙に仮定している。

## 重大度
High
