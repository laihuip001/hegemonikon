# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/mcp/ochema_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **Critical (シグネチャ不一致/隠蔽メソッド呼び出し):**
  - `session_info` ツールが `svc._get_ls_client()` でプライベートな LS クライアントを取得し、さらにそのプライベートメソッド `_rpc` を直接呼び出している。
  - `AntigravityClient` の内部実装 (`_rpc` のシグネチャや戻り値構造) に強く依存しており、クライアント側の変更で即座に破損する。
  - 正規の公開 API である `svc.session_info()` または `svc.context_health()` を使用すべきである。

- **High (Enum/リストの非網羅・重複):**
  - `ask` および `ask_cortex` ツールの `description` にハードコードされたモデルリストが、`mekhane/ochema/service.py` の `AVAILABLE_MODELS` や `_LS_PROTO_MODELS` と重複している。
  - `service.py` に新しいモデル (例: `cortex-gemini`) が追加されても、MCP サーバーのツール定義には反映されず、利用者は新モデルの存在を知る手段がない。
  - `AVAILABLE_MODELS` を動的に参照してツール定義を生成するか、定数として共有すべきである。

- **Medium (定数/ロジックの重複):**
  - `session_info` ツール内で Context Rot (コンテキスト腐敗) の判定ロジック (30/50ステップ閾値) を独自に実装している。
  - これは `AntigravityClient.context_health` および `OchemaService.context_health` に存在するロジックと重複しており、判定基準の変更が二重管理となる。

## 重大度
Critical
