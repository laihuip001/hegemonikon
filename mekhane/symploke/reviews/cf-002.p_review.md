# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項

- **Kairos インデックススキーマの不一致 (High)**
  - `sophia_mcp_server.py` は `KairosIndex` 内のドキュメントがすべて `primary_task` メタデータを持つと仮定しています。
  - しかし、`mekhane/symploke/kairos_ingest.py` は `conversation` や `conversation_chunk` タイプのドキュメントも生成し、これらは `primary_task` の代わりに `title` を持ちます。
  - 結果として、会話ログが検索結果に含まれる場合、タスク名が "N/A" となり、利用者に混乱を与えます。これはデータ構造の暗黙的な契約違反です。

- **安全でないモジュールインポートの副作用 (High)**
  - `sophia_mcp_server.py` は `mekhane.symploke.sophia_backlinker` を `try...except Exception` ブロック内でインポートしています。
  - `sophia_backlinker.py` はトップレベルで `networkx` のインポートに失敗すると `sys.exit(1)` を実行します。
  - `sys.exit` は `SystemExit` 例外を送出しますが、これは `Exception` を継承していないため、`sophia_mcp_server.py` の例外処理をすり抜けてサーバープロセス全体を終了させます。
  - これは「ライブラリモジュールのインポートはプロセスを終了させるべきではない」という暗黙の契約に違反しています。

- **環境依存の絶対パス (Medium)**
  - `SOPHIA_INDEX` および `KAIROS_INDEX` が特定のユーザー環境 (`/home/makaron8426/...`) の絶対パスとしてハードコードされています。
  - `mekhane/symploke/sophia_ingest.py` など他のモジュールでは相対パスや環境変数 (`HGK_SOPHIA_INDEX`) を使用しており、単一情報源 (SSOT) の原則および環境非依存の契約に違反しています。

## 重大度
High
