# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/pks/pks_engine.py` (substituted for missing `mekhane/periskope/engine.py`)

## 判定
発言（要改善）

## 発見事項
- **High**: `KnowledgeNugget` dataclass に対する未定義フィールド `metadata` の注入
    - `mekhane/pks/gateway_bridge.py` が `KnowledgeNugget` インスタンスに `metadata` 属性を動的に付与・参照しているが、`pks_engine.py` 内の定義には存在しない。
    - Dataclass の構造的契約を違反しており、将来的に `__slots__` 等が導入された場合に破損する脆弱性がある。
- **Medium**: 循環依存と共有モデルの配置不備
    - `pks_engine.py` が `SelfAdvocate` や `GatewayBridge` を利用する一方で、それらのモジュールが `pks_engine.py` から `KnowledgeNugget`, `SessionContext` をインポートしている。
    - モデル定義 (`KnowledgeNugget`, `SessionContext`) は独立したモジュール (`models.py` 等) に切り出すべきである。
- **Medium**: `GnosisIndex` 検索結果に対する暗黙の辞書キー依存
    - `RelevanceDetector.score` メソッドが `search_results` (dict) の `_distance`, `title`, `abstract`, `source` 等のキー存在を前提としている。
    - `GnosisIndex` (外部) の実装変更によりキー名が変わった場合、静的解析で検出できないランタイムエラーを引き起こす。

## 重大度
High
