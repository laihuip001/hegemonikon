# 暗黙契約違反検出者 レビュー

## 対象ファイル
`hermeneus/src/executor.py`

## 判定
発言（要改善）

## 発見事項

- **[Critical] アーキテクチャ階層違反 (循環依存)**
  - `executor.py` が使用する `hermeneus/src/runtime.py` および `hermeneus/src/verifier.py` は、上位レイヤーである `mekhane` パッケージ (`mekhane.ochema`, `mekhane.anamnesis`) をインポートしています。
  - プロジェクトの依存フロー `kernel/ (理論) → hermeneus/ (CCL) → mekhane/ (実装)` に違反しており、`hermeneus` が `mekhane` に依存する逆流が発生しています。
  - `executor.py` はこの違反構造の上に成り立っており、`mekhane` の変更（例: `AntigravityClient` や `SophiaIndex` のシグネチャ変更）の影響を直接受ける脆弱な状態です。

- **[Medium] データクラス定義の重複と不整合リスク**
  - `hermeneus/src/verifier.py` 内に `AuditRecord` クラスが定義されていますが、これは `hermeneus/src/audit.py` の `AuditRecord` と定義が異なります（フィールド不一致）。
  - `executor.py` は `audit.py` の定義を使用していますが、同一パッケージ内に異なる定義の同名クラスが存在することは、将来的なインポートミスや保守時の混乱（契約の曖昧さ）を招きます。
  - `_phase_audit` メソッド内で `AuditRecord` を手動でインスタンス化しており、`audit.py` の内部構造（フィールド順序・デフォルト値）に強く結合しています。

- **[Low] 非効率な再コンパイル (冗長ロジック)**
  - `_phase_compile` で一度 CCL をコンパイルし `pipeline.lmql_code` に格納しているにもかかわらず、`_phase_execute` 内で再度 `compile_ccl` を呼び出しています。
  - `compile_ccl` が副作用を持たないという暗黙の仮定に依存しており、無駄な計算リソースを消費しています。

## 重大度
Critical
