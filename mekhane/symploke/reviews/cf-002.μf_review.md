# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/api/server.py`

## 判定
発言（要改善）

## 発見事項
- **[High] 暗黙の名前空間共有 (Namespace Collision Risk)**:
  `mekhane/api/server.py` は `gnosis` と `gnosis_narrator` の両方のルーターを登録していますが、これらはどちらも内部で `prefix="/gnosis"` を定義しています。FastAPI はこれをマージしますが、ファイル間でエンドポイント（パス）が衝突しないという「暗黙の契約」に強く依存しており、将来的な拡張で競合するリスクが高い状態です。明示的にプレフィックスを分けるか、統合ルーターを介すべきです。

- **[High] 依存関係の隠蔽 (Hidden Dependency)**:
  `chat` ルーターの登録箇所で「httpx に依存するため遅延ロード」とコメントされていますが、実際には `mekhane/api/routes/chat.py` は `mekhane.ochema.service` に強く依存しており、これはさらに `google-generativeai` や `Cortex` などの重量級ライブラリに依存しています。`server.py` 側での `try-except` は `ImportError` を捕捉しますが、コメントが示す依存範囲と実態が乖離しており、環境構築時のトラブル要因となります。

- **[Medium] 遅延ロードの無効化 (Ineffective Lazy Loading)**:
  各ルーターの登録は `_register_routers` 関数内で `import` 文を実行することで「遅延ロード (Lazy Load)」または「安全なロード (Safe Load)」を意図していますが、ファイル末尾の `app = create_app()` がモジュールレベルで即座に実行されるため、`mekhane/api/server.py` をインポートした時点で全てのルーターのインポートが走ります。これにより、テスト時や一部機能利用時にも全依存関係が解決される必要があり、意図した「遅延」効果が得られていません。

## 重大度
High
