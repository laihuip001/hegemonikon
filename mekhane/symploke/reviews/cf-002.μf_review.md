# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **Critical:** `GnosisIndex` のカプセル化違反。`session_indexer.py` は `GnosisIndex.add_papers()` を使用せず、`index.db` および `index.TABLE_NAME` に直接アクセスしてデータを挿入している。これにより `GnosisIndex` 内部の実装（テーブル管理、重複排除ロジック）への依存が生じており、将来的な変更（例: テーブル分割、バリデーション追加）に脆弱である。
- **High:** スキーマ不整合。`session_indexer.py` は `content`, `year`, `step_number` などのフィールドを含むレコードを作成しているが、これらは `GnosisIndex` が正規化に使用する `Paper` データクラス（`mekhane.anamnesis.models.paper`）には存在しない。`GnosisIndex` がテーブルを作成した場合、これらのフィールドは欠落する可能性がある（またはその逆）。
- **High:** ロジックの重複。埋め込み生成（バッチ処理）や重複排除のロジックが `session_indexer.py` 内で再実装されており、`GnosisIndex.add_papers` と二重管理状態になっている。

## 重大度
Critical
