# 暗黙契約違反検出者 レビュー

## 対象ファイル
`mekhane/ergasterion/digestor/pipeline.py`

## 判定
発言（要改善）

## 発見事項
- **Sophia インデックス内部構造への直接依存 (High)**
  - `_load_existing_keys` および `_deduplicate_by_similarity` メソッドにおいて、`EmbeddingAdapter` が生成した `sophia.pkl` を `pickle.load` で直接読み込み、`vectors` や `metadata` キーに直接アクセスしています。
  - `EmbeddingAdapter` の内部保存フォーマット（`save` メソッドの実装）に対する暗黙の契約が発生しており、将来的に `EmbeddingAdapter` がフォーマットを変更した場合（例: キー名の変更、safetensors への移行など）、このファイルは破損します。
  - 推奨: `EmbeddingAdapter.load` メソッドを使用するか、データアクセス層を経由すべきです。

- **Gnosis インデックスのスキーマへの直接依存 (Medium)**
  - `_load_existing_keys` メソッドにおいて、`~/.hegemonikon/gnosis` 以下の JSON ファイルを直接走査し、`primary_key` や `id` フィールドの存在を仮定しています。
  - `Paper.to_dict()` の出力形式に対する暗黙の契約ですが、ファイルシステムとJSON構造への直接依存は脆いです。

- **予防ルールの欠如 (Medium)**
  - プロジェクトの `.pre-commit-config.yaml` において `ruff` 等の静的解析が無効化されており、このような暗黙の契約や型不一致を検出する自動化された仕組みが機能していません。

## 重大度
High
