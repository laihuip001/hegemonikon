# ãƒã‚¹ãƒˆæ·±åº¦è­¦å ±è€… ãƒ¬ãƒ“ãƒ¥ãƒ¼

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`mekhane/mcp/hgk_gateway.py`

## åˆ¤å®š
ç™ºè¨€ï¼ˆè¦æ”¹å–„ï¼‰

## ç™ºè¦‹äº‹é …

### 1. `hgk_search` (High)
- **æ·±åº¦**: 5æ®µ (if -> if -> for -> if -> if)
- **ç®‡æ‰€**: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢éƒ¨åˆ†ã® `KI (Knowledge Items)` æ¢ç´¢ãƒ«ãƒ¼ãƒ—ã€‚
- **è©³ç´°**: `if mode in ...` å†…ã§ `if ki_base.exists()` -> `for ki_dir` -> `if ki_dir.is_dir()` -> `if metadata_path.exists()` ã¨æ·±ããƒã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚
- **ææ¡ˆ**:
  - `_search_ki(query)`, `_search_doxa(query)`, `_search_handoff(query)` ã®ã‚ˆã†ã«æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ¥é–¢æ•°ã«åˆ‡ã‚Šå‡ºã™ã€‚
  - ã‚¬ãƒ¼ãƒ‰ç¯€ã‚’ä½¿ç”¨ã—ã¦ `if not ki_base.exists(): return` ã®ã‚ˆã†ã«æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã™ã‚‹ã€‚

### 2. `hgk_digest_check` (High)
- **æ·±åº¦**: 5æ®µ (for -> try -> for -> if -> if)
- **ç®‡æ‰€**: `incoming/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«è§£æãƒ«ãƒ¼ãƒ—ã€‚
- **è©³ç´°**: `for f in files` -> `try` -> `for line in content` -> `if line == "---"` -> `if in_frontmatter` ã¨ãƒã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚
- **ææ¡ˆ**:
  - ãƒ•ã‚¡ã‚¤ãƒ«1ä»¶ã®è§£æå‡¦ç†ã‚’ `_parse_digest_candidate(file_path) -> str` ã¨ã—ã¦é–¢æ•°åŒ–ã™ã‚‹ã€‚
  - Frontmatter ã®ãƒ‘ãƒ¼ã‚¹ã«ã¯ `python-frontmatter` ç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œè¨ã‹ã€å°‚ç”¨ã®ãƒ‘ãƒ¼ã‚¹é–¢æ•° `_extract_frontmatter(content)` ã‚’ä½œæˆã™ã‚‹ã€‚

### 3. `hgk_health` (High)
- **æ·±åº¦**: 5æ®µ (if -> try -> with -> for -> if)
- **ç®‡æ‰€**: `health_metrics.jsonl` ã®èª­ã¿è¾¼ã¿éƒ¨åˆ†ã€‚
- **è©³ç´°**: `if health_file.exists()` -> `try` -> `with open` -> `for line` -> `if line.strip()`ã€‚
- **ææ¡ˆ**:
  - `_read_last_health_metric(file_path)` é–¢æ•°ã«åˆ‡ã‚Šå‡ºã™ã€‚
  - `collections.deque(f, 1)` ã‚’ä½¿ã£ã¦æœ€çµ‚è¡Œã ã‘åŠ¹ç‡çš„ã«èª­ã‚€ã€‚

### 4. `hgk_notifications` (High)
- **æ·±åº¦**: 4æ®µ (try -> with -> for -> if)
- **ç®‡æ‰€**: `notifications.jsonl` ã®èª­ã¿è¾¼ã¿éƒ¨åˆ†ã€‚
- **è©³ç´°**: `try` -> `with open` -> `for line` -> `if line`ã€‚
- **ææ¡ˆ**:
  - `_read_notifications(file_path, limit)` é–¢æ•°ã«åˆ‡ã‚Šå‡ºã™ã€‚
  - JSONL èª­ã¿è¾¼ã¿ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œæˆã™ã‚‹ã€‚

### 5. `hgk_paper_search` (Medium/High)
- **æ·±åº¦**: 4æ®µ (try -> for -> if -> if)
- **ç®‡æ‰€**: æ¤œç´¢çµæœã®æ•´å½¢ãƒ«ãƒ¼ãƒ—ã€‚
- **è©³ç´°**: `try` -> `for paper` -> `if abstract` -> `if len(abstract)`.
- **ææ¡ˆ**:
  - è«–æ–‡1ä»¶ã®æ•´å½¢å‡¦ç†ã‚’ `_format_paper_entry(paper)` é–¢æ•°ã«åˆ‡ã‚Šå‡ºã™ã€‚

### 6. `hgk_doxa_read` (Medium/High)
- **æ·±åº¦**: 4æ®µ (for -> try -> if -> for)
- **ç®‡æ‰€**: Doxa ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ã‚¹éƒ¨åˆ†ã€‚
- **è©³ç´°**: `for df` -> `try` -> `if isinstance` -> `for item`ã€‚
- **ææ¡ˆ**:
  - `_format_doxa_content(data)` é–¢æ•°ã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿å‹ã«å¿œã˜ãŸå‡¦ç†ã‚’å§”è­²ã™ã‚‹ã€‚

## ä¿®æ­£ã‚³ãƒ¼ãƒ‰ææ¡ˆ (æŠœç²‹)

```python
# hgk_search ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¾‹

def _search_ki(query: str, ki_base: Path) -> list[str]:
    """KI (Knowledge Items) ã‚’æ¤œç´¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°"""
    results = []
    if not ki_base.exists():
        return results

    query_lower = query.lower()
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ•ãƒ©ãƒƒãƒˆã«å‡¦ç†
    ki_dirs = [d for d in ki_base.iterdir() if d.is_dir()]

    for ki_dir in ki_dirs:
        metadata_path = ki_dir / "metadata.json"
        if not metadata_path.exists():
            continue

        try:
            meta = json.loads(metadata_path.read_text(encoding="utf-8"))
            summary = meta.get("summary", "")
            title = meta.get("title", ki_dir.name)

            if query_lower in title.lower() or query_lower in summary.lower():
                results.append(f"ğŸ“š **KI: {title}**\n   {summary[:150]}...")
        except Exception:
            continue

    return results

# hgk_search æœ¬ä½“
@mcp.tool()
@_traced
def hgk_search(query: str, max_results: int = 5, mode: str = "hybrid") -> str:
    results = []

    # ... (ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯ãã®ã¾ã¾) ...

    if mode in ("hybrid", "keyword"):
        # Helper functions keep main logic flat
        ki_base = Path.home() / ".gemini" / "antigravity" / "knowledge"
        results.extend(_search_ki(query, ki_base))

        results.extend(_search_doxa(query, DOXA_DIR))

        results.extend(_search_handoff(query, SESSIONS_DIR))

    # ...
```

## é‡å¤§åº¦
High
