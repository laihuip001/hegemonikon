# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/api/routes/chat.py`

## 判定
発言（要改善）

## 発見事項
- `chat_send` 関数内の `stream_proxy` にて、`async with` が2重になり、その内部の `if resp.status_code != 200` が深さ5に達している (High)
- 同 `stream_proxy` 内の `async for chunk` も深さ5に達している (High)
- `cortex_chat` 関数内の `stream_cortex` にて、`async with` 内の `try` ブロック内の `if response.status_code != 200` が深さ5に達している (High)
- `_claude_chat_from_gemini_format` 内で `if req.system_instruction` -> `if sys_parts` -> `if sys_text` とネストし、深さ4に達している (High)
- `_cortex_chat_from_gemini_format` 内で `for` ループ内の `if content.role == "user"` -> `if user_message` とネストし、深さ4に達している (High)

### 修正提案

1. **`stream_proxy` の平坦化**: `async with` を1行にまとめ、早期リターンを活用する。
   ```python
   async def stream_proxy():
       async with httpx.AsyncClient(timeout=120.0) as client:
           async with client.stream(...) as resp:
               if resp.status_code != 200:
                   # ... エラー処理
                   return
               async for chunk in resp.aiter_bytes():
                   yield chunk
   ```
   ↓
   ```python
   async def stream_proxy(url: str, body: dict):
       async with httpx.AsyncClient(timeout=120.0) as client, \
                  client.stream("POST", url, json=body, headers={"Content-Type": "application/json"}) as resp:
           if resp.status_code != 200:
               # ... エラー処理
               return
           async for chunk in resp.aiter_bytes():
               yield chunk
   ```

2. **`_claude_chat_from_gemini_format` の抽出**: システム指示の抽出処理を別関数 `_extract_system_instruction` に切り出す。
   ```python
   def _extract_system_instruction(instruction: dict | None) -> str:
       if not instruction: return ""
       parts = instruction.get("parts", [])
       if not parts: return ""
       return parts[0].get("text", "")
   ```

3. **`_cortex_chat_from_gemini_format` の条件整理**:
   ```python
   for content in req.contents:
       # ...
       if content.role == "user":
           if user_message:
               history.append(...)
           user_message = text
   ```
   ↓
   ```python
   for content in req.contents:
       # ...
       if content.role == "user" and user_message:
           history.append(...)
       if content.role == "user":
           user_message = text
   ```

## 重大度
High
