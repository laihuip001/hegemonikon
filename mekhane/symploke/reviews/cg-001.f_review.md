# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/ergasterion/digestor/pipeline.py`

## 判定
発言（要改善）

## 発見事項
- **`_fetch_from_gnosis` (High)**: `try` ブロック内の `for` ループ（`queries`）内でさらに `if`、`for` ループ（リトライ）、`try` ブロック、`if` がネストしており、最大深度6に達しています。
  - 提案: リトライロジックを独立したメソッド `_search_with_retry` に抽出する。
- **`_load_existing_keys` (High)**: `try` ブロック内の `if`、`for` ループ（ファイル）、`try`、`with`、`if`、`for` ループ（アイテム）、`if`、`if` と続き、最大深度9に達しています。
  - 提案: JSONファイルの読み込みとキー抽出ロジックを `_load_keys_from_json` メソッドに抽出する。
- **`_deduplicate_by_similarity` (High)**: `try` ブロック内の `for` ループ（論文）、`for` ループ（ベクトル）、`if`、`if` がネストしており、最大深度5に達しています。
  - 提案: ベクトル類似度計算部分を `_calculate_max_similarity` メソッドに抽出する。
- **`_save_report` (Medium)**: リスト内包表記の中にリスト内包表記が含まれています（`suggested_templates`）。
  - 提案: `suggested_templates` の整形ロジックをヘルパー関数に抽出する。
- **`_generate_eat_batch` (Medium)**: `for` ループ内の `if` ブロック等で深度3に達しています。
  - 提案: ファイル生成ロジックを `_create_eat_file` メソッドに抽出する。
- **`mark_as_processed` (Medium)**: `for` ループ内の `try` ブロックで深度3に達しています。
  - 提案: ファイル移動ロジックを `_move_file` メソッドに抽出する。

## 重大度
High
