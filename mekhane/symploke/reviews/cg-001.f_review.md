# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/ochema/cortex_client.py`

## 判定
発言（要改善）

## 発見事項

### 1. High Severity: `ask_stream` メソッド (深度 8)
`ask_stream` メソッド内のネスト深度が 8 に達しています（制限は 3）。
`with` -> `for` -> `if` -> `try` -> `for` -> `for` -> `if` という構造になっています。

**修正案:**
内側のループ処理を別メソッドに抽出することで、ネストを浅くできます。

```python
    # 修正案 (メソッド抽出)
    def _parse_stream_line(self, line: str) -> Generator[str, None, None]:
        """Parse a single SSE line from the stream."""
        if not line.startswith("data: "):
            return

        try:
            d = json.loads(line[6:])
            candidates = d.get("response", {}).get("candidates", [{}])
            for candidate in candidates:
                parts = candidate.get("content", {}).get("parts", [])
                for part in parts:
                    if "text" in part:
                        yield part["text"]
        except json.JSONDecodeError:
            pass

    # ask_stream 内での利用
    # ...
    with urllib.request.urlopen(req, timeout=timeout) as resp:
        for line_bytes in resp:
            line = line_bytes.decode("utf-8").strip()
            yield from self._parse_stream_line(line)
```

### 2. High Severity: `_parse_response` メソッド (深度 4)
`_parse_response` メソッド内のネスト深度が 4 に達しています（制限は 3）。
`for` -> `for` -> `if` -> `if` という構造になっています。

**修正案:**
ガード節 (`continue`) を使用してネストを解消できます。

```python
    # 修正案 (フラット化)
    for candidate in r.get("candidates", []):
        for part in candidate.get("content", {}).get("parts", []):
            if "text" not in part:
                continue

            if part.get("thought"):
                thinking_parts.append(part["text"])
            else:
                text_parts.append(part["text"])
```

## 重大度
High
