# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項

### `hgk_search` (High)
ネスト深度が7段に達しています。`if mode` (1) -> `if ki_base.exists()` (2) -> `for ki_dir` (3) -> `if is_dir` (4) -> `if exists` (5) -> `try` (6) -> `if match` (7)。
これは認知負荷の限界を大きく超えており、修正が必須です。
KI、Doxa、Handoffの各検索ロジックを独立したヘルパー関数に分割してください。

**修正案:**
```python
def _search_ki(query: str, results: list):
    # ... logic ...
    pass

def _search_doxa(query: str, results: list):
    # ... logic ...
    pass

def _search_handoff(query: str, results: list):
    # ... logic ...
    pass

def hgk_search(...):
    # ...
    if mode in ("hybrid", "keyword"):
        _search_ki(query, results)
        _search_doxa(query, results)
        _search_handoff(query, results)
    # ...
```

### `hgk_digest_check` (High)
ネスト深度が4段に達しています。`for files` (1) -> `try` -> `for lines` (2) -> `if strip` (3) -> `if frontmatter` (4)。
Frontmatterの解析ロジックをヘルパー関数 `_parse_frontmatter(content)` に抽出することで、ネストを浅くしてください。

**修正案:**
```python
def _parse_frontmatter(content: str) -> dict:
    # ... logic ...
    return {"title": ..., "score": ..., "topics": ...}

# ...
    for i, f in enumerate(files, 1):
        try:
            content = f.read_text(...)
            meta = _parse_frontmatter(content)
            # ... use meta ...
```

### `hgk_health` (High)
ネスト深度が4段に達しています。`if exists` (1) -> `try` -> `with` (2) -> `for` (3) -> `if strip` (4)。
ファイル読み込みとパース部分をヘルパー関数化するか、早期リターンを活用してください。

**修正案:**
```python
def _read_last_health_score(path: Path) -> str:
    if not path.exists():
        return "?"
    # ... logic ...
```

### `hgk_notifications` (Medium)
try-except内のネストが3段（`with` -> `for` -> `if`）に達しています。
リスト内包表記やフィルタリング関数を使ってフラット化してください。

### `hgk_paper_search` (Medium)
try-except内のネストが3段（`for` -> `if` -> `if`）に達しています。
Abstractの切り詰め処理などを独立させてください。

## 重大度
High
