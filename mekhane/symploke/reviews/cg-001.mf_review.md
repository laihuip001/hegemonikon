# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **High (4段以上のネスト)**
  - `parse_sessions_from_json` 関数内の `workspaces` 抽出ループが4段のネスト（for -> for -> if -> if）になっています。
    - 提案: `workspaces` 抽出ロジックを独立したヘルパー関数 `_extract_workspaces(info: dict) -> list[str]` に切り出すことでネストを浅くできます。
  - `fetch_all_conversations` 関数内の `turn` 処理ループが4段のネスト（for -> try -> for -> if/elif）になっています。
    - 提案: `user_texts` と `assistant_texts` の抽出処理を `_extract_conversation_texts(conversation: list) -> tuple` に切り出すか、ガード節を使用してネストを浅くしてください。

- **Medium (リスト内包表記のネスト2段)**
  - `index_handoffs`, `index_conversations`, `index_steps`, `index_exports` 関数内で、リスト内包表記の中に辞書内包表記が含まれており、実質的に2段のネストになっています。
    - コード例: `filtered_data = [{k: v for k, v in record.items() if k in schema_fields} for record in data_with_vectors]`
    - 提案: `filter_schema(records, schema_fields)` のようなヘルパー関数を作成するか、通常の for ループに展開して可読性を向上させてください。

## 重大度
High
