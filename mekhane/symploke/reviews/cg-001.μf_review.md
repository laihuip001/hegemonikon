# ãƒã‚¹ãƒˆæ·±åº¦è­¦å ±è€… ãƒ¬ãƒ“ãƒ¥ãƒ¼

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`mekhane/anamnesis/session_monitor.py`

## åˆ¤å®š
ç™ºè¨€ï¼ˆè¦æ”¹å–„ï¼‰

## ç™ºè¦‹äº‹é …
- `monitor_once` é–¢æ•°: `for` ãƒ«ãƒ¼ãƒ—å†…ã® `try-except` ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ã•ã‚‰ã« `if` æ–‡ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒã‚¹ãƒˆæ·±åº¦ãŒ3æ®µã«é”ã—ã¦ã„ã¾ã™ (Medium)ã€‚
- `daemon_loop` é–¢æ•°: `while` ãƒ«ãƒ¼ãƒ—å†…ã® `for` ãƒ«ãƒ¼ãƒ—å†…ã§ `if` æ–‡ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒã‚¹ãƒˆæ·±åº¦ãŒ3æ®µã«é”ã—ã¦ã„ã¾ã™ (Medium)ã€‚

## é‡å¤§åº¦
Medium

## ä¿®æ­£ææ¡ˆ

ä»¥ä¸‹ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šã€ãƒã‚¹ãƒˆæ·±åº¦ã‚’å‰Šæ¸›ã§ãã¾ã™ã€‚

### 1. `monitor_once` ã®ä¿®æ­£æ¡ˆ
å€‹åˆ¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `_process_single_session` é–¢æ•°ã«æŠ½å‡ºã—ã¾ã™ã€‚

```python
def _process_single_session(client: AntigravityClient, state: dict, s: dict) -> bool:
    """å˜ä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†ã¨ä¿å­˜ã‚’è¡Œã† (True ãªã‚‰æ›´æ–°ã‚ã‚Š)"""
    cascade_id = s.get("cascade_id", "")
    step_count = s.get("step_count", 0)
    summary = s.get("summary", f"Session {cascade_id[:8]}")
    status = s.get("status", "")

    if not cascade_id:
        return False

    # å‰å›ã¨ã®æ¯”è¼ƒ
    prev_steps = state.get(cascade_id, {}).get("step_count", 0)
    if step_count <= prev_steps:
        return False  # å¤‰åŒ–ãªã—

    # æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—æ¤œå‡º
    delta = step_count - prev_steps
    print(f"[Monitor] ğŸ“ {summary[:50]}... (+{delta} steps)")

    try:
        conv = client.session_read(cascade_id, full=True)
        if "error" in conv:
            print(f"  âš ï¸ Read error: {conv['error']}")
            return False

        # MD ä¿å­˜
        md_content = format_session_md(conv, summary, cascade_id)
        safe_name = sanitize_filename(summary)
        ts = datetime.now().strftime("%Y-%m-%d")
        filename = f"live_{ts}_{safe_name}.md"
        filepath = OUTPUT_DIR / filename

        OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
        filepath.write_text(md_content, encoding="utf-8")
        print(f"  âœ… Saved: {filepath.name} ({len(md_content)} bytes)")

        # çŠ¶æ…‹æ›´æ–°
        state[cascade_id] = {
            "step_count": step_count,
            "summary": summary,
            "last_updated": datetime.now().isoformat(),
            "status": status,
        }
        return True

    except Exception as e:
        print(f"  âŒ Error: {e}")
        return False

def monitor_once(client: AntigravityClient, state: dict) -> dict:
    """1å›ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚µã‚¤ã‚¯ãƒ«"""
    # ... (çœç•¥) ...

    updated_count = 0
    for s in recent:
        if _process_single_session(client, state, s):
            updated_count += 1

    # ... (çœç•¥) ...
    return state
```

### 2. `daemon_loop` ã®ä¿®æ­£æ¡ˆ
ä¸­æ–­å¯èƒ½ãªã‚¹ãƒªãƒ¼ãƒ—å‡¦ç†ã‚’ `_sleep_interruptible` é–¢æ•°ã«æŠ½å‡ºã—ã¾ã™ã€‚

```python
def _sleep_interruptible(duration: int, check_running_func) -> None:
    """ä¸­æ–­å¯èƒ½ãªã‚¹ãƒªãƒ¼ãƒ—"""
    for _ in range(duration):
        if not check_running_func():
            break
        time.sleep(1)

def daemon_loop(client: AntigravityClient, interval: int) -> None:
    # ... (çœç•¥) ...
    while running:
        # ... (çœç•¥) ...
        try:
            state = monitor_once(client, state)
        except Exception as e:
            print(f"[Monitor] âŒ Cycle error: {e}")

        # Wait with interruptibility
        _sleep_interruptible(interval, lambda: running)
```
