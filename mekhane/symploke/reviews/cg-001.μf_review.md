# ãƒã‚¹ãƒˆæ·±åº¦è­¦å ±è€… ãƒ¬ãƒ“ãƒ¥ãƒ¼

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`mekhane/mcp/hgk_gateway.py`

## åˆ¤å®š
ç™ºè¨€ï¼ˆè¦æ”¹å–„ï¼‰

## ç™ºè¦‹äº‹é …
- **`hgk_search`**: High severity.
    - KIæ¤œç´¢ãƒ–ãƒ­ãƒƒã‚¯ã§ãƒã‚¹ãƒˆæ·±åº¦7ã«åˆ°é” (`if ki_dir.is_dir()` -> `if metadata_path.exists()` -> `try` -> `if query_lower...`)ã€‚
    - Doxaæ¤œç´¢ãƒ–ãƒ­ãƒƒã‚¯ã§ãƒã‚¹ãƒˆæ·±åº¦5ã«åˆ°é” (`try` -> `if query.lower()...`)ã€‚
    - Handoffæ¤œç´¢ãƒ–ãƒ­ãƒƒã‚¯ã§ãƒã‚¹ãƒˆæ·±åº¦5ã«åˆ°é” (`try` -> `if query.lower()...`)ã€‚
- **`hgk_doxa_read`**: High severity.
    - `for item in data` (æ·±åº¦4) ãŠã‚ˆã³ `for key, value in data.items()` (æ·±åº¦4)ã€‚
- **`hgk_paper_search`**: High severity.
    - `if len(abstract) > 200` (æ·±åº¦4)ã€‚
- **`hgk_digest_check`**: High severity.
    - ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼è§£æãƒ­ã‚¸ãƒƒã‚¯ã§æ·±åº¦5ã«åˆ°é” (`if line.strip()...`, `if in_frontmatter`, `if line.startswith...`)ã€‚
- **`hgk_health`**: High severity.
    - WBC Alerts å‡¦ç†ã§æ·±åº¦4 (`for a in reversed(recent)`)ã€‚
    - Health Metrics å‡¦ç†ã§æ·±åº¦5 (`if line.strip()` inside `for line` inside `with` inside `try` inside `if`)ã€‚
- **`hgk_notifications`**: High severity.
    - é€šçŸ¥èª­ã¿è¾¼ã¿ãƒ«ãƒ¼ãƒ—å†…ã§æ·±åº¦5ã«åˆ°é” (`try` inside `if line` inside `for line` inside `with` inside `try`)ã€‚

## ä¿®æ­£ææ¡ˆ
å„æ©Ÿèƒ½ã‚’ç‹¬ç«‹ã—ãŸãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã«æŠ½å‡ºã™ã‚‹ã“ã¨ã§ãƒã‚¹ãƒˆã‚’æµ…ãã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### `hgk_search` ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¾‹

```python
def _search_ki_files(query: str) -> list[str]:
    results = []
    ki_base = Path.home() / ".gemini" / "antigravity" / "knowledge"
    if not ki_base.exists():
        return []

    query_lower = query.lower()
    for ki_dir in sorted(ki_base.iterdir()):
        if not ki_dir.is_dir():
            continue

        metadata_path = ki_dir / "metadata.json"
        if not metadata_path.exists():
            continue

        try:
            meta = json.loads(metadata_path.read_text(encoding="utf-8"))
            if _match_ki_metadata(meta, query_lower):
                 results.append(f"ğŸ“š **KI: ...")
        except Exception:
            pass
    return results

def _match_ki_metadata(meta: dict, query_lower: str) -> bool:
    summary = meta.get("summary", "")
    title = meta.get("title", "")
    return query_lower in title.lower() or query_lower in summary.lower()
```

### `hgk_digest_check` ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¾‹

```python
def _parse_digest_file(f: Path) -> str:
    try:
        content = f.read_text(encoding="utf-8")
        title, score, topics = _extract_frontmatter(content)
        return f"### ... title={title}, score={score} ..."
    except Exception as e:
        return f"### ... (èª­å–ã‚¨ãƒ©ãƒ¼: {e})"

def _extract_frontmatter(content: str) -> tuple[str, str, str]:
    title = "(ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜)"
    score = ""
    topics_str = ""
    in_frontmatter = False

    for line in content.split("\n"):
        if line.strip() == "---":
            if in_frontmatter: break
            in_frontmatter = True
            continue
        if in_frontmatter:
            if line.startswith("title:"):
                title = line.split(":", 1)[1].strip().strip("\"'")
            # ...
    return title, score, topics_str
```

## é‡å¤§åº¦
High
