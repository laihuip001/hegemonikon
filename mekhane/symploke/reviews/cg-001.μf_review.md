# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **[High]** `parse_sessions_from_json` 関数内 (62行目付近): `if path:` が `for` > `for` > `if` の内側にあり、ネスト深度4に達しています。
- **[High]** `fetch_all_conversations` 関数内 (287行目付近): `if turn.get("role") == "user":` が `for` > `try` > `for` の内側にあり、ネスト深度4に達しています。
- **[High]** `conversations_to_records` 関数内 (330行目付近): `if "T" in created:` が `for` > `if` > `try` の内側にあり、ネスト深度4に達しています。
- **[Medium]** `index_handoffs`, `index_conversations`, `index_steps`, `index_exports`, `index_from_json` 関数内: リスト内包表記内に辞書内包表記が含まれており (`[{k: v ...} for ...]`形式)、認知負荷を高める可能性があります。

## 重大度
High

## 修正提案

### 1. `parse_sessions_from_json` のフラット化
早期リターン（continue）を活用してネストを浅くすることを推奨します。

```python
        # Workspace extraction
        workspaces = []
        for ws in info.get("workspaces", []):
            if not isinstance(ws, dict):
                continue

            path = ws.get("workspacePath", "")
            if path:
                workspaces.append(Path(path).name)
```

### 2. `fetch_all_conversations` のテキスト抽出ロジック改善
内包表記を活用してループ内の条件分岐を排除し、ネストを削減します。

```python
            # ...
            # 抽出ロジックの簡素化
            user_texts = [t.get("content", "") for t in conversation if t.get("role") == "user"]
            assistant_texts = [t.get("content", "") for t in conversation if t.get("role") == "assistant"]
            # ...
```

### 3. `conversations_to_records` の日付パース抽出
日付パース処理をヘルパー関数に切り出し、メインループ内のネストを解消します。

```python
def _extract_year(created_str: str) -> str:
    if not created_str or "T" not in created_str:
        return ""
    try:
        dt = datetime.fromisoformat(created_str.replace("Z", "+00:00"))
        return str(dt.year)
    except Exception:
        return ""

# ...
        year = _extract_year(created)
```
