# ネスト深度警報者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **`call_tool` 関数のネスト過剰 (High)**
    - `search` 処理における `kairos` 検索ループが深くネストしている（最大深度 8）。
    - フロー: `if name == "search"` (1) -> `if source` (2) -> `for r in kairos_results` (3) -> `if recent_days` (4) -> `if ts` (5) -> `try` (6) -> `if (now - doc_date)...` (7)。
    - 支配原理「4段以上は地獄への入口」に違反。

- **`call_tool` 関数の責務過多 (Medium)**
    - 単一の関数内で `search`, `stats`, `backlinks`, `graph_stats` の分岐処理を行っており、`if/elif` 構造が深くなりやすい。

## 重大度
High

## 修正案
`call_tool` 関数を各ツールのハンドラ関数に分割し、ネストを浅くすることを提案します。

```python
# 修正イメージ

async def _handle_search(arguments: dict):
    query = arguments.get("query", "")
    if not query:
        return [TextContent(type="text", text="Error: query is required")]

    # ... (既存の search ロジックをここに移動) ...
    # さらに sophia/kairos 検索も関数化推奨
    # results.extend(await _search_sophia(...))
    # results.extend(await _search_kairos(...))

    return [TextContent(type="text", text="...")]

async def call_tool(name: str, arguments: dict):
    """Handle tool calls."""
    log(f"call_tool: {name} with {arguments}")

    handlers = {
        "search": _handle_search,
        "stats": _handle_stats,
        "backlinks": _handle_backlinks,
        "graph_stats": _handle_graph_stats,
    }

    handler = handlers.get(name)
    if handler:
        try:
            return await handler(arguments)
        except Exception as e:
            log(f"Tool error: {e}")
            return [TextContent(type="text", text=f"Error: {str(e)}")]

    return [TextContent(type="text", text=f"Unknown tool: {name}")]
```
