# Series適所配置検査官 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **責務の越境 (Medium)**: `SOPHIA_INDEX` および `KAIROS_INDEX` のパスがハードコードされており、知識の物理的な配置場所に関する知識を持っている。これは `anamnesis` (Knowledge) の責務であるべき構成情報が `mcp` (Interface) に漏れ出している。
- **Series不一致 (Medium)**: `search` ツール内でベクトル検索の実行手順（`EmbeddingAdapter` のロード、エンコード、検索）や、ビジネスロジック（`recent_days` によるフィルタリング）が実装されている。MCP サーバーはインターフェース層であり、これらのドメインロジックは `anamnesis` 以下のサービス（例: `KnowledgeSearchService`）にカプセル化されるべきである。
- **依存関係の漏洩 (Low)**: `EmbeddingAdapter` を直接インスタンス化し、低レベルなファイル操作を行っている。これにより、知識ストレージの実装詳細（Pickleファイルであることなど）への結合度が高まっている。

## 修正コード提案
`mekhane/anamnesis` に検索ロジックを移譲するサービスを作成し、MCP サーバーからはそのサービスを呼び出す形にリファクタリングすることを提案する。

### 1. 新規作成: `mekhane/anamnesis/sophia_search.py`

```python
from pathlib import Path
from typing import List, Dict, Optional, Any
from datetime import datetime

# パス定義をここに移動
SOPHIA_INDEX = Path("/home/makaron8426/oikos/mneme/.hegemonikon/indices/sophia.pkl")
KAIROS_INDEX = Path("/home/makaron8426/oikos/mneme/.hegemonikon/indices/kairos.pkl")

class SophiaSearchService:
    def __init__(self):
        self._adapter = None

    def _get_adapter(self):
        if self._adapter is None:
            from mekhane.symploke.adapters.embedding_adapter import EmbeddingAdapter
            self._adapter = EmbeddingAdapter()
        return self._adapter

    def search(self, query: str, source: str = "both", limit: int = 5, recent_days: Optional[int] = None) -> List[Dict[str, Any]]:
        results = []
        adapter = self._get_adapter()

        # Search Sophia
        if source in ("sophia", "both") and SOPHIA_INDEX.exists():
            adapter.load(str(SOPHIA_INDEX))
            query_vec = adapter.encode([query])[0]
            sophia_results = adapter.search(query_vec, k=limit)
            for r in sophia_results:
                results.append({
                    "source": "sophia",
                    "score": r.score,
                    "ki_name": r.metadata.get("ki_name", "N/A"),
                    "artifact": r.metadata.get("artifact", ""),
                    "summary": r.metadata.get("summary", "")[:150],
                    "file_path": r.metadata.get("file_path", ""),
                })

        # Search Kairos
        if source in ("kairos", "both") and KAIROS_INDEX.exists():
            adapter.load(str(KAIROS_INDEX))
            query_vec = adapter.encode([query])[0]
            kairos_results = adapter.search(query_vec, k=limit)

            now = datetime.now()
            for r in kairos_results:
                # Time filter logic
                if recent_days:
                    ts = r.metadata.get("timestamp", "")
                    if ts:
                        try:
                            doc_date = datetime.fromisoformat(ts.split("T")[0])
                            if (now - doc_date).days > recent_days:
                                continue
                        except Exception:
                            pass

                results.append({
                    "source": "kairos",
                    "score": r.score,
                    "task": r.metadata.get("primary_task", "N/A"),
                    "timestamp": r.metadata.get("timestamp", ""),
                    "file_path": r.metadata.get("file_path", ""),
                })

        results.sort(key=lambda x: x["score"], reverse=True)
        return results[:limit * 2]

    def get_stats(self) -> Dict[str, int]:
        stats = {"sophia_count": 0, "kairos_count": 0}
        adapter = self._get_adapter()

        if SOPHIA_INDEX.exists():
            adapter.load(str(SOPHIA_INDEX))
            stats["sophia_count"] = adapter.count()

        if KAIROS_INDEX.exists():
            adapter.load(str(KAIROS_INDEX))
            stats["kairos_count"] = adapter.count()

        return stats
```

### 2. 修正: `mekhane/mcp/sophia_mcp_server.py`

```python
# ... imports ...

@server.call_tool(validate_input=True)
async def call_tool(name: str, arguments: dict):
    # ...
    if name == "search":
        # ... args parsing ...
        try:
            with StdoutSuppressor():
                from mekhane.anamnesis.sophia_search import SophiaSearchService
                service = SophiaSearchService()
                results = service.search(query, source, limit, recent_days)

            # Format output logic (Presentation layer) stays here
            # ...
```

## 重大度
Medium
