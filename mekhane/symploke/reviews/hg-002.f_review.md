# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **Side Effects (High)**
    - モジュールレベルでの `sys.path.insert` は、インポートしただけでグローバルな `sys.path` を変更し、予測不能なインポート挙動を引き起こす可能性があります。
        - **Correction**: `sys.path` ハックを削除し、適切なパッケージインストールまたは相対インポートを使用してください。
    - 各 `index_*` 関数や `fetch_all_conversations` 内で `print()` が多用されており、ライブラリとして使用した場合に標準出力を汚染します。
        - **Correction**: `logging` モジュールを使用し、ログレベルで出力を制御できるようにしてください。
    - `index_from_api` が外部スクリプト `agq-sessions.sh` をサブプロセスで実行しており、環境依存の副作用があります。
        - **Correction**: Python コード内で API クライアントを直接使用するか、外部依存を明示的に注入してください。

- **Unpredictable Return Types (Medium)**
    - 多くの関数（`parse_sessions_from_json`, `fetch_all_conversations` 等）が `list[dict]` や `dict` を返しますが、その辞書構造が型ヒント（TypedDictやDataclass）で明示されておらず、利用側でキーを予測する必要があります。
        - **Correction**: `TypedDict` または `dataclass` を定義し、戻り値の構造を明示してください。
    - `index_*` 系関数が `int` (終了コード) を返していますが、これは関数呼び出しとしては非自明です（通常は例外送出やResult型）。
        - **Correction**: 処理成功時は `None` を返し、失敗時は例外を送出するか、明示的な `Result` 型を使用してください。CLI の終了コード変換は `main()` 関数のみで行うべきです。

- **Implicit State (Medium)**
    - `GnosisIndex` や `Embedder` が関数内でローカルにインスタンス化されており、依存性の注入やモック化が困難です。データベース接続やモデル読み込みという重い状態変更が隠蔽されています。
        - **Correction**: これらの依存オブジェクトを引数として受け取る（Dependency Injection）か、クラスのインスタンス変数として管理し、再利用可能にしてください。

- **Hidden Exceptions (Medium)**
    - `try...except Exception: pass` (または `continue`) が多用されており（`index_handoffs`, `fetch_all_conversations` 等）、エラーが握りつぶされています。これにより、何が失敗したのか呼び出し元が知る術がありません。
        - **Correction**: 具体的な例外型のみを捕捉し、予期せぬエラーは上位に伝播させるか、少なくとも `logger.exception()` で記録してください。

## 重大度
High
