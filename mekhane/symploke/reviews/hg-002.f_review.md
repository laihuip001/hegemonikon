# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_monitor.py`

## 判定
発言（要改善）

## 発見事項
- **副作用非明示 (High)**: `monitor_once` 関数は、その名前から予測される「状態の監視」に留まらず、外部ファイル(`monitor_state.json`)への永続化(`save_state`)およびMarkdownファイルの生成を内部で実行している。また、標準出力への書き込みもハードコードされており、呼び出し元が制御できない副作用を含んでいる。さらに、モジュールレベルで `sys.path.insert` を行っているため、インポート時の副作用も存在する。
- **暗黙状態変更 (Medium)**: `monitor_once` 関数内で、引数として渡された `state` 辞書を直接変更(mutate)している(`state[cascade_id] = ...`)。入力引数が破壊的に変更されることは関数シグネチャからは不明瞭であり、呼び出し元の予期せぬ状態変化を引き起こす可能性がある。
- **例外の隠蔽 (High)**: `monitor_once` 関数は `try...except Exception` ブロックですべての例外を捕捉し、標準出力にエラーメッセージを表示するだけで処理を続行している。これにより、呼び出し元は監視の失敗をプログラム的に検知できない。また、`load_state` 関数も `JSONDecodeError` や `OSError` を握りつぶし、空の辞書を返すため、ファイル破損やアクセス権限エラーなどの重要な問題を隠蔽している。

## 修正提案
- `monitor_once` を純粋関数に近づけ、変更された状態や生成すべきファイルの内容を戻り値として返すように変更する（例: `check_updates(client, state) -> (updated_state, list[FileOperation])`）。
- 永続化（`save_state`）やファイル出力は、`monitor_once` の呼び出し元（例えば `main` や `daemon_loop`）で行うように責務を分離する。
- `load_state` や `monitor_once` での例外捕捉を最小限にし、回復不能なエラーは呼び出し元に伝播させるか、カスタム例外を送出する設計にする。

## 重大度
High
