# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- モジュールレベルでの `sys.path.insert` によるグローバルな副作用 (High)
- `StdoutSuppressor` クラスによる `sys.stdout` の書き換えというグローバルな副作用 (High)
- `list_tools` 関数に戻り値の型ヒントがなく、インターフェースから挙動が予測困難 (Medium)
- `call_tool` 関数に戻り値の型ヒントがなく、インターフェースから挙動が予測困難 (Medium)
- `call_tool` 内での `EmbeddingAdapter` および `SophiaBacklinker` の初期化による暗黙的な状態依存 (Medium)
- `call_tool` 内での遅延インポートによる `sys.modules` への暗黙的な副作用 (Low)

## 重大度
High

## 修正提案
1. **グローバル副作用の排除**:
   - `sys.path` の変更を `main()` 関数内または専用のセットアップ関数に移動する。
   - `StdoutSuppressor` の代わりに、ログ出力先を明示的に指定できる設計にするか、`contextlib.redirect_stdout` を使用してスコープを明確にする。

2. **型ヒントの追加**:
   - `list_tools` に `-> list[Tool]` を追加する。
   - `call_tool` に `-> list[TextContent | ImageContent | EmbeddedResource]` を追加する。

3. **依存性の明示**:
   - `EmbeddingAdapter` や `SophiaBacklinker` を `call_tool` 内で初期化せず、サーバー初期化時に依存性を注入するか、クラスの属性として保持する。
