# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/ochema/antigravity_client.py`

## 判定
発言（要改善）

## 発見事項
- **副作用非明示 (High)**: `AntigravityClient.__init__` が `_detect_ls` を経由して `subprocess.check_output(["ps", "aux"])` および `["ss", "-tlnp"]` を実行し、さらに `urllib.request.urlopen` によるポートスキャンを行っている。インスタンス化の時点でシステム全体へのプロセス走査やネットワーク通信が発生するのは予測困難であり、テスト容易性も低い。
- **型予測困難 (Medium)**: `get_status`, `quota_status`, `session_info` 等のメソッドが `dict` または `list[dict]` を返しているが、そのキー構造（スキーマ）が型ヒントやドキュメントで明示されていない。呼び出し側は内部実装を読むか実行時に試行錯誤する必要がある。
- **例外の不透明性 (Medium)**: `urllib.error.URLError` や `subprocess.CalledProcessError` が捕捉されず、そのまま呼び出し元に伝播する可能性がある。クライアントライブラリとして抽象化された例外（例: `AntigravityConnectionError`）にラップすべきである。
- **暗黙的な状態依存 (Low)**: `archive_sessions` がデフォルトで `~/oikos/mneme/...` にファイル書き込みを行う。メソッド名からは「アーカイブデータを返す」のか「ファイルに保存する」のかが直感的に判別しづらい（`save_sessions_to_disk` 等が望ましい）。

## 重大度
High

## 修正提案

### 1. 副作用の分離（コンストラクタの軽量化）

```python
class AntigravityClient:
    def __init__(self, workspace: str = "hegemonikon"):
        self.workspace = workspace
        self.ls: Optional[LSInfo] = None

    def connect(self) -> None:
        """Language Server を検出し接続する（副作用あり）。"""
        self.ls = self._detect_ls()

    # 利用時は明示的に connect() を呼ぶ
    # client = AntigravityClient()
    # client.connect()
```

### 2. 戻り値の型定義（TypedDict / Dataclass）

```python
from dataclasses import dataclass

@dataclass
class ModelQuota:
    model: str
    remaining_pct: int
    reset_time: str
    # ...

def quota_status(self) -> list[ModelQuota]:
    # ...
```
