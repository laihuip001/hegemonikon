# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項
- **[High] 副作用非明示 (Signal)**: `hgk_paper_search` 関数内で `signal.alarm(30)` を使用しており、プロセス全体のシグナルハンドラを変更しています。これは呼び出し元にとって予測不能な副作用であり、マルチスレッド環境や他のシグナル依存処理と競合する危険性があります。
- **[High] 副作用非明示 (sys.path)**: モジュールレベルで `sys.path.insert(0, str(PROJECT_ROOT))` を実行しています。インポートしただけでインタプリタ全体の探索パスが変更されるのは予測困難な副作用です。
- **[High] 副作用非明示 (Subprocess)**: `hgk_pks_stats`, `hgk_pks_health`, `hgk_pks_search` が `subprocess.run` を使用して外部プロセスを起動しています。関数名からは純粋な関数呼び出しに見えますが、実際にはシェル環境や外部コマンドへの依存があります。
- **[High] 副作用非明示 (I/O)**: `_load_policy`, `_trace_tool_call`, `_wbc_log_security_event` などが `sys.stderr` やファイルシステム (`_MNEME_DIR`) に直接書き込みを行っています。関数名から推測できない副作用です。
- **[Medium] 暗黙状態変更**: `_check_rate_limit` 関数がグローバル変数 `_ask_timestamps` を直接変更しており、状態管理が暗黙的です。また `_pks_engine` もグローバル変数として遅延初期化されており、副作用のタイミングが予測しにくい構造です。
- **[Medium] 型予測困難**: ほぼ全ての `@mcp.tool` 関数が `str` 型を返しますが、その実体は自然言語（Markdown）です。構造化データではなくフォーマット済みテキストを返すため、プログラム的な再利用時の予測が困難です。
- **[Medium] 例外の不透明性**: 多くの関数（`hgk_search`, `hgk_ccl_dispatch` 等）で `except Exception as e:` を使用し、エラーメッセージを含む文字列を返しています。これにより、呼び出し元は例外の種類（`ImportError`, `TimeoutError` 等）を判別できず、正常系と異常系の区別が困難になっています。

## 重大度
High
