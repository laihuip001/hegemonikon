# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_monitor.py`

## 判定
発言（要改善）

## 発見事項
- **[High] Global sys.path modification**: モジュールレベル（トップレベル）で `sys.path` を変更しており、インポート時にグローバルな副作用が発生する。これにより、インポート順序依存の問題や他モジュールへの予期せぬ影響が生じる可能性がある。（改善案: 相対インポートを使用するか、`PYTHONPATH` 環境変数でパスを解決する）
- **[High] Unadvertised Side Effects in `monitor_once`**: 関数名は "monitor" (監視) だが、実際にはファイルシステムへの書き込み（`filepath.write_text`）を行っている。名前と振る舞いに乖離があり、読み手にとって予測不能な副作用である。（改善案: `capture_snapshot` や `archive_session` など、副作用を明示する名前への変更）
- **[High] Exception Swallowing**: `monitor_once` 内で `Exception` をキャッチし、標準出力にエラーを表示するだけで処理を継続している。また `load_state` も `OSError` を黙って無視している。これにより、呼び出し元がエラー発生を検知できず、異常状態が隠蔽されるリスクがある。（改善案: 必要最小限の例外のみを捕捉するか、呼び出し元に例外を伝播させる設計への変更）
- **[Medium] Implicit State Mutation**: `monitor_once` が引数 `state` (dict) をインプレースで変更しつつ、戻り値としても返している。関数型的なシグネチャ（戻り値あり）と破壊的変更が混在しており、呼び出し元の予期せぬ状態変更を招く。（改善案: 状態を変更せず新しい辞書を返すか、変更を明示する設計にする）
- **[Medium] Hardcoded External State Dependency**: `OUTPUT_DIR`, `STATE_FILE` が `Path.home()` に依存しており、実行ユーザーや環境による振る舞いの変化がシグネチャから読み取れない。テストや異なる環境での再利用が困難である。（改善案: 設定クラスや引数としてパスを受け取る設計への変更）

## 重大度
High
