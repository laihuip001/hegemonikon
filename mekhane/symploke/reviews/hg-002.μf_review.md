# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **[High] Global sys.path Modification**
  - 26-28行目で `sys.path.insert` を実行しています。モジュールのインポート時にグローバルな状態（`sys.path`）が変更されるため、副作用が予測不可能です。
  - **提案**: `sys.path` の変更を `if __name__ == "__main__":` ブロック内に移動するか、相対インポートを使用してパス操作を不要にしてください。

- **[Medium] Unpredictable Return Types (Implicit Dicts)**
  - `parse_sessions_from_json`, `sessions_to_records` 等の関数が `dict` や `list[dict]` を返しますが、その構造が明示されていません。呼び出し元はキーの存在や型を予測できません。
  - **提案**: `TypedDict` または `dataclass` を導入し、戻り値の構造を型ヒントで明示してください。

- **[Medium] Swallowed Exceptions**
  - `sessions_to_records` (88-91行目), `index_handoffs` (228行目) など複数箇所で `except Exception:` により例外を握りつぶしています。エラーが発生しても関数が成功したように振る舞うため、予測誤差が大きくなります。
  - **提案**: 捕捉する例外を具体化（例: `ValueError`）するか、ログ出力を行ってエラーを可視化してください。

- **[Medium] Hidden Dependency**
  - `fetch_all_conversations` 関数内で `AntigravityClient` をインポートしています（295行目）。関数シグネチャからは外部依存（RPCクライアント）の使用が読み取れず、副作用が隠蔽されています。
  - **提案**: インポートをモジュールレベルに移動するか、依存性を注入（DI）する設計に変更してください。

## 重大度
High
