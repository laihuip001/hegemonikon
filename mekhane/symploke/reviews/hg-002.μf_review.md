# PROOF: [L2/Mekhanē] <- mekhane/symploke/reviews/hg-002.μf_review.md HG-002.μF Review
# PURPOSE: HG-002.μF (Predictive Error Inquisitor) review of hermeneus/src/executor.py

# 予測誤差審問官 レビュー

## 対象ファイル
`hermeneus/src/executor.py`

## 判定
発言（要改善）

## 発見事項

- **`execute` メソッドの引数 `**kwargs` が無視されている (High)**
  - `WorkflowExecutor.execute` は `**kwargs` を受け取るが、内部で呼び出す `_phase_execute` に渡していない。
  - そのため、`timeout`, `temperature`, `max_retries` などの `ExecutionConfig` 用パラメータを `execute` に渡しても、`_phase_execute` 内で `ExecutionConfig(model=model)` が生成される際に無視される。
  - **予測誤差**: ユーザーは指定したパラメータ（例: `timeout=10`）が機能することを期待するが、実際にはデフォルト値が使われるため、驚き（予測誤差）が生じる。
  - **修正提案**: `_phase_execute` に `**kwargs` を渡し、`ExecutionConfig` の初期化時に展開する。

```python
    # 修正案
    async def _phase_execute(
        self,
        ccl: str,
        context: str,
        model: str,
        **kwargs  # 追加
    ) -> PhaseResult:
        # ...
        config = ExecutionConfig(model=model, **kwargs)  # kwargsを展開
        # ...
```

- **`_record_theorem_usage` の副作用が隠蔽されている (Medium)**
  - `execute` の成功時に `_finalize` -> `_record_theorem_usage` が呼ばれ、グローバルな `theorem_recommender` に状態を書き込む。
  - 関数名 `execute` からは「実行」のみが期待され、「定理使用履歴の記録」という副作用は予測しにくい。
  - **修正提案**: 記録処理を明示的な依存性注入（DI）にするか、構成オプション（`record_usage=True`）で制御可能にする。

- **`execute_sync` の `asyncio.run` による再入不可性 (Medium)**
  - `execute_sync` は `asyncio.run(self.execute(...))` を使用している。
  - すでにイベントループが動作している環境（例: Jupyter Notebook, `uvicorn` 下）で呼び出すと `RuntimeError: asyncio.run() cannot be called from a running event loop` が発生する。
  - **予測誤差**: 「同期実行」という名前からは、どのような環境でも同期的に実行できることが期待されるが、環境によってはクラッシュする。
  - **修正提案**: `nest_asyncio` の使用を検討するか、既存ループの検出ロジックを追加する。

## 重大度
High
