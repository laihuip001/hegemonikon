# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項
- **シグナルハンドラの書き換え (High)**
  - `hgk_paper_search` 関数内で `signal.signal(signal.SIGALRM, ...)` を使用しています。これはプロセス全体のグローバルな状態を変更する副作用であり、呼び出し元から予測困難かつ危険です。特にマルチスレッド環境や他のタイムアウト機構と競合する可能性があります。
  - **提案**: `func_timeout` などのライブラリを使用するか、非同期処理 (`asyncio.wait_for`) に移行することを検討してください。

- **例外の握りつぶし (High)**
  - `_load_policy`, `_trace_tool_call`, `_wbc_log_security_event` など多数の関数で `try...except Exception` ブロックが使用され、エラー時に標準エラー出力への表示のみで処理を続行しています。これにより、クリティカルな設定ミスや書き込みエラーが検知できず、システムが予測不能な状態で動作し続けるリスクがあります。
  - **提案**: 少なくとも呼び出し元に例外を伝播させるか、戻り値で明確に失敗を通知すべきです。

- **暗黙のグローバル状態依存 (Medium)**
  - `_ask_timestamps` や `_pks_engine` といったグローバル変数が、関数 (`_check_rate_limit`, `_get_pks_engine`) 内で暗黙的に参照・変更されています。状態の管理が分散しており、テストやデバッグ時に状態の予測が困難です。
  - **提案**: これらの状態をクラス (`HGKGateway` など) のインスタンス変数としてカプセル化することを推奨します。

- **戻り値の曖昧性 (Medium)**
  - `_load_policy` はエラー時にデフォルトの辞書を返しますが、ファイルが存在しない場合と読み込みエラーの場合の区別がつきません。
  - `hgk_pks_stats` 等のサブプロセス実行関数は、エラー時に文字列としてエラーメッセージを返しますが、成功時の出力（文字列）と型レベルでの区別がありません。
  - **提案**: `Result` 型や `Optional` 型を使用し、成功と失敗を型レベルで区別可能にしてください。

## 重大度
High
