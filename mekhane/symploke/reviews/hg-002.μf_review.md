# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項

- **例外の隠蔽と予測困難な振る舞い (High)**
    - `fetch_all_conversations` 関数内で `except Exception` により全ての例外を捕捉し、標準出力にエラーを表示して処理を継続している。呼び出し元は API エラーが発生した事実を知る術がなく、空のリストが返ってきた場合との区別がつかない。
    - `index_handoffs` 等のインデックス関数内で、重複チェック時の `except Exception: pass` が広すぎる。DB 接続エラーやスキーマ不整合などの重大なエラーも無視される恐れがある。

- **副作用の非明示 (High)**
    - `fetch_all_conversations` が進行状況を `print` で標準出力に書き出している。ライブラリ関数として振る舞うべき関数が、呼び出し元のコンソール出力を汚染している。
    - `index_from_api` が `subprocess.run` を使用して外部シェルスクリプト (`agq-sessions.sh`) を実行している。Python コード内で完結しているように見せかけて外部プロセス依存があるのは予測誤差が大きい。

- **戻り値の型が予測困難 (Medium)**
    - `parse_sessions_from_json`, `fetch_all_conversations`, `parse_handoff_md` などの戻り値が `dict` や `list[dict]` となっている。具体的なキーや構造が型ヒントから読み取れず、利用側は実装詳細を確認する必要がある。`TypedDict` やデータクラスの使用が望ましい。

- **暗黙のグローバル状態変更 (Medium)**
    - モジュールトップレベルで `sys.path.insert` を実行している。このモジュールをインポートするだけで、インタプリタ全体のパス探索順序が変更される副作用がある。

- **環境への暗黙的な依存 (Medium)**
    - `_HANDOFF_DIR`, `_BRAIN_DIR` 等がホームディレクトリ下の固定パス (`oikos/mneme/...`) に依存している。関数の引数でオーバーライド可能ではあるが、デフォルト値が特定の環境構成を前提としている。

## 重大度
High
