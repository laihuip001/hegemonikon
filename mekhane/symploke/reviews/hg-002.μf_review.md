# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/ochema/antigravity_client.py`

## 判定
発言（要改善）

## 発見事項

- **High: 戻り値の型が予測不能 (Polymorphic Return Types)**
    - `session_info(cascade_id=None)` は `{"total": int, "sessions": list}` を返すが、`cascade_id` を指定すると単一セッションの `dict` または `{"error": str}` を返す。
    - `session_episodes(brain_id=None)` も同様に、引数の有無で戻り値の構造が劇的に変化する。
    - 呼び出し元は `isinstance` チェックやキーの存在確認 (`if "error" in result:`) を強いられ、驚きが大きい。
    - **提案**: `get_session(id) -> Session` と `list_sessions() -> list[Session]` に分割し、エラー時は例外を送出する。

- **High: エラー処理が予測不能 (Error Dict vs Exception)**
    - `session_read` や `session_info` は失敗時に `{"error": "message"}` という辞書を返す。
    - Python の標準的な例外送出 (`raise ValueError` 等) と異なり、呼び出し元が戻り値を検査しないとエラーに気づかない（「成功したつもりで処理が進む」リスク）。
    - **提案**: 明示的な例外 (`SessionNotFoundError` 等) を raise する設計に変更する。

- **Medium: 副作用が予測不能 (`_select_model` のネットワークIO)**
    - `_select_model` という名前は「内部ロジックによる選択」を想起させるが、内部で `quota_status()` を呼び出し、ネットワーク通信 (`_rpc`) を行う。
    - 通信エラーでモデル選択が失敗する可能性が名前から予測できない。
    - **提案**: 必要な情報は引数として渡すか、メソッド名を `_fetch_optimal_model` 等に変更して副作用を明示する。

- **Medium: 例外の隠蔽 (`_poll_response` の握りつぶし)**
    - `_poll_response` 内の `while` ループで `except Exception: pass` が使用されており、通信エラーやパースエラーが全て握りつぶされる。
    - タイムアウトまでループし続けるため、真の原因（例: 認証エラー、パース失敗）が `TimeoutError` としてマスクされ、デバッグが困難になる。
    - **提案**: 特定の再試行可能な例外のみを捕捉し、それ以外は即座に raise する。

- **Medium: `__init__` の重い副作用と脆さ**
    - `__init__` で `_detect_ls()` を呼び出し、外部プロセス (`ps aux`, `ss`) の実行と全ポートへの接続試行を行っている。
    - インスタンス化だけで失敗する可能性が高く、ユニットテストも困難になる。
    - **提案**: 接続処理を `connect()` メソッドに分離し、`__init__` は設定の保持のみに留める。

- **Medium: 戻り値の型ヒントが不正確**
    - `list_models`, `quota_status`, `session_info` 等の戻り値が `dict` や `list[dict]` としか定義されていない。
    - 辞書のキーや値の型がコードを読まないと不明。
    - **提案**: `TypedDict` または `dataclass` を定義して使用する。

## 重大度
High
