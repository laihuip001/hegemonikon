# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/api/routes/chat.py`

## 判定
発言（要改善）

## 発見事項
- **High**: `cortex_chat` 関数内で `svc._get_cortex_client()` や `cortex._get_token()` といったプライベートメソッド（`_`接頭辞）への直接アクセスが行われている。これは OchemaService のカプセル化を破壊しており、将来的な実装変更時に予期せぬ動作停止を引き起こす高いリスクがある（予測不能な副作用）。
- **High**: `_claude_chat_from_gemini_format` は `ChatRequest` 全体（会話履歴含む）を受け取るシグネチャを持ちながら、実装では「LS側で管理」という暗黙の前提により履歴を破棄し、最後のメッセージのみを抽出している。関数シグネチャが示唆する動作（履歴付きチャット）と実際の動作（単発メッセージ変換）が乖離しており、利用者に誤解を与える（驚き最小の原則違反）。
- **Medium**: `chat_send`, `_claude_chat_from_gemini_format`, `_cortex_chat_from_gemini_format`, `cortex_chat` の戻り値の型アノテーションが欠落している。これらは `StreamingResponse` を返すが、シグネチャからは読み取れず、呼び出し元の予測可能性を下げている。

## 重大度
High
