# 予測誤差審問官 レビュー

## 対象ファイル
`mekhane/anamnesis/index.py`

## 判定
発言（要改善）

## 発見事項
- **sys.stdout.reconfigureによるグローバルな副作用 (High)**
  - モジュールレベルで `sys.stdout.reconfigure(encoding="utf-8")` を実行しており、インポートしただけで標準出力のエンコーディングを変更する副作用があります。これはライブラリとして予測不能な挙動です。

- **Embedder.__init__ 等における標準出力への副作用 (High)**
  - `Embedder.__init__`, `GnosisIndex.add_papers`, `GnosisIndex.search` 内で `print()` 関数を使用しています。ライブラリコードが標準出力にログを吐くのは、呼び出し元にとって制御不能な副作用です。`logging` モジュールを使用すべきです。

- **例外の握りつぶしによる予測不能な状態 (High)**
  - `GnosisIndex._load_primary_keys` および `GnosisIndex.get_by_primary_key` で `except Exception:` として全ての例外を捕捉し、無視あるいは `None` を返しています。これにより、データベースの破損や予期せぬエラーが発生しても呼び出し元が気づけず、予測不能な動作を引き起こします。

- **戻り値の型が曖昧 (Medium)**
  - `Embedder.embed` の戻り値が `list`、`Embedder.embed_batch` の戻り値が `list[list]` となっています。`list[float]` や `list[list[float]]` のように具体的に記述しないと、呼び出し元は中身を予測できません。

## 重大度
High
