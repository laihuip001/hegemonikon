# ストア派制御審判 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **外部プロセス呼び出しのタイムアウト欠如 (High)**: `index_from_api` 関数内の `subprocess.run` に `timeout` パラメータが設定されていません。外部スクリプト `agq-sessions.sh` がハングした場合、プロセス全体が無限に待機するリスクがあります。
    - *推奨修正*: `subprocess.run(..., timeout=300)` のように明示的なタイムアウトを設定し、`subprocess.TimeoutExpired` を捕捉して適切にエラー処理を行ってください。
- **外部サービス依存の防御策欠如 (Medium)**: `fetch_all_conversations` 関数はループ内で `client.session_read` を呼び出していますが、連続してエラーが発生した場合のサーキットブレーカーや、一時的なネットワークエラーに対するリトライロジック（バックオフ付き）が存在しません。
    - *推奨修正*: エラー発生回数をカウントし、一定数を超えたら処理を中断するサーキットブレーカーの導入、または `tenacity` ライブラリ等を用いたリトライ処理を追加してください。
- **ファイル読み込みのリカバリ戦略欠如 (Medium)**: `index_from_json` 関数内の `json.load(f)` が `json.JSONDecodeError` を考慮していません。破損したJSONファイルを読み込むとクラッシュします。
    - *推奨修正*: `try-except json.JSONDecodeError` ブロックで囲み、読み込み失敗時にはエラーログを出力して gracefully に終了するか、バックアップファイルへのフォールバックを検討してください。

## 重大度
High
