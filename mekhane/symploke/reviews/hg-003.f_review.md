# ストア派制御審判 レビュー

## 対象ファイル
`mekhane/anamnesis/session_monitor.py`

## 判定
発言（要改善）

## 発見事項
- **外部API呼び出しにタイムアウト設定なし (High)**: `AntigravityClient` のメソッド (`session_info`, `session_read`) 呼び出し時に、タイムアウト例外 (`urllib.error.URLError` 等) に対するハンドリングが `monitor_once` 内で不十分です。特に `session_info` 呼び出しが失敗すると関数全体が中断されます。呼び出し側での `try-except` ブロックによる保護が必要です。
- **ネットワーク障害時のフォールバック欠如 (Medium)**:
    - `main` 関数での `AntigravityClient` 初期化時に接続エラーが発生すると即座に終了します。デーモンモードでは、一時的な障害を許容し、一定間隔で再接続を試みるリトライループ（指数バックオフ等）の実装が推奨されます。
    - `monitor_once` 内で API エラーが発生した場合、単にログを出力してそのサイクルを終了しています。より堅牢な動作のためには、短時間での再試行や、キャッシュされた情報の利用などのフォールバック戦略が望まれます。
- **ファイルI/O失敗時のリカバリ戦略なし (Medium)**:
    - `save_state` 関数においてファイル書き込みエラー（ディスクフル、権限エラー等）に対する例外処理がありません。これにより `monitor_once` が中断され、データの不整合が発生する可能性があります。一時ファイルへの書き込みとアトミックなリネーム操作 (`tempfile` モジュールや `replace` メソッドの利用) や、例外捕捉による再試行の実装を推奨します。

## 重大度
High
