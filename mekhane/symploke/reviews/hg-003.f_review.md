# ストア派制御審判 レビュー

## 対象ファイル
`hermeneus/tests/test_verifier.py`

## 判定
発言（要改善）

## 発見事項
- **外部API呼び出しのタイムアウト未検証 (High)**
  - `DebateAgent` の外部LLM呼び出し（`_executor.generate_text_async`）において、タイムアウト発生時の挙動を検証するテストが存在しません。API呼び出しが無限にハングする可能性に対する防御策（`asyncio.wait_for` 等）と、その際の適切な例外処理またはフォールバックが機能するか確認すべきです。

- **ネットワーク障害時のフォールバック未検証 (Medium)**
  - `DebateAgent` における外部接続失敗時のフォールバック（`_fallback_generate`）が、テストで意図的に障害を再現して検証されていません。モックを用いて接続エラー（`ConnectionError` 等）をシミュレートし、フォールバックロジックが確実に作動することを確認するテストが必要です。

- **ファイルI/O失敗時のリカバリ戦略なし (Medium)**
  - `AuditStore` のテスト (`TestAuditStore`) は正常系のみで、ディスク容量不足や権限エラーなどの異常系テストが欠如しています。書き込み失敗時にアプリケーションがクラッシュせず、適切にエラーログを出力して継続（あるいは安全に停止）できるか検証が必要です。

- **外部サービス依存のRetry/Circuit Breaker欠如 (Medium)**
  - 外部LLMサービスへの依存があるにもかかわらず、一時的な障害に対するリトライ処理や、連続障害時のサーキットブレーカー機能の存在（およびそのテスト）が確認できません。

## 修正コード提案
`hermeneus/tests/test_verifier.py` に以下の異常系テストを追加することを推奨します：

```python
    # PURPOSE: タイムアウト時のフォールバック検証
    @pytest.mark.asyncio
    async def test_generate_timeout_fallback(self):
        """タイムアウト時のフォールバック検証"""
        agent = DebateAgent(AgentRole.PROPOSER)
        # _executor.generate_text_async がタイムアウトすることをモック
        agent._executor = MagicMock()
        agent._executor.generate_text_async.side_effect = asyncio.TimeoutError

        # タイムアウト時に例外で落ちず、フォールバック応答が返ることを確認
        response = await agent._generate("test prompt")
        assert "論理的に妥当" in response  # _fallback_generate の内容
```

## 重大度
High
