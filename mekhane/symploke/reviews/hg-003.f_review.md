# ストア派制御審判 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **外部API呼び出しにタイムアウト設定なし (High)**: `EmbeddingAdapter.encode`/`search` および `SophiaBacklinker.build_graph` の呼び出しにタイムアウトが設定されておらず、外部要因により処理がハングするリスクがある。
- **ネットワーク障害時のフォールバック欠如 (Medium)**: インデックスファイル（`sophia.pkl`, `kairos.pkl`）の読み込み失敗時や検索失敗時に、キャッシュ利用や簡易検索へのフォールバックが行われていない。
- **ファイルI/O失敗時のリカバリ戦略なし (Medium)**: `adapter.load()` が失敗した場合（ファイル破損等）、再試行や代替手段（バックアップからの復元など）を試みるリカバリ戦略が存在しない。
- **外部サービス依存で retry/circuit breaker なし (Low)**: 外部ライブラリ（`mcp` SDK, `EmbeddingAdapter`）への依存において、一時的な障害に対するリトライ機構やサーキットブレーカーが実装されていない。

## 重大度
High

## 修正案
制御不能な外部要素（I/O, 計算負荷）に対する防御策として、以下の修正を推奨する。

1.  **タイムアウトの導入**: `asyncio.wait_for` を使用して、検索処理全体にタイムアウト（例: 5-10秒）を設定する。
2.  **エラーハンドリングの強化**: `Exception` の包括的な捕捉だけでなく、`FileNotFoundError` や `PickleError` などを具体的に捕捉し、適切なエラーメッセージや代替手段を提供する。
3.  **リトライロジックの追加**: 一時的なエラー（例: ファイルロック競合など）に対して、数回の再試行を行うロジックを追加する。

```python
# 修正イメージ
import asyncio

# ...

    elif name == "search":
        # ...
        try:
            # タイムアウト制御の追加
            async def _execute_search():
                # ... (既存の同期的な検索処理をここに移動)
                # 注: EmbeddingAdapterが同期処理の場合、run_in_executorの使用も検討
                pass

            # 10秒のタイムアウトを設定
            results = await asyncio.wait_for(_execute_search(), timeout=10.0)

            # ...

        except asyncio.TimeoutError:
            log(f"Search timed out for query: {query}")
            return [TextContent(type="text", text="Error: Search timed out. Please try again with a more specific query.")]
        except Exception as e:
            log(f"Search error: {e}")
            return [TextContent(type="text", text=f"Error searching: {str(e)}")]
```
