# ストア派制御審判 レビュー

## 対象ファイル
`mekhane/ochema/antigravity_client.py`

## 判定
発言（要改善）

## 発見事項
- **subprocess呼び出しにタイムアウト設定なし** (High)
  - `_detect_ls` メソッド内の `subprocess.check_output(["ps", "aux"], ...)` および `subprocess.check_output(["ss", "-tlnp"], ...)` に `timeout` 引数が指定されていません。外部プロセスがハングした場合、呼び出し元も無期限にブロックされるリスクがあります。
  - **修正案**: `subprocess.check_output(..., timeout=5)` のようにタイムアウトを設定し、`subprocess.TimeoutExpired` を捕捉して適切にエラーハンドリングを行うべきです。

- **RPC呼び出しのタイムアウトがハードコードされている** (High)
  - `_raw_rpc` メソッドにおいて `urllib.request.urlopen(..., timeout=10)` とハードコードされており、呼び出し元から制御できません。ネットワーク遅延や負荷状況に応じて調整不可能です。
  - **修正案**: `_raw_rpc` および `_rpc` メソッドに `timeout` 引数を追加し、`ask` メソッドなどから渡される値を反映させるべきです。

- **ネットワーク障害時のフォールバック欠如** (Medium)
  - `_rpc` およびそのラッパーメソッド（`_start_cascade`, `_send_message` など）において、接続エラーや一時的な障害に対するリトライ機構やフォールバック処理（例：待機して再試行、別の手段への切り替え）が実装されていません。
  - **修正案**: `tenacity` ライブラリなどを導入するか、自前で `retry` デコレータを実装し、指数バックオフなどを用いたリトライロジックを追加することを推奨します。

- **ファイルI/O失敗時のリカバリ戦略なし** (Medium)
  - `archive_sessions` や `session_episodes` において、ファイルシステムへのアクセス（`open`, `os.makedirs`）が失敗した場合の例外処理が不十分です。権限エラーやディスクフルなどの制御不能な状況に対するリカバリ（例：スキップしてログ出力、代替パスへの保存）がありません。
  - **修正案**: `try-except` ブロックでファイル操作を囲み、エラー発生時はログを出力して処理を継続するか、呼び出し元に適切にエラーを通知する構造にすべきです。

- **Retry/Circuit Breakerの欠如** (Medium)
  - 外部サービスである Antigravity Language Server への依存度が高いにもかかわらず、Circuit Breaker パターンなどが導入されていません。
  - **修正案**: 連続した失敗を検知した場合に一時的にリクエストを遮断する仕組みを検討すべきです。

## 重大度
High
