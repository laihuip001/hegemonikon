# ストア派制御審判 レビュー

## 対象ファイル
`mekhane/ochema/__init__.py`

## 判定
発言（要改善）

## 発見事項
- (Module whole) 外部API呼び出しにタイムアウト設定なし: `antigravity_client.py` の `_raw_rpc` で `timeout=10` がハードコードされており、外部から設定不可能。また `_detect_ls` 内の `subprocess.check_output` にタイムアウトが設定されていない (High)
- (Module whole) 外部サービス依存で retry/circuit breaker なし: `_rpc` および `_raw_rpc` メソッドにおいて、通信エラー発生時の再試行（リトライ）ロジックやサーキットブレーカー機構が実装されていない (Medium)
- (Module whole) ネットワーク障害時のフォールバック欠如: `AntigravityClient` の主要メソッド (`ask`, `get_status` 等) が `_rpc` の例外をそのまま送出しており、接続失敗時の代替手段やグレースフルなエラーハンドリングが不足している (Medium)

## 重大度
High

## 修正案

```python
# mekhane/ochema/antigravity_client.py

import subprocess
import time
from tenacity import retry, stop_after_attempt, wait_exponential

class AntigravityClient:
    def __init__(self, workspace: str = "hegemonikon", timeout: float = 10.0):
        self.workspace = workspace
        self.timeout = timeout  # 設定可能にする
        # ...

    def _detect_ls(self) -> LSInfo:
        # ...
        try:
            # タイムアウトを追加
            ps_out = subprocess.check_output(
                ["ps", "aux"], text=True, stderr=subprocess.DEVNULL, timeout=5.0
            )
        except subprocess.TimeoutExpired:
            raise RuntimeError("ps aux timed out")
        # ...

    # リトライ機構を追加
    @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
    def _rpc(self, endpoint: str, payload: dict) -> dict:
        try:
            return self._raw_rpc(self.ls.port, self.ls.csrf, endpoint, payload)
        except Exception as e:
            # 必要であればログ出力など
            raise

    def _raw_rpc(self, port: int, csrf: str, endpoint: str, payload: dict) -> dict:
        # ...
        # 設定されたタイムアウトを使用
        with urllib.request.urlopen(req, context=self._ssl_ctx, timeout=self.timeout) as resp:
            # ...
```
