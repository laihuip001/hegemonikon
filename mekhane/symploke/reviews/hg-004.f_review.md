# CCL式美学者 レビュー

## 対象ファイル
`mekhane/mcp/hgk_gateway.py`

## 判定
発言（要改善）

## 発見事項
- **ネストが3レベル超過 (Medium)**: `hgk_search` 関数内 (Line 414-436) のキーワード検索ロジックが**レベル9**に達しています。`if mode` → `if ki_base` → `for ki_dir` → `if is_dir` → `if exists` → `try` → `if query` → `append` の連鎖は美しくありません。
- **CCL式が60ポイント超過 (Medium)**: `_wbc_log_security_event` 関数内 (Line 227) の `threatScore` 計算式がネストされた三項演算子で記述されており、可読性を損なっています（87文字）。
- **冗長なCCL式 (Low)**: `hgk_search` 関数内で KI, Doxa, Handoff の検索ロジック（ファイル読み込み、JSONパース、条件判定）が類似しており、抽象化可能です。

## 修正コード提案

### 1. `threatScore` の平坦化 (Line 227)

```python
        # Before:
        # "threatScore": 5 if severity == "medium" else (10 if severity == "high" else 2),

        # After:
        if severity == "high":
            threat_score = 10
        elif severity == "medium":
            threat_score = 5
        else:
            threat_score = 2

        alert = {
            # ...
            "threatScore": threat_score,
        }
```

### 2. `hgk_search` の構造化・フラット化 (Line 414-)

```python
    # After (Suggested Structure):

    def _search_ki(query: str) -> list[str]:
        # ... logic extracted ...
        return results

    def _search_doxa(query: str) -> list[str]:
        # ... logic extracted ...
        return results

    # Main logic flattened
    if mode in ("hybrid", "keyword"):
        # 1. KI
        results.extend(_search_ki(query))

        # 2. Doxa
        results.extend(_search_doxa(query))

        # 3. Handoff
        results.extend(_search_handoff(query))
```

## 重大度
Medium
