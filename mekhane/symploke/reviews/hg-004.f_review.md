# CCL式美学者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **call_tool (search)**: ネスト深度が最大レベル8に到達しており、基準値3を大幅に超過しています。特に `kairos` 検索ブロック内の日付フィルタリング処理が深すぎます。(Medium)
- **call_tool (search)**: SophiaとKairosの検索ロジックがインラインで記述されており、関数が肥大化しています。ヘルパー関数への抽出（分割）を推奨します。(Medium)
- **call_tool (search)**: `try...except` ブロック内の `pass` に TODO コメントがありますが、例外を握りつぶしており意図が不明瞭です。(Low)
- **call_tool (search)**: 結果の整形処理もループ内での条件分岐を含んでおり、可読性を低下させています。(Low)

## 重大度
Medium

## 修正案
`call_tool` 関数内の検索ロジックを以下のように分割することを提案します：

```python
async def _search_sophia(query: str, limit: int) -> list:
    # Sophia検索ロジック
    ...

async def _search_kairos(query: str, limit: int, recent_days: int = None) -> list:
    # Kairos検索ロジック（日付フィルタリング含む）
    ...

async def call_tool(name: str, arguments: dict):
    if name == "search":
        # ...
        results = []
        if source in ("sophia", "both"):
            results.extend(await _search_sophia(query, limit))
        if source in ("kairos", "both"):
            results.extend(await _search_kairos(query, limit, recent_days))
        # ...
```
