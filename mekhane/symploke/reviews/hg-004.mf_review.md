# CCL式美学者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- (Medium) CCL式が60ポイント超過: `call_tool` 関数が「神関数（God Function）」化しており、4つの異なるツール（search, stats, backlinks, graph_stats）のロジックを単一の関数内で条件分岐によって処理しているため、認知的複雑度が著しく高い（推定60ポイント以上）。
- (Medium) ネストが3レベル超過: `call_tool` 内の `search` ロジック、特に Kairos 検索結果の日付フィルタリング処理において、ネスト深さが最大8レベルに達しており、可読性を損なっている。
- (Low) 冗長なCCL式: 各ツール処理ブロック内で `StdoutSuppressor` コンテキストマネージャの使用とモジュールの遅延インポート、および `try-except` によるエラーハンドリングが繰り返されている。これらは共通化またはデコレータ化が可能である。
- (Low) 演算子の意図が不明: Kairos 検索の日付パース部分（`ts.split("T")[0]` など）にコメントがなく、データ形式の前提や意図が直感的に理解しにくい。

## 修正コード提案
`call_tool` 関数を各ツールごとのハンドラ関数に分割し、共通処理（標準出力抑制、インポート、エラーハンドリング）をデコレータやヘルパー関数として切り出すことで、各関数の責務を明確化し、CCLスコアを45ポイント以下に抑制することを提案します。

```python
# 修正案のイメージ（疑似コード）

def with_suppressed_stdout(func):
    """Decorator to suppress stdout during function execution."""
    async def wrapper(*args, **kwargs):
        with StdoutSuppressor():
            return await func(*args, **kwargs)
    return wrapper

class ToolHandlers:
    @staticmethod
    async def search(arguments: dict):
        # ... search logic (split into sub-helpers for Sophia/Kairos) ...
        pass

    @staticmethod
    async def stats(arguments: dict):
        # ... stats logic ...
        pass

    @staticmethod
    async def backlinks(arguments: dict):
        # ... backlinks logic ...
        pass

    @staticmethod
    async def graph_stats(arguments: dict):
        # ... graph_stats logic ...
        pass

# Main dispatch
async def call_tool(name: str, arguments: dict):
    """Handle tool calls."""
    log(f"call_tool: {name} with {arguments}")

    handler_map = {
        "search": ToolHandlers.search,
        "stats": ToolHandlers.stats,
        "backlinks": ToolHandlers.backlinks,
        "graph_stats": ToolHandlers.graph_stats,
    }

    handler = handler_map.get(name)
    if handler:
        try:
            return await handler(arguments)
        except Exception as e:
            log(f"Error in {name}: {e}")
            return [TextContent(type="text", text=f"Error: {str(e)}")]

    return [TextContent(type="text", text=f"Unknown tool: {name}")]
```

## 重大度
Medium
