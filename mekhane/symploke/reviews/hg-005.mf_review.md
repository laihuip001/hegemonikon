# 定理整合性監査官 レビュー

## 対象ファイル
`mekhane/ochema/proto.py`

## 判定
発言（要改善）

## 発見事項
- **定理参照の欠如** (Medium):
    - ファイル冒頭に PROOF ヘッダー (`# PROOF: P2 (Hodos) ...`) が存在しない。
    - 各関数 (`build_start_cascade`, `extract_planner_response` 等) の docstring に定理参照タグ (`[P2]`) が存在しない。
- **定理体系からの逸脱** (Medium):
    - `mekhane/ochema/` は **Theorem P2 (Hodos)** に対応するが、コード内に明示的な紐付けがない。

## 修正案

```python
<<<<<<< SEARCH
# PURPOSE: Antigravity LS の ConnectRPC proto 定義を一元管理する
# REASON: scripts/ (実験) と ochema/ (正式) が同じ v8 proto 知識を共有し、
#         Creator が proto を更新するとき 1 箇所だけ変えれば済むようにする
"""Antigravity Language Server — Proto Definitions (v8).
=======
# PROOF: P2 (Hodos) mekhane/ochema/proto.py
# PURPOSE: Antigravity LS の ConnectRPC proto 定義を一元管理する
# REASON: scripts/ (実験) と ochema/ (正式) が同じ v8 proto 知識を共有し、
#         Creator が proto を更新するとき 1 箇所だけ変えれば済むようにする
"""Antigravity Language Server — Proto Definitions (v8).
>>>>>>> REPLACE
<<<<<<< SEARCH
def build_start_cascade() -> dict:
    """StartCascade ペイロードを構築する。

    v8: metadata + trajectoryType:17 が必須。
    これがないと trajectory が生成されない。
    """
=======
def build_start_cascade() -> dict:
    """[P2] StartCascade ペイロードを構築する。

    v8: metadata + trajectoryType:17 が必須。
    これがないと trajectory が生成されない。
    """
>>>>>>> REPLACE
<<<<<<< SEARCH
def build_send_message(cascade_id: str, text: str, model: str) -> dict:
    """SendUserCascadeMessage ペイロードを構築する。

    v8 実証済み curl 構造に準拠:
    - items: トップレベルに直接配置
    - plannerTypeConfig: {conversational: {}}
    - requestedModel: {model: "MODEL_..."} (proto enum 形式)
    """
=======
def build_send_message(cascade_id: str, text: str, model: str) -> dict:
    """[P2] SendUserCascadeMessage ペイロードを構築する。

    v8 実証済み curl 構造に準拠:
    - items: トップレベルに直接配置
    - plannerTypeConfig: {conversational: {}}
    - requestedModel: {model: "MODEL_..."} (proto enum 形式)
    """
>>>>>>> REPLACE
<<<<<<< SEARCH
def build_get_status() -> dict:
    """GetUserStatus ペイロードを構築する。"""
=======
def build_get_status() -> dict:
    """[P2] GetUserStatus ペイロードを構築する。"""
>>>>>>> REPLACE
<<<<<<< SEARCH
def build_get_steps(cascade_id: str, trajectory_id: str) -> dict:
    """GetCascadeTrajectorySteps ペイロードを構築する。"""
=======
def build_get_steps(cascade_id: str, trajectory_id: str) -> dict:
    """[P2] GetCascadeTrajectorySteps ペイロードを構築する。"""
>>>>>>> REPLACE
<<<<<<< SEARCH
def extract_planner_response(step: dict) -> dict:
    """PLANNER_RESPONSE ステップからテキスト・thinking・model を抽出する。

    v8: generatorModel は step.metadata に格納 (fallback: plannerResponse)

    Returns:
        {text, thinking, model, token_usage, status}
    """
=======
def extract_planner_response(step: dict) -> dict:
    """[P2] PLANNER_RESPONSE ステップからテキスト・thinking・model を抽出する。

    v8: generatorModel は step.metadata に格納 (fallback: plannerResponse)

    Returns:
        {text, thinking, model, token_usage, status}
    """
>>>>>>> REPLACE
<<<<<<< SEARCH
def resolve_model(name: str) -> str:
    """モデルエイリアスを proto enum に解決する。"""
=======
def resolve_model(name: str) -> str:
    """[P2] モデルエイリアスを proto enum に解決する。"""
>>>>>>> REPLACE
```

## 重大度
Medium
