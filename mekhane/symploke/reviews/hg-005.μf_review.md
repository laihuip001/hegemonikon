# 定理整合性監査官 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **定理逸脱 (Medium):** `PROOF` ブロックで `[L2/インフラ]` が使用されていますが、L2は O/H/A/S/P/K 体系に存在しません。`[P3/記憶]` (Anamnesis) に修正すべきです。
- **定理逸脱 (Medium):** `main` 関数で `[L2-auto]` が使用されていますが、これも無効です。
- **定理参照欠如 (Medium):** ほとんどの関数 (`parse_sessions_from_json`, `sessions_to_records`, `parse_handoff_md`, `handoffs_to_records`, `index_handoffs`, `fetch_all_conversations`, `conversations_to_records`, `index_conversations`, `parse_step_outputs`, `steps_to_records`, `index_steps`, `parse_export_md`, `exports_to_records`, `index_exports`, `index_from_json`, `index_from_api`) に定理参照 (`PROOF: [P3/...]`) が欠如しています。

## 修正提案 (Diff)

```python
<<<<<<< SEARCH
# PURPOSE: セッション履歴を GnosisIndex (LanceDB) にインデックスする
"""
PROOF: [L2/インフラ] <- mekhane/anamnesis/

P3 → 記憶の永続化が必要
   → セッション履歴のセマンティック検索が必要
   → session_indexer.py が担う
=======
# PURPOSE: セッション履歴を GnosisIndex (LanceDB) にインデックスする
"""
PROOF: [P3/記憶] <- mekhane/anamnesis/

P3 → 記憶の永続化が必要
   → セッション履歴のセマンティック検索が必要
   → session_indexer.py が担う
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: LS API の trajectorySummaries JSON からセッション情報を構造化 dict に抽出する
def parse_sessions_from_json(data: dict) -> list[dict]:
    """PURPOSE: LS API の trajectorySummaries JSON からセッション情報を構造化 dict に抽出する"""
=======
# PURPOSE: [P3] LS API の trajectorySummaries JSON からセッション情報を構造化 dict に抽出する
def parse_sessions_from_json(data: dict) -> list[dict]:
    """PURPOSE: [P3] LS API の trajectorySummaries JSON からセッション情報を構造化 dict に抽出する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: セッション情報を LanceDB レコード (既存スキーマ準拠) に変換する
def sessions_to_records(sessions: list[dict]) -> list[dict]:
    """PURPOSE: セッション情報を LanceDB レコード (既存スキーマ準拠) に変換する
=======
# PURPOSE: [P3] セッション情報を LanceDB レコード (既存スキーマ準拠) に変換する
def sessions_to_records(sessions: list[dict]) -> list[dict]:
    """PURPOSE: [P3] セッション情報を LanceDB レコード (既存スキーマ準拠) に変換する
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: Handoff マークダウンファイルをパースし構造化 dict に変換する
def parse_handoff_md(path: Path) -> dict:
    """PURPOSE: Handoff マークダウンファイルをパースし構造化 dict に変換する"""
=======
# PURPOSE: [P3] Handoff マークダウンファイルをパースし構造化 dict に変換する
def parse_handoff_md(path: Path) -> dict:
    """PURPOSE: [P3] Handoff マークダウンファイルをパースし構造化 dict に変換する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: パース済み Handoff dict を LanceDB 互換レコードに変換する
def handoffs_to_records(handoffs: list[dict]) -> list[dict]:
    """PURPOSE: パース済み Handoff dict を LanceDB 互換レコードに変換する"""
=======
# PURPOSE: [P3] パース済み Handoff dict を LanceDB 互換レコードに変換する
def handoffs_to_records(handoffs: list[dict]) -> list[dict]:
    """PURPOSE: [P3] パース済み Handoff dict を LanceDB 互換レコードに変換する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: handoff_*.md ファイル群を LanceDB にセマンティックインデックスする
def index_handoffs(handoff_dir: Optional[str] = None) -> int:
    """PURPOSE: handoff_*.md ファイル群を LanceDB にセマンティックインデックスする"""
=======
# PURPOSE: [P3] handoff_*.md ファイル群を LanceDB にセマンティックインデックスする
def index_handoffs(handoff_dir: Optional[str] = None) -> int:
    """PURPOSE: [P3] handoff_*.md ファイル群を LanceDB にセマンティックインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: AntigravityClient 経由で LS API から全セッション会話データを取得する
def fetch_all_conversations(max_sessions: int = 100) -> list[dict]:
    """PURPOSE: AntigravityClient 経由で LS API から全セッション会話データを取得する"""
=======
# PURPOSE: [P3] AntigravityClient 経由で LS API から全セッション会話データを取得する
def fetch_all_conversations(max_sessions: int = 100) -> list[dict]:
    """PURPOSE: [P3] AntigravityClient 経由で LS API から全セッション会話データを取得する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: 会話データを LanceDB セマンティック検索用レコードに変換する
def conversations_to_records(conversations: list[dict]) -> list[dict]:
    """PURPOSE: 会話データを LanceDB セマンティック検索用レコードに変換する"""
=======
# PURPOSE: [P3] 会話データを LanceDB セマンティック検索用レコードに変換する
def conversations_to_records(conversations: list[dict]) -> list[dict]:
    """PURPOSE: [P3] 会話データを LanceDB セマンティック検索用レコードに変換する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: 全セッション会話を取得し LanceDB にセマンティックインデックスする
def index_conversations(max_sessions: int = 100) -> int:
    """PURPOSE: 全セッション会話を取得し LanceDB にセマンティックインデックスする"""
=======
# PURPOSE: [P3] 全セッション会話を取得し LanceDB にセマンティックインデックスする
def index_conversations(max_sessions: int = 100) -> int:
    """PURPOSE: [P3] 全セッション会話を取得し LanceDB にセマンティックインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: .system_generated/steps/ 配下の output.txt をパースしレコード化する
def parse_step_outputs(brain_dir: Optional[str] = None, max_per_session: int = 20) -> list[dict]:
    """PURPOSE: .system_generated/steps/ 配下の output.txt をパースしレコード化する"""
=======
# PURPOSE: [P3] .system_generated/steps/ 配下の output.txt をパースしレコード化する
def parse_step_outputs(brain_dir: Optional[str] = None, max_per_session: int = 20) -> list[dict]:
    """PURPOSE: [P3] .system_generated/steps/ 配下の output.txt をパースしレコード化する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: ステップ出力データを LanceDB 互換レコードに変換する
def steps_to_records(steps: list[dict]) -> list[dict]:
    """PURPOSE: ステップ出力データを LanceDB 互換レコードに変換する"""
=======
# PURPOSE: [P3] ステップ出力データを LanceDB 互換レコードに変換する
def steps_to_records(steps: list[dict]) -> list[dict]:
    """PURPOSE: [P3] ステップ出力データを LanceDB 互換レコードに変換する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: .system_generated/steps/ の出力ファイルを LanceDB にインデックスする
def index_steps(brain_dir: Optional[str] = None, max_per_session: int = 20) -> int:
    """PURPOSE: .system_generated/steps/ の出力ファイルを LanceDB にインデックスする"""
=======
# PURPOSE: [P3] .system_generated/steps/ の出力ファイルを LanceDB にインデックスする
def index_steps(brain_dir: Optional[str] = None, max_per_session: int = 20) -> int:
    """PURPOSE: [P3] .system_generated/steps/ の出力ファイルを LanceDB にインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: export_chats.py 出力の MD ファイルを構造化 dict にパースする
def parse_export_md(path: Path) -> dict:
    """PURPOSE: export_chats.py 出力の MD ファイルを構造化 dict にパースする"""
=======
# PURPOSE: [P3] export_chats.py 出力の MD ファイルを構造化 dict にパースする
def parse_export_md(path: Path) -> dict:
    """PURPOSE: [P3] export_chats.py 出力の MD ファイルを構造化 dict にパースする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: パース済みエクスポート dict を LanceDB 互換レコードに変換する
def exports_to_records(exports: list[dict]) -> list[dict]:
    """PURPOSE: パース済みエクスポート dict を LanceDB 互換レコードに変換する"""
=======
# PURPOSE: [P3] パース済みエクスポート dict を LanceDB 互換レコードに変換する
def exports_to_records(exports: list[dict]) -> list[dict]:
    """PURPOSE: [P3] パース済みエクスポート dict を LanceDB 互換レコードに変換する"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: export_chats.py 出力 MD を LanceDB にセマンティックインデックスする
def index_exports(export_dir: Optional[str] = None) -> int:
    """PURPOSE: export_chats.py 出力 MD を LanceDB にセマンティックインデックスする"""
=======
# PURPOSE: [P3] export_chats.py 出力 MD を LanceDB にセマンティックインデックスする
def index_exports(export_dir: Optional[str] = None) -> int:
    """PURPOSE: [P3] export_chats.py 出力 MD を LanceDB にセマンティックインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: trajectorySummaries JSON からセッション情報を LanceDB にインデックスする
def index_from_json(json_path: str) -> int:
    """PURPOSE: trajectorySummaries JSON からセッション情報を LanceDB にインデックスする"""
=======
# PURPOSE: [P3] trajectorySummaries JSON からセッション情報を LanceDB にインデックスする
def index_from_json(json_path: str) -> int:
    """PURPOSE: [P3] trajectorySummaries JSON からセッション情報を LanceDB にインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: LS API から直接セッション情報を取得し LanceDB にインデックスする
def index_from_api() -> int:
    """PURPOSE: LS API から直接セッション情報を取得し LanceDB にインデックスする"""
=======
# PURPOSE: [P3] LS API から直接セッション情報を取得し LanceDB にインデックスする
def index_from_api() -> int:
    """PURPOSE: [P3] LS API から直接セッション情報を取得し LanceDB にインデックスする"""
>>>>>>> REPLACE
<<<<<<< SEARCH
# PURPOSE: [L2-auto] 関数: main
def main() -> int:  # PURPOSE: CLI エントリポイント — サブコマンド (sessions/handoffs/conversations/steps/exports) をディスパッチする
=======
# PURPOSE: [P3] 関数: main
def main() -> int:  # PURPOSE: [P3] CLI エントリポイント — サブコマンド (sessions/handoffs/conversations/steps/exports) をディスパッチする
>>>>>>> REPLACE
```

## 重大度
Medium
