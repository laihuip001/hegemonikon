# LLM臭気検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **コピペ変異体 (Medium)**: `index_handoffs`, `index_conversations`, `index_steps`, `index_exports`, `index_from_json` の5つの関数が、インデックス処理のロジック（初期化、重複排除、バッチ埋め込み、LanceDBへの追加）において90%以上重複しています。バッチサイズやスキーマフィルタリングの実装に微妙な差異があり、メンテナンス性を著しく損なっています。
- **明白なことを説明する docstring (Low)**: 各関数の `PURPOSE:` 行が、関数名を見れば分かる内容を日本語で繰り返しているだけで、インサイトを提供していません（例: `index_handoffs` -> "handoff_*.md ファイル群を LanceDB にセマンティックインデックスする"）。
- **関数内のスタイル不統一 (Low)**: 埋め込み時のバッチサイズが関数によって `16`, `32`, `None` (一括) とバラバラであり、根拠が不明確です。また、`index_from_json` だけスキーマフィルタリングの実装が他と異なっています。

## 修正案
共通のインデックス処理を行う汎用関数（例: `_index_records(records: list[dict], source: str, batch_size: int = 32) -> int`）を作成し、各 `index_*` 関数から呼び出す形にリファクタリングすることを提案します。これにより、重複排除ロジックやバッチ処理、スキーマフィルタリングを一元管理でき、保守性が向上します。

## 重大度
Medium
