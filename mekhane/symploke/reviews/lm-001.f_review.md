# LLM臭気検出者 レビュー

## 対象ファイル
`mekhane/mcp/sophia_mcp_server.py`

## 判定
発言（要改善）

## 発見事項
- **明白な説明 (Obvious Docstrings)**:
    - `list_tools`: `"""List available tools."""` と `# PURPOSE: [L2-auto] List available tools.` が重複しており、自明。
    - `call_tool`: `"""Handle tool calls."""` と `# PURPOSE: [L2-auto] Handle tool calls.` が重複。
    - `# PURPOSE` タグが過剰に使用されており、関数名や直前のコードで自明な内容を繰り返している（例: `log` 関数の `PURPOSE: log — MCPサービスの処理`）。
- **コピペ変異体 (Copy-Paste Variants)**:
    - `stats` ツール内の Sophia と Kairos の統計取得ロジックがほぼ同一構造で繰り返されている。共通化が可能。
    - `search` ツール内の検索ロジックも類似構造が見られる。
- **スタイル不統一 (Inconsistent Styles)**:
    - インポートがファイル冒頭と関数内部（`call_tool`, `stats`, `backlinks` 等）に分散している。特に `EmbeddingAdapter` や `SophiaBacklinker` のインポートが繰り返されている。
    - `datetime` のインポートがループ内で定義されている箇所がある。
- **Happy Path 偏重 / 弱いエラーハンドリング**:
    - `search` ツール内の日付パース処理で `except Exception: pass` が使用されており、エラーを握りつぶしている。
    - トップレベルの `try-except` が広範な `Exception` を捕捉しており、具体的なエラー対応が不足している。
- **教科書的パターン (Textbook Patterns)**:
    - `StdoutSuppressor` クラスの使用は、インポート時の副作用を抑制するための対症療法的なアプローチに見える。

## 重大度
Medium

## 修正案 (Proposed Correction)

以下の改善を提案します：
1. **インポートの整理**: 全てのインポートをファイル冒頭に移動し、遅延インポートが必要な場合でも関数内での重複を避ける。
2. **共通ロジックの抽出**: `stats` や `search` におけるインデックスアクセスの共通部分をヘルパー関数に切り出す。
3. **ドキュメンテーションの簡素化**: 自明な `docstring` や冗長な `# PURPOSE` コメントを削除・統合する。
4. **エラーハンドリングの強化**: `pass` を避け、適切なログ出力やエラーレスポンスを返すようにする。

```python
# 改善例 (抜粋)

# インポートは冒頭にまとめる
from mekhane.symploke.adapters.embedding_adapter import EmbeddingAdapter
from mekhane.symploke.sophia_backlinker import SophiaBacklinker
from datetime import datetime, timedelta

# 共通関数の作成
def get_index_count(index_path):
    if index_path.exists():
        adapter = EmbeddingAdapter()
        adapter.load(str(index_path))
        return adapter.count()
    return 0

# ...

    elif name == "stats":
        log("Getting stats...")
        try:
            # 共通関数を利用してスッキリ記述
            sophia_count = get_index_count(SOPHIA_INDEX)
            kairos_count = get_index_count(KAIROS_INDEX)

            output_lines = ["# Sophia/Kairos Statistics\n"]
            output_lines.append(f"- **Sophia (Knowledge Items)**: {sophia_count} documents")
            output_lines.append(f"- **Kairos (Handoffs)**: {kairos_count} documents")
            output_lines.append(f"- **Total**: {sophia_count + kairos_count} documents")

            return [TextContent(type="text", text="\n".join(output_lines))]
        except Exception as e:
            log(f"Stats error: {e}")
            return [TextContent(type="text", text=f"Error getting stats: {str(e)}")]
```
