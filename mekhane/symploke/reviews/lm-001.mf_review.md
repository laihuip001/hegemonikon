# LLM臭気検出者 レビュー

## 対象ファイル
`mekhane/anamnesis/session_indexer.py`

## 判定
発言（要改善）

## 発見事項
- **コピペ変異体 (Medium)**: `index_handoffs`, `index_conversations`, `index_steps`, `index_exports`, `index_from_json` の5つの関数において、以下のロジックがほぼ完全に重複しています。
    - 既存レコードとの重複排除 (Deduplication)
    - LanceDBへのデータ追加 (一部スキーマフィルタリングの有無に差異あり)
    - 埋め込みベクトルの生成ループ (バッチ処理)
    これらは共通関数（例: `_process_and_index_records(index, records, batch_size=32) -> int`）に切り出し、DRY原則を適用すべきです。

- **ロジックの不統一 (Low)**: `index_from_json` のみ、LanceDB 追加時のスキーマフィールドフィルタリング (`filtered_data = ...`) が欠落しています。他の関数と同様に実装しないと、将来的なスキーマ変更時に不整合エラーのリスクがあります。

- **スタイル不統一 (Low)**: `index_handoffs` は一括で Embed していますが、他はバッチ処理（サイズ16または32）しています。データ量が増えた際に `index_handoffs` がメモリ圧迫する可能性があります。統一的なバッチ処理を適用すべきです。

## 重大度
Medium
