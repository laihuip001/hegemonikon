# CCL Program: LMQL Translator

> **Origin**: `/zet+_/sop+_/noe!_/s+` セッション
> **Date**: 2026-01-31
> **Target**: `[CCL]/mek+`

---

## 1. 目的

```ccl
/bou+[desir]:
    "CCL 式を LMQL プログラムに変換し、実行保証を達成する"
```

---

## 2. アーキテクチャ

```ccl
/s+[arch]:
    CCL_Human >> Expander >> Parser >> AST >> LMQL_Template >> LLM_Execution
    
    層構成:
        [最適化] DSPy Teleprompter
        [制御]   LMQL / Guidance
        [実行]   LangGraph
        [検証]   Constrained Decoding + Multi-Agent Debate
```

---

## 3. コンポーネント

### 3.1 パーサー

```ccl
/s+[parser]:
    入力: CCL式 (e.g., "/noe+ >> V[] < 0.3")
    処理: 正規表現マッチ >> AST構築
    出力: Workflow | Sequence | ConvergenceLoop
    
    対応演算子:
        単項: + - ^ / ? \ ' !
        二項: * ~ _ >>
    
    制約:
        ~: len(WORKFLOW_ID) > 0 { 有効なワークフロー }
```

### 3.2 AST

```ccl
/s+[ast]:
    @dataclass Workflow:
        id: str
        operators: List[OpType]
        modifiers: Dict
        selector: Optional[str]
    
    @dataclass Condition:
        var: str    # V[], E[]
        op: str     # <, >, =
        value: float
    
    @dataclass ConvergenceLoop:
        body: Workflow
        condition: Condition
    
    @dataclass Sequence:
        steps: List[Workflow]
```

### 3.3 翻訳器

```ccl
/s+[translator]:
    入力: AST
    処理: テンプレート展開 >> LMQL構文生成
    出力: LMQL プログラム文字列
    
    変換規則:
        Workflow     >> @lmql.query + プロンプト + 制約
        Sequence     >> 逐次実行テンプレート
        ConvergenceLoop >> while ループ + V[] 評価
```

---

## 4. 使用例

### 4.1 深い認識

```ccl
入力: /noe+
出力:
    @lmql.query
    def ccl_noe(context):
        argmax
            "深い認識: 詳細に、3つ以上の視点で"
            "[RESULT]"
        where len(RESULT) > 100
```

### 4.2 収束ループ

```ccl
入力: /noe+ >> V[] < 0.3
出力:
    @lmql.query
    def convergence_loop(context):
        argmax
            while V > 0.3:
                "/noe 実行"
                "[STEP_RESULT]"
                "V[] 評価: [V_ESTIMATE]"
                where V_ESTIMATE in ["0.1"..."0.9"]
```

---

## 5. 実装ファイル

```ccl
/ene[impl]:
    ファイル: mekhane/ccl/lmql_translator.py
    
    クラス:
        CCLParser       # 構文解析
        LMQLTranslator  # LMQL生成
    
    関数:
        ccl_to_lmql(ccl_expr) -> str
    
    テスト:
        .venv/bin/python mekhane/ccl/lmql_translator.py
```

---

## 6. 次のステップ

```ccl
/hod+[next]:
    Phase 2: LMQL ランタイム統合
        pip install lmql >> 実行環境構築
    
    Phase 3: Constrained Decoding
        vLLM + xgrammar >> JSON 100% 準拠
    
    Phase 4: LangGraph
        状態永続化 >> チェックポイント
```

---

## CCL Signature

```ccl
/mek+[signature]:
    lmql_translator = /s+[parser]_/s+[ast]_/s+[translator]_/ene[impl]
    
    実行保証 = CCL >> LMQL >> Constrained_Decoding >> Validation
    
    信頼度目標: V[] < 0.04 (96%+)
```

---

*Generated by [CCL]/mek+ (2026-01-31)*
