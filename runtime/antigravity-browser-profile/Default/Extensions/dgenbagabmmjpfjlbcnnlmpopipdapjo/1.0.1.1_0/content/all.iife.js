var X=Object.defineProperty;var z=(h,u,m)=>u in h?X(h,u,{enumerable:!0,configurable:!0,writable:!0,value:m}):h[u]=m;var c=(h,u,m)=>z(h,typeof u!="symbol"?u+"":u,m);(function(){"use strict";class h{constructor(){c(this,"overlay",null);c(this,"selection",null);c(this,"toolbar",null);c(this,"coordsBadge",null);c(this,"startX",0);c(this,"startY",0);c(this,"endX",0);c(this,"endY",0);c(this,"selecting",!1);c(this,"saveCompleted",!1);c(this,"currentTheme","light")}init(){this.overlay||(this.saveCompleted=!1,this.injectStyles(),this.createOverlay(),this.bind(),document.body.style.userSelect="none",document.body.style.overflow="hidden")}destroy(){if(this.selecting=!1,this.saveCompleted=!0,this.unbind(),this.overlay)try{document.body.contains(this.overlay)&&document.body.removeChild(this.overlay)}catch{}this.overlay=null,this.selection=null,this.toolbar=null,this.coordsBadge=null,this.selecting=!1,this.saveCompleted=!1;try{document.body.style.userSelect="",document.body.style.overflow=""}catch{}try{const e=document.getElementById("notebooklm-snip-styles");e&&e.parentNode&&e.parentNode.removeChild(e)}catch{}}injectStyles(){if(document.getElementById("notebooklm-snip-styles"))return;const e=document.createElement("style");e.id="notebooklm-snip-styles",e.textContent=`
      .nlm-snip-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);cursor:crosshair;z-index:999999;pointer-events:auto}
      .nlm-snip-rect{position:absolute;border:2px solid #1a73e8;background:rgba(26,115,232,.12);box-shadow:0 0 0 9999px rgba(0,0,0,.35);pointer-events:none}
      .nlm-snip-toolbar{position:absolute;display:flex;flex-direction:column;background:#fff;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.18);padding:12px;z-index:1000001;min-width:250px;pointer-events:auto}
      .nlm-snip-btn{border:none;border-radius:8px;padding:8px 12px;font:600 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;color:#202124;cursor:pointer;transition:.15s;pointer-events:auto}
      .nlm-snip-btn-primary{background:#1a73e8;color:#fff}
      .nlm-snip-btn-primary:hover:not(:disabled){filter:brightness(.95)}
      .nlm-snip-btn-primary:disabled{opacity:0.6;cursor:not-allowed}
      .nlm-snip-btn-secondary{background:#f1f3f4}
      .nlm-snip-btn-secondary:hover{filter:brightness(.97)}
      .nlm-snip-badge{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.75);color:#fff;padding:6px 10px;border-radius:8px;font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas;pointer-events:none}
      input[type="text"] {pointer-events:auto;outline:none;border:1px solid #dadce0;border-radius:4px;padding:6px 8px;font-size:13px;min-width:200px;background:#fff;color:#202124}
      input[type="text"]:focus {border-color:#1a73e8;box-shadow:0 0 0 2px rgba(26,115,232,.2)}
      .nlm-snip-label{font-size:12px;color:#5f6368;font-weight:500}
      
      /* Dark theme support - using class-based approach */
      .nlm-snip-toolbar.dark-theme{background:#1f2937;border:1px solid #374151}
      .nlm-snip-toolbar.dark-theme .nlm-snip-btn{color:#f9fafb}
      .nlm-snip-toolbar.dark-theme .nlm-snip-btn-secondary{background:#374151;color:#f9fafb}
      .nlm-snip-toolbar.dark-theme .nlm-snip-btn-secondary:hover{background:#4b5563}
      .nlm-snip-toolbar.dark-theme input[type="text"] {background:#374151;color:#f9fafb;border-color:#4b5563}
      .nlm-snip-toolbar.dark-theme input[type="text"]:focus {border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.2)}
      .nlm-snip-toolbar.dark-theme .nlm-snip-label{color:#9ca3af}
      
      /* Fallback for system preference */
      @media (prefers-color-scheme: dark) {
        .nlm-snip-toolbar:not(.light-theme){background:#1f2937;border:1px solid #374151}
        .nlm-snip-toolbar:not(.light-theme) .nlm-snip-btn{color:#f9fafb}
        .nlm-snip-toolbar:not(.light-theme) .nlm-snip-btn-secondary{background:#374151;color:#f9fafb}
        .nlm-snip-toolbar:not(.light-theme) .nlm-snip-btn-secondary:hover{background:#4b5563}
        .nlm-snip-toolbar:not(.light-theme) input[type="text"] {background:#374151;color:#f9fafb;border-color:#4b5563}
        .nlm-snip-toolbar:not(.light-theme) input[type="text"]:focus {border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.2)}
        .nlm-snip-toolbar:not(.light-theme) .nlm-snip-label{color:#9ca3af}
      }
    `,document.head.appendChild(e)}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="nlm-snip-overlay",this.overlay.tabIndex=-1,this.overlay.style.outline="none",this.coordsBadge=document.createElement("div"),this.coordsBadge.className="nlm-snip-badge",this.coordsBadge.textContent="Drag to select. ESC to cancel",this.overlay.appendChild(this.coordsBadge),document.body.appendChild(this.overlay),setTimeout(()=>{this.overlay&&this.overlay.focus()},10)}bind(){var e;this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onKeyDown=this.onKeyDown.bind(this),(e=this.overlay)==null||e.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("keydown",this.onKeyDown)}unbind(){var e;(e=this.overlay)==null||e.removeEventListener("mousedown",this.onMouseDown),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("keydown",this.onKeyDown)}onMouseDown(e){var n;this.toolbar&&(e.target===this.toolbar||this.toolbar.contains(e.target))||(e.preventDefault(),this.selecting=!0,this.startX=e.clientX,this.startY=e.clientY,this.selection&&this.selection.remove(),this.toolbar&&this.toolbar.remove(),this.selection=document.createElement("div"),this.selection.className="nlm-snip-rect",(n=this.overlay)==null||n.appendChild(this.selection))}onMouseMove(e){if(!this.selecting||!this.selection)return;this.endX=e.clientX,this.endY=e.clientY;const n=Math.min(this.startX,this.endX),o=Math.min(this.startY,this.endY),s=Math.abs(this.endX-this.startX),r=Math.abs(this.endY-this.startY);Object.assign(this.selection.style,{left:n+"px",top:o+"px",width:s+"px",height:r+"px"}),this.coordsBadge&&(this.coordsBadge.textContent=`${s}×${r}px (${n}, ${o}) — ESC to cancel`)}onMouseUp(){var n;if(!this.selecting)return;this.selecting=!1;const e=this.getRect();if(e.width<8||e.height<8){(n=this.selection)==null||n.remove(),this.selection=null;return}this.showToolbar()}onKeyDown(e){e.key==="Escape"&&(e.preventDefault(),e.stopPropagation(),this.cancel())}getRect(){const e=Math.min(this.startX,this.endX),n=Math.min(this.startY,this.endY),o=Math.abs(this.endX-this.startX),s=Math.abs(this.endY-this.startY);return{left:e,top:n,width:o,height:s}}setTheme(e){this.currentTheme=e,this.applyThemeToToolbar()}applyThemeToToolbar(){this.toolbar&&(this.toolbar.classList.remove("dark-theme","light-theme"),this.currentTheme==="dark"?this.toolbar.classList.add("dark-theme"):this.toolbar.classList.add("light-theme"))}showToolbar(){if(!this.overlay||!this.selection)return;this.toolbar=document.createElement("div"),this.toolbar.className="nlm-snip-toolbar",this.applyThemeToToolbar();const e=document.createElement("div");e.style.cssText="display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px;";const n=document.createElement("label");n.textContent="Filename:",n.className="nlm-snip-label";const o=document.createElement("input");o.type="text",o.placeholder="Enter PDF filename...",o.value=`Screenshot_${new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")}`,o.style.cssText="pointer-events: auto; cursor: text;",o.id="nlm-filename-input",o.addEventListener("keydown",a=>{a.stopPropagation(),a.key==="Enter"?(a.preventDefault(),this.save()):a.key==="Escape"&&(a.preventDefault(),this.cancel())}),o.addEventListener("click",a=>{a.stopPropagation()}),o.addEventListener("focus",a=>{a.stopPropagation()}),e.appendChild(n),e.appendChild(o);const s=document.createElement("div");s.style.cssText="display: flex; gap: 8px;";const r=document.createElement("button");r.className="nlm-snip-btn nlm-snip-btn-primary",r.textContent="Save",r.id="nlm-save-btn";const l=document.createElement("button");l.className="nlm-snip-btn nlm-snip-btn-secondary",l.textContent="Cancel",r.onclick=a=>{a.stopPropagation(),this.save()},l.onclick=a=>{a.stopPropagation(),this.cancel()},s.appendChild(r),s.appendChild(l),this.toolbar.addEventListener("click",a=>{a.stopPropagation()}),this.toolbar.appendChild(e),this.toolbar.appendChild(s);const d=this.selection.getBoundingClientRect();Object.assign(this.toolbar.style,{left:d.left+"px",top:d.bottom+8+"px"}),this.overlay.appendChild(this.toolbar),setTimeout(()=>o.focus(),100)}save(){var S;const e=window.devicePixelRatio||1,{left:n,top:o,width:s,height:r}=this.getRect(),l=document.getElementById("nlm-filename-input");let d=((S=l==null?void 0:l.value)==null?void 0:S.trim())||`Screenshot_${new Date().toISOString().slice(0,19).replace(/[:.]/g,"-")}`;d.toLowerCase().endsWith(".pdf")||(d+=".pdf");const a=document.getElementById("nlm-save-btn");a&&(a.disabled=!0,a.textContent="Capturing...",a.style.opacity="0.6"),this.overlay&&(this.overlay.style.display="none"),chrome.runtime.sendMessage({action:"captureScreenshotArea",source:"content-script",selection:{left:n,top:o,width:s,height:r,devicePixelRatio:e},filename:d,timestamp:new Date().toISOString()},b=>{this.overlay&&(this.overlay.style.display="block"),chrome.runtime.lastError?this.handleSaveComplete(!1,chrome.runtime.lastError.message||"Runtime error"):b&&b.success?this.handleSaveComplete(!0,"Screenshot captured successfully"):this.handleSaveComplete(!1,(b==null?void 0:b.error)||"Screenshot processing failed")}),setTimeout(()=>{!this.saveCompleted&&this.overlay&&this.handleSaveComplete(!1,"Operation timeout")},3e4)}handleSaveComplete(e,n){this.saveCompleted=!0,this.coordsBadge&&(this.coordsBadge.textContent=e?`✓ ${n}`:`✗ ${n}`,this.coordsBadge.style.backgroundColor=e?"rgba(40, 167, 69, 0.9)":"rgba(220, 53, 69, 0.9)"),e?this.destroy():setTimeout(()=>{this.destroy()},2e3)}cancel(){this.selecting=!1,this.saveCompleted=!0,this.destroy();try{chrome.runtime.sendMessage({action:"screenshotCaptureCancelled",source:"content-script",timestamp:new Date().toISOString()},e=>{chrome.runtime.lastError})}catch{}}cancelFromSidepanel(){this.cancel()}testConnection(){try{chrome.runtime.sendMessage({action:"ping",source:"content-script"},e=>{chrome.runtime.lastError})}catch{}}}function u(t){const e=[/(?:v=|\/v\/|\/embed\/|\/watch\?v=|\/shorts\/)([^&?/]+)/,/youtu\.be\/([^&?/]+)/];for(const n of e){const o=t.match(n);if(o&&o[1])return o[1]}return null}function m(t){if(!(t.includes("youtube.com")||t.includes("youtu.be")))return{url:t,normalizedUrl:t,isYouTube:!1,isYouTubePlaylist:!1,videoId:null};try{const n=u(t),o=M(t);let s=t;return n&&(s=`https://www.youtube.com/watch?v=${n}`),{url:t,normalizedUrl:s,isYouTube:!0,isYouTubePlaylist:o,videoId:n}}catch{return{url:t,normalizedUrl:t,isYouTube:!0,isYouTubePlaylist:!1,videoId:null}}}function y(t){try{const e=m(t);return e.isYouTube&&e.videoId?`https://www.youtube.com/watch?v=${e.videoId}`:t}catch{return t}}function v(t,e){var o,s,r,l;if(!m(t.href).isYouTube)return e;const n=((s=(o=t.querySelector("#video-title"))==null?void 0:o.textContent)==null?void 0:s.trim())||((l=(r=t.querySelector(".ytd-video-meta-block #video-title"))==null?void 0:r.textContent)==null?void 0:l.trim())||t.getAttribute("title");return n&&n!==e?n:e}function M(t){try{return new URL(t).pathname==="/playlist"}catch{return!1}}const i={isLinkPickingActive:!1,selectedLinks:new Map,successfullyAddedLinks:new Set,failedToAddLinks:new Set,youtubeObserver:null,screenshotCapture:null};function T(){window.location.protocol==="chrome:"||window.location.protocol==="edge:"||window.location.protocol==="chrome-extension:"||window.location.href.includes("chrome.google.com/webstore")||window.location.href.includes("chromewebstore.google.com")||window.location.href.includes("addons.mozilla.org")||(P(),O(),document.addEventListener("keydown",N),I(),window.location.hostname==="notebooklm.google.com"&&C())}function P(){if(document.getElementById("notebooklm-styles"))return;const t=document.createElement("style");t.id="notebooklm-styles",t.textContent=`
    .notebooklm-link-selectable {
      cursor: pointer !important;
      position: relative;
      z-index: 10000;
      transition: background-color 0.2s ease;
    }
    
    .notebooklm-link-selectable:hover {
      background-color: rgba(255, 0, 0, 0.1) !important;
      outline: 1px solid rgba(255, 0, 0, 0.5) !important;
    }
    
    .notebooklm-link-selected {
      background-color: rgba(0, 123, 255, 0.2) !important;
      outline: 2px solid rgba(0, 123, 255, 0.5) !important;
    }
    
    .notebooklm-link-success {
      background-color: rgba(40, 167, 69, 0.2) !important;
      outline: 2px solid rgba(40, 167, 69, 0.8) !important;
    }
    
    .notebooklm-link-failed {
      background-color: rgba(220, 53, 69, 0.2) !important;
      outline: 2px solid rgba(220, 53, 69, 0.8) !important;
    }
    
    body.chrome-ext-highlight-mode {
      cursor: crosshair !important;
    }
  `,document.head.appendChild(t)}function w(){const t=Array.from(document.querySelectorAll("a[href]")),e=[];return t.forEach(n=>{var l;const o=n.getAttribute("href");if(!o||o.trim()===""||o.startsWith("#")||o.startsWith("javascript:")||o.startsWith("mailto:")||o.startsWith("tel:"))return;let s=o;try{s=new URL(o,window.location.href).href}catch{s=o}s=y(s);let r=((l=n.textContent)==null?void 0:l.trim())||n.title||n.getAttribute("aria-label")||s;r=v(n,r),r.length>60&&(r=r.substring(0,57)+"..."),e.push({element:n,url:s,title:r})}),e}function g(){const t=window.location.href;return t.startsWith("chrome://")||t.startsWith("edge://")||t.startsWith("chrome-extension://")||t.includes("chrome.google.com/webstore")||t.includes("chromewebstore.google.com")||t.includes("addons.mozilla.org")}function x(){if(i.isLinkPickingActive||g())return;i.isLinkPickingActive=!0,L(),w().forEach((e,n)=>{const o=e.element;o.onclick&&(o.setAttribute("data-original-click","true"),o.onclick=null),o.classList.add("notebooklm-link-selectable"),o.dataset.notebooklmIndex=n.toString(),o.addEventListener("click",p,!0),o.addEventListener("auxclick",f,!0)}),document.body.classList.add("chrome-ext-highlight-mode"),E()&&U(),k(),chrome.runtime.sendMessage({action:"linkPickingModeEnabled",source:"content"})}function A(){i.isLinkPickingActive&&(i.isLinkPickingActive=!1,B(),document.querySelectorAll(".notebooklm-link-selectable, .notebooklm-link-selected").forEach(t=>{t.classList.remove("notebooklm-link-selectable"),t.classList.remove("notebooklm-link-selected"),t.getAttribute("data-original-click")==="true"&&t.removeAttribute("data-original-click"),t.removeEventListener("click",p,!0),t.removeEventListener("auxclick",f,!0)}),document.body.classList.remove("chrome-ext-highlight-mode"),chrome.runtime.sendMessage({action:"linkPickingModeDisabled",source:"content"}),chrome.runtime.sendMessage({action:"clearSelectedLinks",source:"content"}))}function k(){chrome.runtime.sendMessage({action:"getSelectedLinksForPage",source:"content",data:{pageUrl:window.location.href}},t=>{t&&t.links&&t.links.forEach(e=>{i.selectedLinks.set(e.url,e),Y(e.url)})})}function Y(t){document.querySelectorAll("a[href]").forEach(n=>{const o=n;try{o.href===t&&o.classList.add("notebooklm-link-selected")}catch{}})}function D(t,e){document.querySelectorAll("a[href]").forEach(o=>{const s=o;try{const r=t.includes(s.href),l=e.includes(s.href);r?(s.classList.remove("notebooklm-link-selected","notebooklm-link-failed"),s.classList.add("notebooklm-link-success")):l&&(s.classList.remove("notebooklm-link-selected","notebooklm-link-success"),s.classList.add("notebooklm-link-failed"))}catch{}})}function L(){document.querySelectorAll(".notebooklm-link-success, .notebooklm-link-failed").forEach(e=>{e.classList.remove("notebooklm-link-success","notebooklm-link-failed")})}function I(){g()||chrome.runtime.sendMessage({action:"getLinkPickingState",source:"content"},t=>{t&&t.isActive&&x()})}function O(){chrome.runtime.onMessage.addListener(async(t,e,n)=>{switch(t.action){case"enableLinkPickingMode":g()?n({status:"blocked",reason:"system_page"}):(x(),n({status:"ok"}));break;case"disableLinkPickingMode":A(),n({status:"ok"});break;case"clearSelectedLinks":i.selectedLinks.clear(),document.querySelectorAll(".notebooklm-link-selected").forEach(o=>{o.classList.remove("notebooklm-link-selected")}),n({status:"ok"});break;case"highlightLinksWithStatus":t.data&&D(t.data.successUrls||[],t.data.failedUrls||[]),n({status:"ok"});break;case"clearLinkHighlights":L(),n({status:"ok"});break;case"loadSelectedLinksForPage":k(),n({status:"ok"});break;case"getAccountInfo":window.location.hostname==="notebooklm.google.com"&&C().then(()=>{n({success:!0})}).catch(o=>{n({success:!1,error:o instanceof Error?o.message:"Failed to get account info"})});break;case"startScreenshotCapture":try{i.screenshotCapture&&i.screenshotCapture.destroy(),i.screenshotCapture=new h,t.theme&&i.screenshotCapture.setTheme(t.theme),i.screenshotCapture.init(),n({success:!0})}catch(o){n({success:!1,error:o instanceof Error?o.message:"Failed to start screenshot capture"})}break;case"resetScreenshotCapture":try{i.screenshotCapture&&(i.screenshotCapture.destroy(),i.screenshotCapture=null),n({success:!0})}catch(o){n({success:!1,error:o instanceof Error?o.message:"Failed to reset screenshot capture"})}break;case"screenshotCaptureCancelled":try{i.screenshotCapture&&(i.screenshotCapture.cancelFromSidepanel(),i.screenshotCapture=null),n({success:!0})}catch(o){n({success:!1,error:o instanceof Error?o.message:"Failed to handle cancellation"})}break;case"ping":n({success:!0,message:"pong"});break;default:n({status:"unknown-action"})}return!0})}function E(){return window.location.hostname.includes("youtube.com")}function U(){!E()||i.youtubeObserver||(i.youtubeObserver=new MutationObserver(t=>{if(!i.isLinkPickingActive)return;let e=!1;t.forEach(n=>{if(n.type==="childList"&&n.addedNodes.length>0){const o=Array.from(n.addedNodes).filter(s=>s.nodeType===Node.ELEMENT_NODE);for(const s of o)if(s.tagName==="A"||s.querySelector("a[href]")){e=!0;break}}}),e&&setTimeout(()=>{F()},100)}),i.youtubeObserver.observe(document.body,{childList:!0,subtree:!0}))}function B(){i.youtubeObserver&&(i.youtubeObserver.disconnect(),i.youtubeObserver=null)}function F(){if(!i.isLinkPickingActive)return;document.querySelectorAll(".notebooklm-link-selectable").forEach(e=>{e.removeEventListener("click",p,!0),e.removeEventListener("auxclick",f,!0)}),w().forEach((e,n)=>{const o=e.element;o.onclick&&(o.setAttribute("data-original-click","true"),o.onclick=null),o.classList.add("notebooklm-link-selectable"),o.dataset.notebooklmIndex=n.toString(),o.addEventListener("click",p,!0),o.addEventListener("auxclick",f,!0)}),k()}async function C(){try{const e=await(await fetch("https://accounts.google.com/ListAccounts?authuser=0&listPages=1&fwput=10&rdr=2&pid=666&gpsia=1&source=ogb&atic=1&mo=1&mn=1&hl=en&ts=1097",{method:"POST",credentials:"include",headers:{accept:"*/*","content-type":"application/x-www-form-urlencoded;charset=utf-8"}})).text();return chrome.runtime.sendMessage({type:"accountData",data:e,success:!0}),e}catch(t){return chrome.runtime.sendMessage({type:"accountData",success:!1,error:t instanceof Error?t.message:"Failed to get account data"}),null}}const p=t=>{var d;if(!i.isLinkPickingActive)return;const e=t;e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation();const n=e.currentTarget,o=y(n.href);let s=((d=n.textContent)==null?void 0:d.trim())||n.title||n.getAttribute("aria-label")||o;s=v(n,s);const l={id:`link_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,url:o,title:s};return n.classList.contains("notebooklm-link-selected")?(n.classList.remove("notebooklm-link-selected"),i.selectedLinks.delete(o),chrome.runtime.sendMessage({action:"removeLinkFromSelection",source:"content",data:{pageUrl:window.location.href,linkUrl:o}})):(n.classList.add("notebooklm-link-selected"),i.selectedLinks.set(o,l),chrome.runtime.sendMessage({action:"addLinkToSelection",source:"content",data:{pageUrl:window.location.href,link:l}})),!1},f=t=>i.isLinkPickingActive?(t.preventDefault(),t.stopPropagation(),!1):!0,N=t=>{t.key==="Escape"&&i.isLinkPickingActive&&chrome.runtime.sendMessage({action:"disableLinkPickingMode",source:"content"}),t.key==="Escape"&&i.screenshotCapture&&chrome.runtime.sendMessage({action:"resetScreenshotCapture",source:"content"})};T()})();
