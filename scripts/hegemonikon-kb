#!/usr/bin/env bash
# PURPOSE: Query HGK knowledge base via Gateway HTTP API
# Usage: hegemonikon-kb <command> [args]
#
# Commands:
#   search <query>        Search across all knowledge indices
#   status                Get system health status
#   paper <query>         Search academic papers
#   ccl <expression>      Parse CCL expression
#
# Environment:
#   HGK_GATEWAY_URL       Gateway base URL (default: http://127.0.0.1:8765)
#   HGK_GATEWAY_TOKEN     Bearer token for authentication
#
# This CLI is designed to be used by Jules within its VM environment.
# Add to AGENTS.md so Jules knows how to use it.

set -euo pipefail

# Configuration
GATEWAY_URL="${HGK_GATEWAY_URL:-http://127.0.0.1:8765}"
TOKEN="${HGK_GATEWAY_TOKEN:-}"
TIMEOUT="${HGK_TIMEOUT:-30}"

# Colors (disabled in non-interactive)
if [ -t 1 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' NC=''
fi

# Helper: Make authenticated HTTP request to Gateway
_request() {
    local endpoint="$1"
    shift
    local url="${GATEWAY_URL}${endpoint}"
    
    local auth_header=""
    if [ -n "$TOKEN" ]; then
        auth_header="Authorization: Bearer ${TOKEN}"
    fi
    
    if [ -n "$auth_header" ]; then
        curl -s --max-time "$TIMEOUT" \
            -H "Content-Type: application/json" \
            -H "$auth_header" \
            "$@" "$url"
    else
        curl -s --max-time "$TIMEOUT" \
            -H "Content-Type: application/json" \
            "$@" "$url"
    fi
}

# Helper: Call MCP tool via Gateway's streamable-http endpoint
_call_tool() {
    local tool_name="$1"
    local arguments="$2"
    
    local payload
    payload=$(cat <<EOF
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
        "name": "${tool_name}",
        "arguments": ${arguments}
    }
}
EOF
)
    
    _request "/mcp" -X POST -d "$payload"
}

# Command: search
cmd_search() {
    local query="${1:?Usage: hegemonikon-kb search <query>}"
    local limit="${2:-10}"
    
    echo -e "${GREEN}üîç Searching HGK knowledge base...${NC}"
    echo "   Query: $query"
    echo "   Limit: $limit"
    echo ""
    
    _call_tool "hgk_pks_search" "{\"query\": \"${query}\", \"limit\": ${limit}}"
    echo ""
}

# Command: status
cmd_status() {
    echo -e "${GREEN}üìä HGK System Status${NC}"
    echo ""
    _call_tool "hgk_health" "{}"
    echo ""
}

# Command: paper
cmd_paper() {
    local query="${1:?Usage: hegemonikon-kb paper <query>}"
    local limit="${2:-5}"
    
    echo -e "${GREEN}üìñ Searching papers...${NC}"
    echo "   Query: $query"
    echo ""
    
    _call_tool "hgk_paper_search" "{\"query\": \"${query}\", \"limit\": ${limit}}"
    echo ""
}

# Command: ccl
cmd_ccl() {
    local expr="${1:?Usage: hegemonikon-kb ccl <expression>}"
    
    echo -e "${GREEN}‚ö° Parsing CCL expression...${NC}"
    echo "   CCL: $expr"
    echo ""
    
    _call_tool "hgk_ccl_dispatch" "{\"ccl\": \"${expr}\"}"
    echo ""
}

# Command: help
cmd_help() {
    echo "hegemonikon-kb ‚Äî HGK Knowledge Base CLI"
    echo ""
    echo "Usage: hegemonikon-kb <command> [args]"
    echo ""
    echo "Commands:"
    echo "  search <query> [limit]   Search across all knowledge indices (34K+ docs)"
    echo "  status                   Get system health status"
    echo "  paper <query> [limit]    Search academic papers"
    echo "  ccl <expression>         Parse CCL expression"
    echo "  help                     Show this help"
    echo ""
    echo "Environment:"
    echo "  HGK_GATEWAY_URL          Gateway URL (default: http://127.0.0.1:8765)"
    echo "  HGK_GATEWAY_TOKEN        Bearer token for authentication"
    echo ""
    echo "Examples:"
    echo "  hegemonikon-kb search 'free energy principle'"
    echo "  hegemonikon-kb paper 'attention mechanism transformers'"
    echo "  hegemonikon-kb ccl '/noe+_/dia'"
    echo "  hegemonikon-kb status"
}

# Main dispatcher
main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true
    
    case "$cmd" in
        search)  cmd_search "$@" ;;
        status)  cmd_status "$@" ;;
        paper)   cmd_paper "$@" ;;
        ccl)     cmd_ccl "$@" ;;
        help|-h|--help) cmd_help ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}" >&2
            echo "Run 'hegemonikon-kb help' for usage." >&2
            exit 1
            ;;
    esac
}

main "$@"
