#!/usr/bin/env python3
"""
Forge ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® activation_triggers ã‚’ç²¾ç·»åŒ–
PURPOSE: "general" ã®ã¾ã¾ã® triggers ã‚’å…·ä½“çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆ
"""

import os
import re
import yaml

FORGE_BASE = os.path.expanduser(
    "~/Sync/10_ğŸ“š_ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï½œLibrary/prompts/templates/forge"
)

# Forge ãƒ•ã‚¡ã‚¤ãƒ«å â†’ å…·ä½“çš„ãª triggers ãƒãƒƒãƒ”ãƒ³ã‚°
FORGE_TRIGGERS = {
    # 01_find
    "è„³å†…ã‚’åãå‡ºã™": ["åãå‡ºã™", "ãƒ–ãƒ¬ã‚¤ãƒ³ãƒ€ãƒ³ãƒ—", "æ•´ç†", "é ­ã®ä¸­", "dump", "zet"],
    "æƒ…å ±ã‚’é›†ã‚ã‚‹": ["æƒ…å ±", "åé›†", "ãƒªã‚µãƒ¼ãƒ", "èª¿ã¹ã‚‹", "gather", "sop"],
    "å£°ã‚’èã": ["èã", "å‚¾è´", "ãƒ’ã‚¢ãƒªãƒ³ã‚°", "æ„è¦‹", "listen"],
    "é ­ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹": ["åˆ‡ã‚Šæ›¿ãˆ", "ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥", "è¡Œãè©°ã¾ã‚Š", "switch"],
    "å…¨ä½“ã‚’çœºã‚ã‚‹": ["å…¨ä½“", "ä¿¯ç°", "ãƒãƒƒãƒ—", "é³¥ã®ç›®", "overview", "pan"],

    # 02_think_expand
    "çŠ¶æ³ã‚’æŠŠæ¡ã™ã‚‹": ["çŠ¶æ³", "ç¾çŠ¶", "æŠŠæ¡", "åˆ†æ", "what_is", "kho"],
    "å•é¡Œã‚’ç‰¹å®šã™ã‚‹": ["å•é¡Œ", "èª²é¡Œ", "ç‰¹å®š", "å®šç¾©", "problem", "zet"],
    "é–¢ä¿‚è€…ã‚’æ•´ç†ã™ã‚‹": ["é–¢ä¿‚è€…", "ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼", "åˆ©å®³", "stakeholder", "kho"],
    "å‰æã‚’ç–‘ã†": ["å‰æ", "ä»®å®š", "ãƒã‚¤ã‚¢ã‚¹", "ç–‘ã†", "assumption", "noe"],
    "ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™": ["ã‚¢ã‚¤ãƒ‡ã‚¢", "ç™ºæƒ³", "ãƒ–ãƒ¬ã‚¹ãƒˆ", "å‰µé€ ", "ideate", "zet"],
    "ç‚¹ã‚’ã¤ãªã": ["ã¤ãªã", "çµåˆ", "é–¢é€£", "ãƒ‘ã‚¿ãƒ¼ãƒ³", "connect", "gno"],
    "é€†è»¢ã•ã›ã‚‹": ["é€†è»¢", "åè»¢", "é€†ã‹ã‚‰", "invert", "noe"],
    "æºã‚‰ãã‚’ä¸ãˆã‚‹": ["ãƒ©ãƒ³ãƒ€ãƒ ", "æºã‚‰ã", "å¶ç„¶", "åˆºæ¿€", "randomize", "zet"],
    "å‰æã‚’ç ´å£Šã™ã‚‹": ["ç ´å£Š", "ã‚¼ãƒ­ãƒ™ãƒ¼ã‚¹", "éé€£ç¶š", "disrupt", "noe"],

    # 03_think_focus
    "é¸æŠè‚¢ã‚’æ¯”è¼ƒã™ã‚‹": ["æ¯”è¼ƒ", "é¸æŠ", "ã©ã£ã¡", "compare", "dia"],
    "æ±ºæ–­ã‚’ä¸‹ã™": ["æ±ºæ–­", "æ±ºã‚ã‚‹", "æ±ºå®š", "decide", "dia"],
    "è¨ˆç”»ã‚’ç«‹ã¦ã‚‹": ["è¨ˆç”»", "ãƒ—ãƒ©ãƒ³", "æ®µå–ã‚Š", "plan", "hod"],
    "ãƒªã‚¹ã‚¯ã‚’è¦‹ç©ã‚‚ã‚‹": ["ãƒªã‚¹ã‚¯", "å±é™º", "è¦‹ç©ã‚‚ã‚Š", "risk", "pre"],
    "å„ªå…ˆé †ä½ã‚’ã¤ã‘ã‚‹": ["å„ªå…ˆ", "é †ä½", "é‡è¦åº¦", "prioritize", "met"],
    "ã‚„ã‚ã‚‹æ±ºæ–­ã‚’ã™ã‚‹": ["ã‚„ã‚ã‚‹", "ä¸­æ­¢", "æ’¤é€€", "quit", "dia"],
    "æœªæ¥ã‚’åˆ†å²ã•ã›ã‚‹": ["æœªæ¥", "ã‚·ãƒŠãƒªã‚ª", "åˆ†å²", "scenario", "euk"],
    "ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’çªã": ["ãƒœãƒˆãƒ«ãƒãƒƒã‚¯", "åˆ¶ç´„", "TOC", "constraint", "met"],
    "æœ¬è³ªã ã‘æ®‹ã™": ["æœ¬è³ª", "å‰Šãè½ã¨ã™", "ã‚·ãƒ³ãƒ—ãƒ«", "essential", "met"],
    "ãƒ†ã‚³ã‚’è¦‹ã¤ã‘ã‚‹": ["ãƒ†ã‚³", "ãƒ¬ãƒãƒ¬ãƒƒã‚¸", "æœ€å°åŠªåŠ›", "leverage", "met"],
    "æ‚ªé­”ã®ä»£å¼ã‚’ã™ã‚‹": ["åè«–", "æ‰¹åˆ¤", "devil", "ä»£å¼", "dia"],

    # 04_act_prepare
    "åƒãã‹ã‘ã‚‹": ["è¡Œå‹•", "å®Ÿè¡Œ", "å‹•ã", "act", "pra"],
    "æ–­ã‚‹": ["æ–­ã‚‹", "NO", "æ‹’å¦", "say_no", "pra"],
    "äº¤æ¸‰ã™ã‚‹": ["äº¤æ¸‰", "ãƒã‚´", "åˆæ„", "negotiate", "pra"],
    "æ¼”ã˜ã‚‹": ["ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤", "æ¼”ã˜ã‚‹", "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³", "roleplay", "syn"],
    "ã‚¯ã‚¨ã‚¹ãƒˆåŒ–ã™ã‚‹": ["ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", "ã‚¯ã‚¨ã‚¹ãƒˆ", "å‹•æ©Ÿ", "gamify", "pra"],
    "ç’°å¢ƒã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹": ["ç’°å¢ƒ", "ä»•çµ„ã¿", "è‡ªå‹•åŒ–", "environment", "kho"],
    "ä»»ã›ã‚‹": ["å§”è¨—", "ãƒ‡ãƒ¬ã‚²ãƒ¼ã‚·ãƒ§ãƒ³", "ä»»ã›ã‚‹", "delegate", "pra"],

    # 05_act_create
    "æ–‡ç« ã‚’æ›¸ã": ["æ–‡ç« ", "æ›¸ã", "ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°", "write", "pra"],
    "ãƒ—ãƒ¬ã‚¼ãƒ³ã‚’ä½œã‚‹": ["ãƒ—ãƒ¬ã‚¼ãƒ³", "ç™ºè¡¨", "ã‚¹ãƒ©ã‚¤ãƒ‰", "present", "pra"],
    "ä»•çµ„ã¿åŒ–ã™ã‚‹": ["ä»•çµ„ã¿", "ã‚·ã‚¹ãƒ†ãƒ åŒ–", "è‡ªå‹•", "systemize", "mek"],
    "åå‰ã‚’ã¤ã‘ã‚‹": ["å‘½å", "åå‰", "ãƒãƒ¼ãƒŸãƒ³ã‚°", "name", "noe"],
    "æ‰‹é †ã‚’çµ„ã‚€": ["æ‰‹é †", "SOP", "ãƒãƒ‹ãƒ¥ã‚¢ãƒ«", "procedure", "mek"],
    "å›³è§£ã™ã‚‹": ["å›³è§£", "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«", "å›³", "visualize", "pra"],
    "ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’ä½œã‚‹": ["ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—", "è©¦ä½œ", "MVP", "prototype", "ene"],

    # 06_reflect
    "å“è³ªã‚’ç¢ºã‹ã‚ã‚‹": ["å“è³ª", "å“è³ªç¢ºèª", "ãƒã‚§ãƒƒã‚¯", "quality", "dia"],
    "æ”¹å–„æ¡ˆã‚’å‡ºã™": ["æ”¹å–„", "ã‚«ã‚¤ã‚¼ãƒ³", "ã‚ˆã‚Šè‰¯ã", "improve", "zet"],
    "çµŒé¨“ã‚’æŒ¯ã‚Šè¿”ã‚‹": ["æŒ¯ã‚Šè¿”ã‚Š", "ãƒ¬ãƒˆãƒ­ã‚¹ãƒšã‚¯ãƒ†ã‚£ãƒ–", "æ•™è¨“", "retrospect", "gno"],
    "è¨˜éŒ²ã™ã‚‹": ["è¨˜éŒ²", "ä¿å­˜", "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–", "archive", "dox"],
    "è³¢äººã«èã": ["è³¢äºº", "åŠ©è¨€", "ãƒ¡ãƒ³ã‚¿ãƒ¼", "counsel", "syn"],
}


def refine_triggers():
    updated = 0
    for root, dirs, files in os.walk(FORGE_BASE):
        for f in files:
            if not f.endswith('.md'):
                continue

            path = os.path.join(root, f)
            with open(path, 'r', encoding='utf-8') as fp:
                content = fp.read()

            if not content.startswith('---'):
                continue

            end = content.find('---', 3)
            if end == -1:
                continue

            yaml_str = content[3:end].strip()
            body = content[end + 3:]

            try:
                fm = yaml.safe_load(yaml_str)
            except yaml.YAMLError:
                continue

            if not isinstance(fm, dict):
                continue

            # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚­ãƒ¼ã‚’æ¨å®š
            name_clean = fm.get('name', '').replace('Forge: ', '')
            triggers = fm.get('activation_triggers', [])

            # "general" ã®ã¿ã®å ´åˆã€ã¾ãŸã¯æ”¹å–„å¯èƒ½ãªå ´åˆ
            if name_clean in FORGE_TRIGGERS:
                new_triggers = FORGE_TRIGGERS[name_clean]
                fm['activation_triggers'] = new_triggers

                yaml_out = yaml.dump(fm, allow_unicode=True, default_flow_style=False, sort_keys=False)
                new_content = f"---\n{yaml_out.strip()}\n---{body}"

                with open(path, 'w', encoding='utf-8') as fp:
                    fp.write(new_content)

                rel = os.path.relpath(path, FORGE_BASE)
                print(f"  âœ… {rel}: {name_clean} â†’ {new_triggers[:3]}...")
                updated += 1

    print(f"\nâœ… {updated} Forge ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« triggers ç²¾ç·»åŒ–å®Œäº†")


if __name__ == "__main__":
    refine_triggers()
